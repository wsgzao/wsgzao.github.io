
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    var host = "wsgzao.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LJ3PMGPVCK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LJ3PMGPVCK');
</script>
  
    <title>使用rpmbuild制作Nginx的RPM包 | HelloDog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wsgzao">
    

    
    <meta name="description" content="使用rpmbuild制作Nginx的RPM包">
<meta property="og:type" content="article">
<meta property="og:title" content="使用rpmbuild制作Nginx的RPM包">
<meta property="og:url" content="https://wsgzao.github.io/post/rpmbuild/index.html">
<meta property="og:site_name" content="HelloDog">
<meta property="og:description" content="使用rpmbuild制作Nginx的RPM包">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191104154723.png">
<meta property="article:published_time" content="2020-04-06T06:59:49.000Z">
<meta property="article:modified_time" content="2023-02-27T05:33:07.064Z">
<meta property="article:author" content="wsgzao">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191104154723.png">

    
    <link rel="alternative" href="/atom.xml" title="HelloDog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HelloDog" title="HelloDog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HelloDog">HelloDog</a></h1>
				<h2 class="blog-motto">Keep Calm and Carry On</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index/">索引 | Index</a></li>
					
						<li><a href="/archives/">归档 | Archives</a></li>
					
						<li><a href="/about/">简介 | About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/rpmbuild/" title="使用rpmbuild制作Nginx的RPM包" itemprop="url">使用rpmbuild制作Nginx的RPM包</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="wsgzao" target="_blank" itemprop="author">wsgzao</a>
		
  <p class="article-time">
    <time datetime="2020-04-06T06:59:49.000Z" itemprop="datePublished"> 发表于 2020-04-06</time>
    
  </p>
</header>
	<div class="article-content">
<!-- 		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%8E%86%E5%8F%B2"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRPM"><span class="toc-number">3.</span> <span class="toc-text">什么是RPM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E3%80%81%E9%87%8D%E6%96%B0%E7%94%9F%E6%88%90%E5%92%8C%E5%AE%89%E8%A3%85src-rpm%E6%BA%90%E7%A0%81%E5%8C%85"><span class="toc-number">4.</span> <span class="toc-text">修改、重新生成和安装src.rpm源码包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B6%E4%BD%9Crpm%E5%8C%85"><span class="toc-number">5.</span> <span class="toc-text">制作rpm包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#build-shell"><span class="toc-number">5.1.</span> <span class="toc-text">build shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-spec"><span class="toc-number">5.2.</span> <span class="toc-text">nginx-spec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-template"><span class="toc-number">5.3.</span> <span class="toc-text">nginx-template</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Initialize-rpmbuild-env"><span class="toc-number">6.</span> <span class="toc-text">Initialize rpmbuild env</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-build-Nginx-RPM"><span class="toc-number">7.</span> <span class="toc-text">How to build Nginx RPM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eopenresty%E5%88%B6%E4%BD%9Cnginx-rpm%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-number">8.</span> <span class="toc-text">基于openresty制作nginx rpm安装包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">8.1.</span> <span class="toc-text">环境初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E7%94%9F%E6%88%90nginx-rpm"><span class="toc-number">8.2.</span> <span class="toc-text">编译生成nginx rpm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">9.</span> <span class="toc-text">参考文章</span></a></li></ol>
		
		</div>
		 -->
		<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191104154723.png"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>题图为RPM包制作原理图，有时候为了方便源码包的安装，和我们自己订制软件包的需求，我们会把一些源码包按照我们的需求来做成 rpm 包，当有了源码包就可以直接编译得到二进制安装包和其他任意包。spec file 是制作 rpm 包最核心的部分，rpm 包的制作就是根据 spec file 来实现的。在制作自定义 rpm 包的时候最好不要使用管理员进行, 因为管理员权限过大，如果一个命令写错了，结果可能是灾难性的，而制件一个 rpm 包普通用户完全可以实现。本文主要介绍使用rpmbuild制作Nginx的RPM包，大部分步骤已经使用Bash Shell自动化完成了，大家可以基于此重新定义。</p>
<blockquote>
<p>使用rpmbuild制作Nginx的RPM包</p>
</blockquote>
<h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2020年04月06日 - 增加修改、重新生成和安装src.rpm源码包<br>2019年11月04日 - 更新openresty&#x2F;lua-nginx-module<br>2019年01月16日 - 初稿</p>
<p>阅读原文 - <a href="https://wsgzao.github.io/post/rpmbuild/">https://wsgzao.github.io/post/rpmbuild/</a></p>
<hr>
<h2 id="什么是RPM"><a href="#什么是RPM" class="headerlink" title="什么是RPM"></a>什么是RPM</h2><p>An RPM package is simply a file containing other files and information about them needed by the system. Specifically, an RPM package consists of the cpio archive, which contains the files, and the RPM header, which contains metadata about the package. The rpm package manager uses this metadata to determine dependencies, where to install files, and other information.</p>
<p>There are two types of RPM packages:</p>
<ul>
<li>source RPM (SRPM)</li>
<li>binary RPM</li>
</ul>
<p>SRPMs and binary RPMs share the file format and tooling, but have different contents and serve different purposes. An SRPM contains source code, optionally patches to it, and a SPEC file, which describes how to build the source code into a binary RPM. A binary RPM contains the binaries built from the sources and patches.</p>
<p>RPM 有五种基本的操作功能：安装、卸载、升级、查询和验证。</p>
<p>Linux 软件包分为两大类：</p>
<ol>
<li>二进制类包，包括 rpm 安装包（一般分为 i386 和 x86 等几种）</li>
<li>源码类包，源码包和开发包应该归位此类（.src.rpm）</li>
</ol>
<p>在 Redhat 下，rpm 包的默认制作路径在 &#x2F;usr&#x2F;src&#x2F;redhat 下，这其中包含了 6 个目录（要求全部大写）。但 Centos 并没有该目录，因此我们不得不自定义工作车间，即使在 Redhat 下有该目录，一般也是自定义到普通用户的家目录下的</p>
<table>
<thead>
<tr>
<th>Directory</th>
<th>Usage</th>
</tr>
</thead>
<tbody><tr>
<td>BUILD</td>
<td>源代码解压以后放的位置，只需提供BUILD目录，具体里面放什么，不用我们管，所以真正的制作车间是BUILD目录</td>
</tr>
<tr>
<td>RPMS</td>
<td>制作完成后的rpm包存放目录，为特定平台指定子目录（i386,i686,ppc）</td>
</tr>
<tr>
<td>SOURCES</td>
<td>收集的源文件，源材料，补丁文件等存放位置</td>
</tr>
<tr>
<td>SPECS</td>
<td>存放spec文件，作为制作rpm包的领岗文件，以 rpm名.spec</td>
</tr>
<tr>
<td>SRPMS</td>
<td>src格式的rpm包位置 ，既然是src格式的包，就没有平台的概念了</td>
</tr>
<tr>
<td>BuiltRoot</td>
<td>假根，使用install临时安装到这个目录，把这个目录当作根来用的，所以在这个目录下的目录文件，才是真正的目录文件。当打包完成后，在清理阶段，这个目录将被删除</td>
</tr>
</tbody></table>
<p>更详细的介绍可以参考 <code>RPM Packaging Guide</code></p>
<p><a target="_blank" rel="noopener" href="https://rpm-packaging-guide.github.io/">https://rpm-packaging-guide.github.io/</a></p>
<h2 id="修改、重新生成和安装src-rpm源码包"><a href="#修改、重新生成和安装src-rpm源码包" class="headerlink" title="修改、重新生成和安装src.rpm源码包"></a>修改、重新生成和安装src.rpm源码包</h2><p>RHEL&#x2F;CentOS&#x2F;Fedora&#x2F;Suse等Linux发行版都使用rpm包作为软件包格式。另外还有一个相关的格式srpm包（后缀是.src.rpm），它包含了源代码，可以用它重新生成rpm包。</p>
<p>以libip2location为真实案例做下回顾<br><a target="_blank" rel="noopener" href="https://centos.pkgs.org/7/remi-x86_64/libip2location-8.0.7-1.el7.remi.x86_64.rpm.html">https://centos.pkgs.org/7/remi-x86_64/libip2location-8.0.7-1.el7.remi.x86_64.rpm.html</a></p>
<p>我们找到libip2location源码包<br><a target="_blank" rel="noopener" href="https://rpms.remirepo.net/SRPMS/libip2location-8.0.7-1.remi.src.rpm">https://rpms.remirepo.net/SRPMS/libip2location-8.0.7-1.remi.src.rpm</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接安装*src.rpm源码包,有时，我们没有找到可用的rpm包，但找到了其对应的src.rpm源码包，此时我们可以安装这个src.rpm源码包。步骤与直接安装rpm包很不相同。</span></span><br><span class="line">wget https://rpms.remirepo.net/SRPMS/libip2location-8.0.7-1.remi.src.rpm</span><br><span class="line">rpm -i libip2location-8.0.7-1.remi.src.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时还没有安装完成。只是在~/rpmbuild/ 目录下准备了该src.rpm源码包的资源，可用于进一步生成rpm包。</span></span><br><span class="line"><span class="built_in">cd</span> ~/rpmbuild/SPECS</span><br><span class="line">rpmbuild -ba libip2location.spec</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以直接使用如下命令，这个命令一步即可在～/rpmbuild/RPMS/目录下重新生成rpm包。</span></span><br><span class="line">rpmbuild --rebuild libip2location-8.0.7-1.remi.src.rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>基于*src.rpm源码包修改代码后生成rpm包并安装, rpmbuild命令基于.spec文件和源码tar.gz及patch文件生成src.rpm和rpm包。</p>
<p>因此，我们只需要修改.spec文件，或者对应的源码和patch文件，然后再执行命令，就可以生成更新后的src.rpm包和rpm包。</p>
<p>rpm包在<del>&#x2F;rpmbuild&#x2F;RPMS目录下，src.rpm包在</del>&#x2F;rpmbuild&#x2F;SRPMS目录下。</p>
<p>注意要修改~&#x2F;rpmbuild&#x2F;SOURCES&#x2F;目录下的文件:</p>
<ol>
<li>你可以重新打包~&#x2F;rpmbuild&#x2F;SOURCES&#x2F;目录下的tar.gz源文件。</li>
<li>你可以修改.spec文件，增加或者减少对patch的应用。</li>
</ol>
<h2 id="制作rpm包"><a href="#制作rpm包" class="headerlink" title="制作rpm包"></a>制作rpm包</h2><blockquote>
<p>如果你只关心如何使用可以直接跳过看下文，这里主要展示代码和配置文件</p>
</blockquote>
<h3 id="build-shell"><a href="#build-shell" class="headerlink" title="build shell"></a>build shell</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># luajit.sh</span></span><br><span class="line">LUAVER=2.0.5</span><br><span class="line">WKDIR=<span class="string">&quot;/root/rpmbuild/SOURCES&quot;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget http://luajit.org/download/LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">tar zxf LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line"><span class="built_in">rm</span> LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> LuaJIT-<span class="variable">$LUAVER</span></span><br><span class="line">make BUILDMODE=static</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/local/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/local/include/luajit-2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># build.sh</span></span><br><span class="line">NGX_VER=1.14.2</span><br><span class="line">WKDIR=<span class="string">&quot;/root/rpmbuild/SOURCES&quot;</span></span><br><span class="line">CURRENTDIR=`<span class="built_in">dirname</span> $(<span class="built_in">readlink</span> -f <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CURRENTDIR</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/local/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/local/include/luajit-2.0</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget http://nginx.org/download/nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">tar xzf nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line"><span class="built_in">rm</span> nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line"><span class="built_in">mv</span> nginx-<span class="variable">$NGX_VER</span> nginx-garena-<span class="variable">$NGX_VER</span></span><br><span class="line"><span class="built_in">cd</span> nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p contrib</span><br><span class="line"><span class="built_in">cd</span> contrib/</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/bigplum/Nginx-limit-traffic-rate-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/agentzh/headers-more-nginx-module.git</span><br><span class="line"><span class="comment">#git clone git://github.com/gnosek/nginx-upstream-fair.git</span></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/agentzh/echo-nginx-module.git</span><br><span class="line"><span class="comment">#git clone git://github.com/arut/nginx-dav-ext-module.git</span></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/r10r/ngx_http_auth_pam_module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/FRiCKLE/ngx_cache_purge.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/simpl/ngx_devel_kit.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/openresty/lua-nginx-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/nbs-system/naxsi.git</span><br><span class="line"><span class="built_in">rm</span> -rf */.git</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -r <span class="variable">$CURRENTDIR</span>/nginx-template/* <span class="variable">$WKDIR</span>/nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$CURRENTDIR</span>/nginx-spec /root/rpmbuild/SPECS/</span><br><span class="line"><span class="comment">#cp /root/rules $WKDIR/nginx-garena-$NGX_VER/debian/</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">tar zcf nginx-garena-<span class="variable">$NGX_VER</span>.tar.gz nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/SPECS/</span><br><span class="line">rpmbuild -ba nginx-spec</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/RPMS/noarch</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="nginx-spec"><a href="#nginx-spec" class="headerlink" title="nginx-spec"></a>nginx-spec</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.The introduction section </span></span><br><span class="line">Name: nginx-garena                                      <span class="comment"># 软件包名称</span></span><br><span class="line">Version: 1.14.2                                         <span class="comment"># 版本号</span></span><br><span class="line">Release: 0                                              <span class="comment"># release号</span></span><br><span class="line">Summary: nginx garena rpm                               <span class="comment"># 简要描述信息</span></span><br><span class="line">Source0: nginx-garena-1.14.1.tar.gz                     <span class="comment"># source主要是引用一下自己定义好的脚本，配置文件之类的内容</span></span><br><span class="line">License: GPL                                            <span class="comment"># 一定带上（最好是对方源码包的License）BSD，GPL，GPLv2</span></span><br><span class="line">Group: Rahul                                            <span class="comment"># 要全用这里面的一个组：less /usr/share/doc/rpm-version/GROUPS</span></span><br><span class="line">BuildArch: noarch               </span><br><span class="line">BuildRoot: %&#123;_tmppath&#125;/%&#123;name&#125;-buildroot                </span><br><span class="line">%description                                            <span class="comment"># 软件包详述</span></span><br><span class="line">Garena self-build Nginx.</span><br><span class="line">%define _binaries_in_noarch_packages_terminate_build   0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.The Prep section 准备阶段,主要就是把源码包解压到build目录下，设置一下环境变量，并cd进去</span></span><br><span class="line">%prep</span><br><span class="line">%setup -q %&#123;name&#125;-%&#123;version&#125;                            <span class="comment"># 这个宏的作用静默模式解压并cd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.The Build Section 编译制作阶段，这一节主要用于编译源码</span></span><br><span class="line">%build</span><br><span class="line">CFLAGS=<span class="string">&quot;<span class="variable">$RPM_OPT_FLAGS</span>&quot;</span> ./configure --prefix=/usr/share/nginx/ \</span><br><span class="line">                    --sbin-path=/usr/sbin/nginx \</span><br><span class="line">                    --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">                    --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">                    --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">                    --pid-path=/var/run/nginx.pid \</span><br><span class="line">                    --lock-path=/var/lock/nginx.lock \</span><br><span class="line">                    --http-client-body-temp-path=/var/lib/nginx/body \</span><br><span class="line">                    --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span><br><span class="line">                    --http-proxy-temp-path=/var/lib/nginx/proxy \</span><br><span class="line">                    --http-scgi-temp-path=/var/lib/nginx/scgi \</span><br><span class="line">                    --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span><br><span class="line">                    --with-pcre-jit \</span><br><span class="line">                    --with-http_flv_module \</span><br><span class="line">                    --with-http_mp4_module \</span><br><span class="line">                    --with-file-aio \</span><br><span class="line">                    --with-http_v2_module \</span><br><span class="line">                    --with-stream \</span><br><span class="line">                    --with-stream_ssl_module \</span><br><span class="line">                    --with-http_auth_request_module \</span><br><span class="line">                    --with-http_slice_module \</span><br><span class="line">                    --with-threads \</span><br><span class="line">                    --with-http_gunzip_module \</span><br><span class="line">                    --with-http_random_index_module \</span><br><span class="line">                    --with-http_secure_link_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_ssl_module \</span><br><span class="line">                    --with-openssl=/usr/local/src/openssl-1.0.2p \</span><br><span class="line">                    --with-http_addition_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_gzip_static_module \</span><br><span class="line">                    --with-http_realip_module \</span><br><span class="line">                    --with-ipv6 \</span><br><span class="line">                    --without-mail_pop3_module \</span><br><span class="line">                    --without-mail_imap_module \</span><br><span class="line">                    --without-mail_smtp_module \</span><br><span class="line">                    --add-module=contrib/Nginx-limit-traffic-rate-module \</span><br><span class="line">                    --add-module=contrib/headers-more-nginx-module \</span><br><span class="line">                    --add-module=contrib/echo-nginx-module \</span><br><span class="line">                    --add-module=contrib/ngx_http_auth_pam_module \</span><br><span class="line">                    --add-module=contrib/ngx_cache_purge \</span><br><span class="line">                    --add-module=contrib/ngx_devel_kit \</span><br><span class="line">                    --add-module=contrib/lua-nginx-module \</span><br><span class="line">                    --add-module=contrib/naxsi/naxsi_src</span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.Install section  这一节主要用于完成实际安装软件必须执行的命令，可包含4种类型脚本</span></span><br><span class="line">%install</span><br><span class="line">[ <span class="string">&quot;<span class="variable">$RPM_BUILD_ROOT</span>&quot;</span> != <span class="string">&quot;/&quot;</span> ] &amp;&amp; <span class="built_in">rm</span> -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">make DESTDIR=<span class="variable">$RPM_BUILD_ROOT</span> install</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-enabled</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-available</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/var/log/nginx</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/var/lib/nginx</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-available/000_stub_status</span><br><span class="line">install -D -m 644 conf/django_fastcgi_params <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/django_fastcgi_params</span><br><span class="line">install -D -m 644 conf/naxsi_core.rules <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/naxsi_core.rules</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-enabled/000_stub_status</span><br><span class="line">install -D -m 644 logrotate.d/nginx <span class="variable">$RPM_BUILD_ROOT</span>/etc/logrotate.d/nginx</span><br><span class="line">install -D -m 644 nginx.service <span class="variable">$RPM_BUILD_ROOT</span>/usr/lib/systemd/system/nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.clean section 清理段，clean的主要作用就是删除BUILD</span></span><br><span class="line">%clean</span><br><span class="line">[ <span class="string">&quot;<span class="variable">$RPM_BUILD_ROOT</span>&quot;</span> != <span class="string">&quot;/&quot;</span> ] &amp;&amp; <span class="built_in">rm</span> -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">%post</span><br><span class="line">useradd -s /sbin/nologin -d /var/www www-data</span><br><span class="line"><span class="built_in">chown</span> -R www-data.www-data /var/log/nginx /var/lib/nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"><span class="built_in">echo</span> %&#123;name&#125;-%&#123;version&#125; is successfully installed.</span><br><span class="line">systemctl start nginx</span><br><span class="line"><span class="comment"># 6.file section 文件列表段，这个阶段是把前面已经编译好的内容要打包了</span></span><br><span class="line">%files</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line">%<span class="built_in">dir</span> /etc/nginx</span><br><span class="line">/etc/nginx/*</span><br><span class="line">%<span class="built_in">dir</span> /usr/src/debug/nginx-garena-1.14.1</span><br><span class="line">/usr/src/debug/nginx-garena-1.14.1/*</span><br><span class="line">/usr/sbin/nginx</span><br><span class="line">%<span class="built_in">dir</span> /usr/share/nginx</span><br><span class="line">/usr/share/nginx/*</span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/usr/lib/debug/*</span><br><span class="line">/usr/lib/debug/.build-id/*</span><br><span class="line">%<span class="built_in">dir</span> /var/log/nginx</span><br><span class="line">%<span class="built_in">dir</span> /var/lib/nginx</span><br><span class="line">%config(noreplace) /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="nginx-template"><a href="#nginx-template" class="headerlink" title="nginx-template"></a>nginx-template</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/conf/django_fastcgi_params</span></span><br><span class="line">fastcgi_param  QUERY_STRING       <span class="variable">$query_string</span>;</span><br><span class="line">fastcgi_param  REQUEST_METHOD     <span class="variable">$request_method</span>;</span><br><span class="line">fastcgi_param  CONTENT_TYPE       <span class="variable">$content_type</span>;</span><br><span class="line">fastcgi_param  CONTENT_LENGTH     <span class="variable">$content_length</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  PATH_INFO          <span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">fastcgi_param  REQUEST_URI        <span class="variable">$request_uri</span>;</span><br><span class="line">fastcgi_param  DOCUMENT_URI       <span class="variable">$document_uri</span>;</span><br><span class="line">fastcgi_param  DOCUMENT_ROOT      <span class="variable">$document_root</span>;</span><br><span class="line">fastcgi_param  SERVER_PROTOCOL    <span class="variable">$server_protocol</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;</span><br><span class="line">fastcgi_param  SERVER_SOFTWARE    nginx/<span class="variable">$nginx_version</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  REMOTE_ADDR        <span class="variable">$remote_addr</span>;</span><br><span class="line">fastcgi_param  REMOTE_PORT        <span class="variable">$remote_port</span>;</span><br><span class="line">fastcgi_param  SERVER_ADDR        <span class="variable">$server_addr</span>;</span><br><span class="line">fastcgi_param  SERVER_PORT        <span class="variable">$server_port</span>;</span><br><span class="line">fastcgi_param  SERVER_NAME        <span class="variable">$server_name</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  HTTP_X_FORWARDED_PROTOCOL        <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_pass_header Authorization;</span><br><span class="line">fastcgi_intercept_errors off;</span><br><span class="line">fastcgi_keep_conn on;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/conf/naxsi_core.rules</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">## INTERNAL RULES IDS:1-999     ##</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:weird request, unable to parse&quot; id:1;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:request too big, stored on disk and not parsed&quot; id:2;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:invalid hex encoding, null bytes&quot; id:10;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:unknown content-type&quot; id:11;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:invalid formatted url&quot; id:12;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:invalid POST format&quot; id:13;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:invalid POST boundary&quot; id:14;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:invalid JSON&quot; id:15;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:empty POST&quot; id:16;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:libinjection_sql&quot; id:17;</span></span><br><span class="line"><span class="comment">#@MainRule &quot;msg:libinjection_xss&quot; id:18;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">## SQL Injections IDs:1000-1099 ##</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line">MainRule <span class="string">&quot;rx:select|union|update|delete|insert|table|from|ascii|hex|unhex|drop&quot;</span> <span class="string">&quot;msg:sql keywords&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4&quot;</span> <span class="built_in">id</span>:1000;</span><br><span class="line">MainRule <span class="string">&quot;str:\&quot;&quot;</span> <span class="string">&quot;msg:double quote&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:8,<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1001;</span><br><span class="line">MainRule <span class="string">&quot;str:0x&quot;</span> <span class="string">&quot;msg:0x, possible hex encoding&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:2&quot;</span> <span class="built_in">id</span>:1002;</span><br><span class="line"><span class="comment">## Hardcore rules</span></span><br><span class="line">MainRule <span class="string">&quot;str:/*&quot;</span> <span class="string">&quot;msg:mysql comment (/*)&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:8&quot;</span> <span class="built_in">id</span>:1003;</span><br><span class="line">MainRule <span class="string">&quot;str:*/&quot;</span> <span class="string">&quot;msg:mysql comment (*/)&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:8&quot;</span> <span class="built_in">id</span>:1004;</span><br><span class="line">MainRule <span class="string">&quot;str:|&quot;</span> <span class="string">&quot;msg:mysql keyword (|)&quot;</span>  <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:8&quot;</span> <span class="built_in">id</span>:1005;</span><br><span class="line">MainRule <span class="string">&quot;str:&amp;&amp;&quot;</span> <span class="string">&quot;msg:mysql keyword (&amp;&amp;)&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:8&quot;</span> <span class="built_in">id</span>:1006;</span><br><span class="line"><span class="comment">## end of hardcore rules</span></span><br><span class="line">MainRule <span class="string">&quot;str:--&quot;</span> <span class="string">&quot;msg:mysql comment (--)&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4&quot;</span> <span class="built_in">id</span>:1007;</span><br><span class="line">MainRule <span class="string">&quot;str:;&quot;</span> <span class="string">&quot;msg:semicolon&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1008;</span><br><span class="line">MainRule <span class="string">&quot;str:=&quot;</span> <span class="string">&quot;msg:equal sign in var, probable sql/xss&quot;</span> <span class="string">&quot;mz:ARGS|BODY&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:2&quot;</span> <span class="built_in">id</span>:1009;</span><br><span class="line">MainRule <span class="string">&quot;str:(&quot;</span> <span class="string">&quot;msg:open parenthesis, probable sql/xss&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1010;</span><br><span class="line">MainRule <span class="string">&quot;str:)&quot;</span> <span class="string">&quot;msg:close parenthesis, probable sql/xss&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1011;</span><br><span class="line">MainRule <span class="string">&quot;str:&#x27;&quot;</span> <span class="string">&quot;msg:simple quote&quot;</span> <span class="string">&quot;mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1013;</span><br><span class="line">MainRule <span class="string">&quot;str:,&quot;</span> <span class="string">&quot;msg:comma&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4&quot;</span> <span class="built_in">id</span>:1015;</span><br><span class="line">MainRule <span class="string">&quot;str:#&quot;</span> <span class="string">&quot;msg:mysql comment (#)&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4&quot;</span> <span class="built_in">id</span>:1016;</span><br><span class="line">MainRule <span class="string">&quot;str:@@&quot;</span> <span class="string">&quot;msg:double arobase (@@)&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$SQL</span>:4&quot;</span> <span class="built_in">id</span>:1017;</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="comment">## OBVIOUS RFI IDs:1100-1199 ##</span></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line">MainRule <span class="string">&quot;str:http://&quot;</span> <span class="string">&quot;msg:http:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1100;</span><br><span class="line">MainRule <span class="string">&quot;str:https://&quot;</span> <span class="string">&quot;msg:https:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1101;</span><br><span class="line">MainRule <span class="string">&quot;str:ftp://&quot;</span> <span class="string">&quot;msg:ftp:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1102;</span><br><span class="line">MainRule <span class="string">&quot;str:php://&quot;</span> <span class="string">&quot;msg:php:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1103;</span><br><span class="line">MainRule <span class="string">&quot;str:sftp://&quot;</span> <span class="string">&quot;msg:sftp:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1104;</span><br><span class="line">MainRule <span class="string">&quot;str:zlib://&quot;</span> <span class="string">&quot;msg:zlib:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1105;</span><br><span class="line">MainRule <span class="string">&quot;str:data://&quot;</span> <span class="string">&quot;msg:data:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1106;</span><br><span class="line">MainRule <span class="string">&quot;str:glob://&quot;</span> <span class="string">&quot;msg:glob:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1107;</span><br><span class="line">MainRule <span class="string">&quot;str:phar://&quot;</span> <span class="string">&quot;msg:phar:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1108;</span><br><span class="line">MainRule <span class="string">&quot;str:file://&quot;</span> <span class="string">&quot;msg:file:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1109;</span><br><span class="line">MainRule <span class="string">&quot;str:gopher://&quot;</span> <span class="string">&quot;msg:gopher:// scheme&quot;</span> <span class="string">&quot;mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$RFI</span>:8&quot;</span> <span class="built_in">id</span>:1110;</span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line"><span class="comment">## Directory traversal IDs:1200-1299 ##</span></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line">MainRule <span class="string">&quot;str:..&quot;</span> <span class="string">&quot;msg:double dot&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$TRAVERSAL</span>:4&quot;</span> <span class="built_in">id</span>:1200;</span><br><span class="line">MainRule <span class="string">&quot;str:/etc/passwd&quot;</span> <span class="string">&quot;msg:obvious probe&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$TRAVERSAL</span>:4&quot;</span> <span class="built_in">id</span>:1202;</span><br><span class="line">MainRule <span class="string">&quot;str:c:\\&quot;</span> <span class="string">&quot;msg:obvious windows path&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$TRAVERSAL</span>:4&quot;</span> <span class="built_in">id</span>:1203;</span><br><span class="line">MainRule <span class="string">&quot;str:cmd.exe&quot;</span> <span class="string">&quot;msg:obvious probe&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$TRAVERSAL</span>:4&quot;</span> <span class="built_in">id</span>:1204;</span><br><span class="line">MainRule <span class="string">&quot;str:\\&quot;</span> <span class="string">&quot;msg:backslash&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$TRAVERSAL</span>:4&quot;</span> <span class="built_in">id</span>:1205;</span><br><span class="line"><span class="comment">#MainRule &quot;str:/&quot; &quot;msg:slash in args&quot; &quot;mz:ARGS|BODY|$HEADERS_VAR:Cookie&quot; &quot;s:$TRAVERSAL:2&quot; id:1206;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">########################################</span></span><br><span class="line"><span class="comment">## Cross Site Scripting IDs:1300-1399 ##</span></span><br><span class="line"><span class="comment">########################################</span></span><br><span class="line">MainRule <span class="string">&quot;str:&lt;&quot;</span> <span class="string">&quot;msg:html open tag&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1302;</span><br><span class="line">MainRule <span class="string">&quot;str:&gt;&quot;</span> <span class="string">&quot;msg:html close tag&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1303;</span><br><span class="line">MainRule <span class="string">&quot;str:[&quot;</span> <span class="string">&quot;msg:open square backet ([), possible js&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$XSS</span>:4&quot;</span> <span class="built_in">id</span>:1310;</span><br><span class="line">MainRule <span class="string">&quot;str:]&quot;</span> <span class="string">&quot;msg:close square bracket (]), possible js&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$XSS</span>:4&quot;</span> <span class="built_in">id</span>:1311;</span><br><span class="line">MainRule <span class="string">&quot;str:~&quot;</span> <span class="string">&quot;msg:tilde (~) character&quot;</span> <span class="string">&quot;mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$XSS</span>:4&quot;</span> <span class="built_in">id</span>:1312;</span><br><span class="line">MainRule <span class="string">&quot;str:`&quot;</span>  <span class="string">&quot;msg:grave accent (`)&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1314;</span><br><span class="line">MainRule <span class="string">&quot;rx:%[2|3].&quot;</span>  <span class="string">&quot;msg:double encoding&quot;</span> <span class="string">&quot;mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$XSS</span>:8&quot;</span> <span class="built_in">id</span>:1315;</span><br><span class="line"></span><br><span class="line"><span class="comment">####################################</span></span><br><span class="line"><span class="comment">## Evading tricks IDs: 1400-1500 ##</span></span><br><span class="line"><span class="comment">####################################</span></span><br><span class="line">MainRule <span class="string">&quot;str:&amp;#&quot;</span> <span class="string">&quot;msg:utf7/8 encoding&quot;</span> <span class="string">&quot;mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$EVADE</span>:4&quot;</span> <span class="built_in">id</span>:1400;</span><br><span class="line">MainRule <span class="string">&quot;str:%U&quot;</span> <span class="string">&quot;msg:M$ encoding&quot;</span> <span class="string">&quot;mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie&quot;</span> <span class="string">&quot;s:<span class="variable">$EVADE</span>:4&quot;</span> <span class="built_in">id</span>:1401;</span><br><span class="line"></span><br><span class="line"><span class="comment">#############################</span></span><br><span class="line"><span class="comment">## File uploads: 1500-1600 ##</span></span><br><span class="line"><span class="comment">#############################</span></span><br><span class="line">MainRule <span class="string">&quot;rx:\.ph|\.asp|\.ht&quot;</span> <span class="string">&quot;msg:asp/php file upload&quot;</span> <span class="string">&quot;mz:FILE_EXT&quot;</span> <span class="string">&quot;s:<span class="variable">$UPLOAD</span>:8&quot;</span> <span class="built_in">id</span>:1500;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/logrotate.d/nginx</span></span><br><span class="line">/var/log/nginx/*.<span class="built_in">log</span> /var/log/nginx/*/*.<span class="built_in">log</span>&#123;</span><br><span class="line">	daily</span><br><span class="line">	missingok</span><br><span class="line">	rotate 14</span><br><span class="line">	compress</span><br><span class="line">	delaycompress</span><br><span class="line">	notifempty</span><br><span class="line">	create 640 root adm</span><br><span class="line">	sharedscripts</span><br><span class="line">	postrotate</span><br><span class="line">		[ ! -f /var/run/nginx.pid ] || <span class="built_in">kill</span> -USR1 `<span class="built_in">cat</span> /var/run/nginx.pid`</span><br><span class="line">	endscript</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/nginx.conf</span></span><br><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line"><span class="comment">#worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span></span><br><span class="line">worker_rlimit_nofile 655650;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections  10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"><span class="comment">#       include       /etc/nginx/naxsi_core.rules;</span></span><br><span class="line">        include       mime.types;</span><br><span class="line">        default_type  application/octet-stream;</span><br><span class="line">	log_format garena <span class="string">&#x27;$remote_addr - $remote_user [$time_iso8601] &quot;$request&quot; $status $body_bytes_sent &#x27;</span></span><br><span class="line">                <span class="string">&#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_time $upstream_response_time &quot;$http_x_forwarded_for&quot; &quot;$geoip_country_code&quot; &quot;$host&quot;&#x27;</span>;</span><br><span class="line">        log_format garena_post <span class="string">&#x27;$remote_addr - $remote_user [$time_iso8601] &quot;$request&quot; $status $body_bytes_sent &#x27;</span></span><br><span class="line">                <span class="string">&#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_time $upstream_response_time &quot;$http_x_forwarded_for&quot; &quot;$geoip_country_code&quot; &quot;$host&quot; &quot;$request_body&quot;&#x27;</span>;</span><br><span class="line">	log_format compact <span class="string">&#x27;$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent&#x27;</span>;</span><br><span class="line">	log_format compact_post <span class="string">&#x27;$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent|$request_body&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#       access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">        sendfile        on;</span><br><span class="line"><span class="comment">#       tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">        keepalive_timeout  30;</span><br><span class="line">        fastcgi_keep_conn on;</span><br><span class="line">        tcp_nodelay        on;</span><br><span class="line"></span><br><span class="line">        gzip  on;</span><br><span class="line">        gzip_disable <span class="string">&quot;MSIE [1-6]\.(?!.*SV1)&quot;</span>;</span><br><span class="line">        gzip_proxied any;</span><br><span class="line">        gzip_buffers 16 8k;</span><br><span class="line">        gzip_types    text/plain application/javascript application/x-javascript text/javascript text/xml text/css application/json;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        include /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">	set_real_ip_from 10.0.0.0/8;</span><br><span class="line">	real_ip_header    X-Forwarded-For;</span><br><span class="line"><span class="comment">#	real_ip_recursive on;</span></span><br><span class="line"><span class="comment">#	geoip_country /usr/share/GeoIP/GeoIP.dat;</span></span><br><span class="line"></span><br><span class="line">        server_tokens off;         <span class="comment"># returns &quot;Server: nginx&quot;</span></span><br><span class="line">	more_clear_headers Server; <span class="comment"># doesn&#x27;t return &quot;Server: &quot; header at all</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">KillMode=process</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h2 id="Initialize-rpmbuild-env"><a href="#Initialize-rpmbuild-env" class="headerlink" title="Initialize rpmbuild env"></a>Initialize rpmbuild env</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check current os version and kernel</span></span><br><span class="line"><span class="built_in">cat</span> /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line">3.10.0-862.el7.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># install lua</span></span><br><span class="line">sh luajit.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install dependencies</span></span><br><span class="line">yum install -y gcc pam-devel git rpm-build pcre-devel openssl openssl-devel geoip-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /root/rpmbuild/SOURCES/</span><br><span class="line"><span class="built_in">mkdir</span> -p /root/rpmbuild/SPECS/</span><br><span class="line"><span class="built_in">mkdir</span> -p /root/rpmbuild/RPMS/noarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># download openssl</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line">wget https://github.com/openssl/openssl/archive/OpenSSL_1_0_2p.tar.gz</span><br><span class="line">tar xf OpenSSL_1_0_2p.tar.gz</span><br><span class="line"><span class="built_in">mv</span> openssl-OpenSSL_1_0_2p/ openssl-1.0.2p</span><br><span class="line"></span><br><span class="line"><span class="comment"># confirm these files are correct</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tree nginx-rpmbuild-centos7/</span></span><br><span class="line">nginx-rpmbuild-centos7/</span><br><span class="line">├── build.sh</span><br><span class="line">├── conf_buid</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   ├── django_fastcgi_params</span><br><span class="line">│   │   ├── fastcgi.conf</span><br><span class="line">│   │   ├── fastcgi_params</span><br><span class="line">│   │   ├── koi-utf</span><br><span class="line">│   │   ├── koi-win</span><br><span class="line">│   │   ├── mime.types</span><br><span class="line">│   │   ├── naxsi_core.rules</span><br><span class="line">│   │   ├── nginx.conf</span><br><span class="line">│   │   ├── scgi_params</span><br><span class="line">│   │   ├── sites-available</span><br><span class="line">│   │   │   └── 000_stub_status</span><br><span class="line">│   │   ├── uwsgi_params</span><br><span class="line">│   │   └── win-utf</span><br><span class="line">│   ├── logrotate.d</span><br><span class="line">│   │   └── nginx</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   └── nginx.service</span><br><span class="line">├── luajit.sh</span><br><span class="line">├── nginx-spec</span><br><span class="line">└── nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line">8 directories, 24 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="How-to-build-Nginx-RPM"><a href="#How-to-build-Nginx-RPM" class="headerlink" title="How to build Nginx RPM"></a>How to build Nginx RPM</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check nginx stable version from official website</span></span><br><span class="line">http://nginx.org/en/download.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># check configuration</span></span><br><span class="line">vim build.sh</span><br><span class="line"></span><br><span class="line">NGX_VER=1.14.2</span><br><span class="line">WKDIR=<span class="string">&quot;/root/rpmbuild/SOURCES&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check nginx version</span></span><br><span class="line">vim nginx-spec</span><br><span class="line"></span><br><span class="line"><span class="comment"># run build.sh</span></span><br><span class="line">./build.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># RPM package</span></span><br><span class="line">Processing files: nginx-garena-1.14.2-0.noarch</span><br><span class="line">warning: File listed twice: /etc/nginx/nginx.conf</span><br><span class="line">Provides: config(nginx-garena) = 1.14.2-0 nginx-garena = 1.14.2-0</span><br><span class="line">Requires(interp): /bin/sh</span><br><span class="line">Requires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1</span><br><span class="line">Requires(post): /bin/sh</span><br><span class="line">Requires: libGeoIP.so.1()(64bit) libc.so.6()(64bit) libc.so.6(GLIBC_2.10)(64bit) libc.so.6(GLIBC_2.11)(64bit) libc.so.6(GLIBC_2.14)(64bit) libc.so.6(GLIBC_2.17)(64bit) libc.so.6(GLIBC_2.2.5)(64bit) libc.so.6(GLIBC_2.3)(64bit) libc.so.6(GLIBC_2.3.2)(64bit) libc.so.6(GLIBC_2.3.4)(64bit) libc.so.6(GLIBC_2.4)(64bit) libc.so.6(GLIBC_2.7)(64bit) libcrypt.so.1()(64bit) libcrypt.so.1(GLIBC_2.2.5)(64bit) libdl.so.2()(64bit) libdl.so.2(GLIBC_2.2.5)(64bit) libgcc_s.so.1()(64bit) libgcc_s.so.1(GCC_3.0)(64bit) libgcc_s.so.1(GCC_3.3)(64bit) libm.so.6()(64bit) libm.so.6(GLIBC_2.2.5)(64bit) libpam.so.0()(64bit) libpam.so.0(LIBPAM_1.0)(64bit) libpcre.so.1()(64bit) libpthread.so.0()(64bit) libpthread.so.0(GLIBC_2.2.5)(64bit) libpthread.so.0(GLIBC_2.3.2)(64bit) libz.so.1()(64bit) rtld(GNU_HASH)</span><br><span class="line">warning: Arch dependent binaries <span class="keyword">in</span> noarch package</span><br><span class="line">Checking <span class="keyword">for</span> unpackaged file(s): /usr/lib/rpm/check-files /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64</span><br><span class="line">Wrote: /root/rpmbuild/SRPMS/nginx-garena-1.14.2-0.src.rpm</span><br><span class="line">Wrote: /root/rpmbuild/RPMS/noarch/nginx-garena-1.14.2-0.noarch.rpm</span><br><span class="line">Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.iR5dLd</span><br><span class="line">+ <span class="built_in">umask</span> 022</span><br><span class="line">+ <span class="built_in">cd</span> /root/rpmbuild/BUILD</span><br><span class="line">+ <span class="built_in">cd</span> nginx-garena-1.14.2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64 <span class="string">&#x27;!=&#x27;</span> / <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ <span class="built_in">rm</span> -rf /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64</span><br><span class="line">+ <span class="built_in">exit</span> 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="基于openresty制作nginx-rpm安装包"><a href="#基于openresty制作nginx-rpm安装包" class="headerlink" title="基于openresty制作nginx rpm安装包"></a>基于openresty制作nginx rpm安装包</h2><blockquote>
<p>推荐大家向openresty转型，我在编译过程中主要遇到以下4个小问题</p>
</blockquote>
<ol>
<li>问题1沿用官方的luajit v2.0.5编译新版本lua-nginx-module应该会提示建议切换至openresty的luajit v2.1分支</li>
<li>问题2的解决方案是使用低版本lua-nginx-module v0.10.14，使用最新版发现会触发该问题，等待官方修复</li>
<li>问题3的原因是因为 nginx 启动需要一点点时间，而 systemd 在 nginx 完成启动前就去读取 pid file造成读取 pid 失败</li>
<li>问题4的libluajit-5.1.so.2问题跟着我的步骤执行应该不会出现，不需要执行ln软链接等操作</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 wangao]<span class="comment"># tailf /var/log/nginx/error.log</span></span><br><span class="line"><span class="comment"># 问题1</span></span><br><span class="line">2019/11/04 11:59:56 [alert] 2749<span class="comment">#2749: detected a LuaJIT version which is not OpenResty&#x27;s; many optimizations will be disabled and performance will be compromised (see https://github.com/openresty/luajit2 for OpenResty&#x27;s LuaJIT or, even better, consider using the OpenResty releases from https://openresty.org/en/download.html)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题2</span></span><br><span class="line">2019/11/04 11:59:56 [alert] 2749<span class="comment">#2749: failed to load the &#x27;resty.core&#x27; module (https://github.com/openresty/lua-resty-core); ensure you are using an OpenResty release from https://openresty.org/en/download.html (reason: module &#x27;resty.core&#x27; not found:</span></span><br><span class="line">	no field package.preload[<span class="string">&#x27;resty.core&#x27;</span>]</span><br><span class="line">	no file <span class="string">&#x27;./resty/core.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/share/luajit-2.0.5/resty/core.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/share/lua/5.1/resty/core.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/share/lua/5.1/resty/core/init.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;./resty/core.so&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/lib/lua/5.1/resty/core.so&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/lib/lua/5.1/loadall.so&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;./resty.so&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/lib/lua/5.1/resty.so&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/lib/lua/5.1/loadall.so&#x27;</span>) <span class="keyword">in</span> /etc/nginx/nginx.conf:117</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题3</span></span><br><span class="line">[root@gop-sg-192-168-56-103 wangao]<span class="comment"># systemctl status nginx</span></span><br><span class="line">● nginx.service - The NGINX HTTP and reverse proxy server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-08-19 01:36:46 +08; 2 months 17 days ago</span><br><span class="line">  Process: 1105 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 1071 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 1111 (nginx)</span><br><span class="line">    Tasks: 2</span><br><span class="line">   CGroup: /system.slice/nginx.service</span><br><span class="line">           ├─1111 nginx: master process /usr/sbin/nginx</span><br><span class="line">           └─1112 nginx: worker process</span><br><span class="line"></span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 systemd[1]: Starting The NGINX HTTP and reverse proxy server...</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 nginx[1071]: nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 nginx[1071]: nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 systemd[1]: Failed to <span class="built_in">read</span> PID from file /run/nginx.pid: Invalid argument</span><br><span class="line">Aug 19 01:36:46 gop-sg-192-168-56-103 systemd[1]: Started The NGINX HTTP and reverse proxy server.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题4</span></span><br><span class="line">nginx: error <span class="keyword">while</span> loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check current os version and kernel</span></span><br><span class="line"><span class="built_in">cat</span> /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line">3.10.0-862.el7.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum</span></span><br><span class="line">yum install -y gcc pam-devel git rpm-build pcre-devel openssl openssl-devel geoip-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /root/rpmbuild/SOURCES/</span><br><span class="line"><span class="built_in">mkdir</span> -p /root/rpmbuild/SPECS/</span><br><span class="line"><span class="built_in">mkdir</span> -p /root/rpmbuild/RPMS/noarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># download openssl</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line">wget https://github.com/openssl/openssl/archive/OpenSSL_1_0_2t.tar.gz</span><br><span class="line">tar xf OpenSSL_1_0_2t.tar.gz</span><br><span class="line"><span class="built_in">mv</span> openssl-OpenSSL_1_0_2t/ openssl-1_0_2t</span><br><span class="line"></span><br><span class="line"><span class="comment"># install lua</span></span><br><span class="line">sh luajit2.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># confirm these files are correct</span></span><br><span class="line">[root@gop-sg-192-168-56-103 ~]<span class="comment"># tree nginx-rpmbuild-centos7/</span></span><br><span class="line">nginx-rpmbuild-centos7/</span><br><span class="line">├── build.sh</span><br><span class="line">├── conf_build</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   ├── django_fastcgi_params</span><br><span class="line">│   │   ├── fastcgi.conf</span><br><span class="line">│   │   ├── fastcgi_params</span><br><span class="line">│   │   ├── koi-utf</span><br><span class="line">│   │   ├── koi-win</span><br><span class="line">│   │   ├── mime.types</span><br><span class="line">│   │   ├── naxsi_core.rules</span><br><span class="line">│   │   ├── nginx.conf</span><br><span class="line">│   │   ├── scgi_params</span><br><span class="line">│   │   ├── sites-available</span><br><span class="line">│   │   │   └── 000_stub_status</span><br><span class="line">│   │   ├── uwsgi_params</span><br><span class="line">│   │   └── win-utf</span><br><span class="line">│   ├── logrotate.d</span><br><span class="line">│   │   └── nginx</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   └── nginx.service</span><br><span class="line">├── luajit2.sh</span><br><span class="line">├── luajit.sh</span><br><span class="line">├── nginx-spec</span><br><span class="line">└── nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   ├── nginx.conf</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line">8 directories, 26 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>luajit2.sh</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/openresty/luajit2/releases</span></span><br><span class="line">LUAVER=<span class="string">&quot;v2.1-20190912&quot;</span></span><br><span class="line">WKDIR=<span class="string">&quot;/root/rpmbuild/SOURCES&quot;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget https://github.com/openresty/luajit2/archive/<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">tar zxf <span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line"><span class="built_in">rm</span> -f <span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> luajit2*</span><br><span class="line">make BUILDMODE=static</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/local/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/local/include/luajit-2.1</span><br><span class="line"><span class="comment"># ln -s /usr/local/lib/libluajit-5.1.so.2 /lib64/libluajit-5.1.so.2</span></span><br><span class="line"><span class="comment"># https://github.com/openresty/lua-nginx-module/issues/8</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>build.sh</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">NGX_VER=1.16.1</span><br><span class="line">BDDIR=<span class="string">&quot;/root/rpmbuild/BUILD&quot;</span></span><br><span class="line">WKDIR=<span class="string">&quot;/root/rpmbuild/SOURCES&quot;</span></span><br><span class="line">CURRENTDIR=`<span class="built_in">dirname</span> $(<span class="built_in">readlink</span> -f <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)`</span><br><span class="line">libIP2Location=<span class="string">&quot;<span class="variable">$CURRENTDIR</span>/IP2Location-C-Library-master/libIP2Location/IP2Location.h&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CURRENTDIR</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/local/lib</span><br><span class="line"><span class="comment"># export LUAJIT_INC=/usr/local/include/luajit-2.0</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/local/include/luajit-2.1</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/local/lib</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$BDDIR</span></span><br><span class="line"><span class="built_in">rm</span> -rf *</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line"><span class="built_in">rm</span> -rf *</span><br><span class="line">wget http://nginx.org/download/nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">tar xzf nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line"><span class="built_in">rm</span> -f nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line"><span class="built_in">mv</span> nginx-<span class="variable">$NGX_VER</span> nginx-garena-<span class="variable">$NGX_VER</span></span><br><span class="line"><span class="built_in">cd</span> nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p contrib</span><br><span class="line"><span class="built_in">cd</span> contrib/</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/openresty/headers-more-nginx-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/openresty/echo-nginx-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/simplresty/ngx_devel_kit.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/ip2location/ip2location-nginx.git</span><br><span class="line"><span class="comment"># git clone git://github.com/openresty/lua-nginx-module</span></span><br><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.14.tar.gz</span><br><span class="line">tar xf v0.10.14.tar.gz</span><br><span class="line"><span class="built_in">mv</span> lua-nginx-module-0.10.14 lua-nginx-module</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/nbs-system/naxsi.git</span><br><span class="line"><span class="built_in">rm</span> -rf */.git</span><br><span class="line"><span class="built_in">rm</span> -rf *.tar*</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -r <span class="variable">$CURRENTDIR</span>/nginx-template/* <span class="variable">$WKDIR</span>/nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"><span class="built_in">cp</span> -r <span class="variable">$CURRENTDIR</span>/conf_buid/conf/* <span class="variable">$WKDIR</span>/nginx-garena-<span class="variable">$NGX_VER</span>/conf/</span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$CURRENTDIR</span>/nginx-spec /root/rpmbuild/SPECS/</span><br><span class="line"><span class="comment"># cp /root/rules $WKDIR/nginx-garena-$NGX_VER/debian/</span></span><br><span class="line"><span class="comment"># sed -Ei &#x27;s|#include &quot;IP2Location.h&quot;|#include &quot;/root/nginx-rpmbuild-centos7/IP2Location-C-Library-master/libIP2Location/IP2Location.h&quot;|&#x27; $WKDIR/nginx-garena-$NGX_VER/contrib/ip2location-nginx/ngx_http_ip2location_module.c</span></span><br><span class="line">sed -Ei <span class="string">&#x27;s|#include &quot;IP2Location.h&quot;|#include &quot;&#x27;</span><span class="variable">$&#123;libIP2Location&#125;</span><span class="string">&#x27;&quot;|&#x27;</span> <span class="variable">$WKDIR</span>/nginx-garena-<span class="variable">$NGX_VER</span>/contrib/ip2location-nginx/ngx_http_ip2location_module.c</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">tar zcf nginx-garena-<span class="variable">$NGX_VER</span>.tar.gz nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/SPECS/</span><br><span class="line">rpmbuild -ba nginx-spec</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/RPMS/noarch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>nginx-spec</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">Name: nginx-garena</span><br><span class="line">Version: 1.16.1</span><br><span class="line">Release: 0</span><br><span class="line">Summary: nginx garena rpm</span><br><span class="line">Source0: nginx-garena-%&#123;version&#125;.tar.gz</span><br><span class="line">License: GPL</span><br><span class="line">Group: Rahul</span><br><span class="line">BuildArch: noarch</span><br><span class="line">BuildRoot: %&#123;_tmppath&#125;/%&#123;name&#125;-buildroot</span><br><span class="line">%description</span><br><span class="line">Garena self-build Nginx.</span><br><span class="line">%define _binaries_in_noarch_packages_terminate_build   0</span><br><span class="line">%prep</span><br><span class="line">%setup -q %&#123;name&#125;-%&#123;version&#125;</span><br><span class="line">%build</span><br><span class="line">CFLAGS=&quot;$RPM_OPT_FLAGS&quot; ./configure --prefix=/usr/share/nginx/ \</span><br><span class="line">                    --with-ld-opt=&quot;-Wl,-rpath,/usr/local/lib&quot; \</span><br><span class="line">                    --sbin-path=/usr/sbin/nginx \</span><br><span class="line">                    --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">                    --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">                    --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">                    --pid-path=/var/run/nginx.pid \</span><br><span class="line">                    --lock-path=/var/lock/nginx.lock \</span><br><span class="line">                    --http-client-body-temp-path=/var/lib/nginx/body \</span><br><span class="line">                    --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span><br><span class="line">                    --http-proxy-temp-path=/var/lib/nginx/proxy \</span><br><span class="line">                    --http-scgi-temp-path=/var/lib/nginx/scgi \</span><br><span class="line">                    --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span><br><span class="line">                    --with-pcre-jit \</span><br><span class="line">                    --with-http_flv_module \</span><br><span class="line">                    --with-http_mp4_module \</span><br><span class="line">                    --with-file-aio \</span><br><span class="line">                    --with-http_v2_module \</span><br><span class="line">                    --with-stream \</span><br><span class="line">                    --with-stream_ssl_module \</span><br><span class="line">                    --with-stream_realip_module \</span><br><span class="line">                    --with-http_auth_request_module \</span><br><span class="line">                    --with-http_slice_module \</span><br><span class="line">                    --with-threads \</span><br><span class="line">                    --with-http_gunzip_module \</span><br><span class="line">                    --with-http_random_index_module \</span><br><span class="line">                    --with-http_secure_link_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_ssl_module \</span><br><span class="line">                    --with-openssl=/usr/local/src/openssl-1_0_2t \</span><br><span class="line">                    --with-http_addition_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_gzip_static_module \</span><br><span class="line">                    --with-http_realip_module \</span><br><span class="line">                    --with-ipv6 \</span><br><span class="line">                    --without-mail_pop3_module \</span><br><span class="line">                    --without-mail_imap_module \</span><br><span class="line">                    --without-mail_smtp_module \</span><br><span class="line">                    --add-module=contrib/headers-more-nginx-module \</span><br><span class="line">                    --add-module=contrib/echo-nginx-module \</span><br><span class="line">                    --add-module=contrib/ngx_devel_kit \</span><br><span class="line">                    --add-module=contrib/ip2location-nginx \</span><br><span class="line">                    --add-module=contrib/lua-nginx-module \</span><br><span class="line">                    --add-module=contrib/naxsi/naxsi_src</span><br><span class="line"></span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line">%install</span><br><span class="line">[ &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT</span><br><span class="line">make DESTDIR=$RPM_BUILD_ROOT install</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/etc/nginx/sites-enabled</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/etc/nginx/sites-available</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/etc/nginx/ssl</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/var/log/nginx</span><br><span class="line">install -m 0755 -d $RPM_BUILD_ROOT/var/lib/nginx</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status $RPM_BUILD_ROOT/etc/nginx/sites-available/000_stub_status</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status $RPM_BUILD_ROOT/etc/nginx/sites-enabled/000_stub_status</span><br><span class="line">install -D -m 644 conf/sites-available/000_default $RPM_BUILD_ROOT/etc/nginx/sites-available/000_default</span><br><span class="line">install -D -m 644 conf/sites-available/000_default $RPM_BUILD_ROOT/etc/nginx/sites-enabled/000_default</span><br><span class="line">install -D -m 644 conf/ssl/nginx.key $RPM_BUILD_ROOT/etc/nginx/ssl/nginx.key</span><br><span class="line">install -D -m 644 conf/ssl/nginx.crt $RPM_BUILD_ROOT/etc/nginx/ssl/nginx.crt</span><br><span class="line">install -D -m 644 conf/django_fastcgi_params $RPM_BUILD_ROOT/etc/nginx/django_fastcgi_params</span><br><span class="line">install -D -m 644 conf/naxsi_core.rules $RPM_BUILD_ROOT/etc/nginx/naxsi_core.rules</span><br><span class="line">install -D -m 644 logrotate.d/nginx $RPM_BUILD_ROOT/etc/logrotate.d/nginx</span><br><span class="line">install -D -m 644 nginx.service $RPM_BUILD_ROOT/usr/lib/systemd/system/nginx.service</span><br><span class="line">%clean</span><br><span class="line">[ &quot;$RPM_BUILD_ROOT&quot; != &quot;/&quot; ] &amp;&amp; rm -rf $RPM_BUILD_ROOT</span><br><span class="line">%post</span><br><span class="line">useradd -s /sbin/nologin -d /var/www www-data</span><br><span class="line">chown -R www-data.www-data /var/log/nginx /var/lib/nginx</span><br><span class="line">systemctl enable nginx</span><br><span class="line">echo %&#123;name&#125;-%&#123;version&#125; is successfully installed.</span><br><span class="line">systemctl start nginx</span><br><span class="line">%files</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line">%dir /etc/nginx</span><br><span class="line">/etc/nginx/*</span><br><span class="line">%dir /usr/src/debug/nginx-garena-%&#123;version&#125;</span><br><span class="line">/usr/src/debug/nginx-garena-%&#123;version&#125;/*</span><br><span class="line">/usr/sbin/nginx</span><br><span class="line">%dir /usr/share/nginx</span><br><span class="line">/usr/share/nginx/*</span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/usr/lib/debug/*</span><br><span class="line">/usr/lib/debug/.build-id/*</span><br><span class="line">%dir /var/log/nginx</span><br><span class="line">%dir /var/lib/nginx</span><br><span class="line">%config(noreplace) /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>logrotate.d&#x2F;nginx</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/var/log/nginx/*.log /var/log/nginx/*/*.log&#123;</span><br><span class="line">	daily</span><br><span class="line">	missingok</span><br><span class="line">	rotate 14</span><br><span class="line">	compress</span><br><span class="line">	delaycompress</span><br><span class="line">	notifempty</span><br><span class="line">	create 640 root adm</span><br><span class="line">	sharedscripts</span><br><span class="line">	postrotate</span><br><span class="line">		[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">	endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nginx.conf</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">#worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span><br><span class="line">worker_rlimit_nofile 655650;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections  10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">#       include       /etc/nginx/naxsi_core.rules;</span><br><span class="line">        include       mime.types;</span><br><span class="line">        default_type  application/octet-stream;</span><br><span class="line">	log_format garena &#x27;$remote_addr - $remote_user [$time_iso8601] &quot;$request&quot; $status $body_bytes_sent &#x27;</span><br><span class="line">                &#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_time $upstream_response_time &quot;$http_x_forwarded_for&quot; &quot;$geoip_country_code&quot; &quot;$host&quot;&#x27;;</span><br><span class="line">        log_format garena_post &#x27;$remote_addr - $remote_user [$time_iso8601] &quot;$request&quot; $status $body_bytes_sent &#x27;</span><br><span class="line">                &#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_time $upstream_response_time &quot;$http_x_forwarded_for&quot; &quot;$geoip_country_code&quot; &quot;$host&quot; &quot;$request_body&quot;&#x27;;</span><br><span class="line">	log_format compact &#x27;$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent&#x27;;</span><br><span class="line">	log_format compact_post &#x27;$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent|$request_body&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#       access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">        sendfile        on;</span><br><span class="line">#       tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">        keepalive_timeout  30;</span><br><span class="line">        fastcgi_keep_conn on;</span><br><span class="line">        tcp_nodelay        on;</span><br><span class="line"></span><br><span class="line">        gzip  on;</span><br><span class="line">        gzip_disable &quot;MSIE [1-6]\.(?!.*SV1)&quot;;</span><br><span class="line">        gzip_proxied any;</span><br><span class="line">        gzip_buffers 16 8k;</span><br><span class="line">        gzip_types    text/plain application/javascript application/x-javascript text/javascript text/xml text/css application/json;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        include /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">	set_real_ip_from 10.0.0.0/8;</span><br><span class="line">	real_ip_header    X-Forwarded-For;</span><br><span class="line">#	real_ip_recursive on;</span><br><span class="line">#	geoip_country /usr/share/GeoIP/GeoIP.dat;</span><br><span class="line"></span><br><span class="line">        server_tokens off;         # returns &quot;Server: nginx&quot;</span><br><span class="line">	more_clear_headers Server; # doesn&#x27;t return &quot;Server: &quot; header at all</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>nginx.service</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/start/topics/examples/initscripts/">https://www.nginx.com/resources/wiki/start/topics/examples/initscripts/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">KillMode=process</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="编译生成nginx-rpm"><a href="#编译生成nginx-rpm" class="headerlink" title="编译生成nginx rpm"></a>编译生成nginx rpm</h3><ol>
<li>编辑build.sh和nginx-spec定义NGX_VER&#x3D;1.16.1</li>
<li>如果需要改变contrib的module也是修改上述两处位置</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">sh build.sh</span><br><span class="line"></span><br><span class="line">extracting debug info from /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64/usr/sbin/nginx</span><br><span class="line">dwz: Too few files <span class="keyword">for</span> multifile optimization</span><br><span class="line">/usr/lib/rpm/sepdebugcrcfix: Updated 1 CRC32s, 0 CRC32s did match.</span><br><span class="line">12776 blocks</span><br><span class="line">+ /usr/lib/rpm/check-buildroot</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-compress</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-strip-static-archive /usr/bin/strip</span><br><span class="line">+ /usr/lib/rpm/brp-python-bytecompile /usr/bin/python 1</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-python-hardlink</span><br><span class="line">+ /usr/lib/rpm/redhat/brp-java-repack-jars</span><br><span class="line">Processing files: nginx-garena-1.16.1-0.noarch</span><br><span class="line">warning: File listed twice: /etc/nginx/nginx.conf</span><br><span class="line">Provides: config(nginx-garena) = 1.16.1-0 nginx-garena = 1.16.1-0</span><br><span class="line">Requires(interp): /bin/sh</span><br><span class="line">Requires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1</span><br><span class="line">Requires(post): /bin/sh</span><br><span class="line">Requires: libGeoIP.so.1()(64bit) libc.so.6()(64bit) libc.so.6(GLIBC_2.10)(64bit) libc.so.6(GLIBC_2.11)(64bit) libc.so.6(GLIBC_2.14)(64bit) libc.so.6(GLIBC_2.17)(64bit) libc.so.6(GLIBC_2.2.5)(64bit) libc.so.6(GLIBC_2.3)(64bit) libc.so.6(GLIBC_2.3.2)(64bit) libc.so.6(GLIBC_2.3.4)(64bit) libc.so.6(GLIBC_2.4)(64bit) libc.so.6(GLIBC_2.7)(64bit) libcrypt.so.1()(64bit) libcrypt.so.1(GLIBC_2.2.5)(64bit) libdl.so.2()(64bit) libdl.so.2(GLIBC_2.2.5)(64bit) libgcc_s.so.1()(64bit) libgcc_s.so.1(GCC_3.0)(64bit) libgcc_s.so.1(GCC_3.3)(64bit) libm.so.6()(64bit) libm.so.6(GLIBC_2.2.5)(64bit) libpcre.so.1()(64bit) libpthread.so.0()(64bit) libpthread.so.0(GLIBC_2.2.5)(64bit) libpthread.so.0(GLIBC_2.3.2)(64bit) libz.so.1()(64bit) rtld(GNU_HASH)</span><br><span class="line">warning: Arch dependent binaries <span class="keyword">in</span> noarch package</span><br><span class="line">Checking <span class="keyword">for</span> unpackaged file(s): /usr/lib/rpm/check-files /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64</span><br><span class="line">Wrote: /root/rpmbuild/SRPMS/nginx-garena-1.16.1-0.src.rpm</span><br><span class="line">Wrote: /root/rpmbuild/RPMS/noarch/nginx-garena-1.16.1-0.noarch.rpm</span><br><span class="line">Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.Qc7JbE</span><br><span class="line">+ <span class="built_in">umask</span> 022</span><br><span class="line">+ <span class="built_in">cd</span> /root/rpmbuild/BUILD</span><br><span class="line">+ <span class="built_in">cd</span> nginx-garena-1.16.1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64 <span class="string">&#x27;!=&#x27;</span> / <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ <span class="built_in">rm</span> -rf /root/rpmbuild/BUILDROOT/nginx-garena-1.16.1-0.x86_64</span><br><span class="line">+ <span class="built_in">exit</span> 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built with OpenSSL 1.0.2t  10 Sep 2019</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/share/nginx/ --with-ld-opt=-Wl,-rpath,/usr/local/lib --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx.lock --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-pcre-jit --with-http_flv_module --with-http_mp4_module --with-file-aio --with-http_v2_module --with-stream --with-stream_ssl_module --with-http_auth_request_module --with-http_slice_module --with-threads --with-http_gunzip_module --with-http_random_index_module --with-http_secure_link_module --with-http_geoip_module --with-http_ssl_module --with-openssl=/usr/local/src/openssl-1_0_2t --with-http_addition_module --with-http_geoip_module --with-http_gzip_static_module --with-http_realip_module --with-ipv6 --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --add-module=contrib/headers-more-nginx-module --add-module=contrib/echo-nginx-module --add-module=contrib/ngx_devel_kit --add-module=contrib/lua-nginx-module --add-module=contrib/naxsi/naxsi_src</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prettier</span></span><br><span class="line">https://serverfault.com/questions/223509/how-can-i-see-which-flags-nginx-was-compiled-with</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># 2&gt;&amp;1 nginx -V | xargs -n1</span></span><br><span class="line">nginx</span><br><span class="line">version:</span><br><span class="line">nginx/1.16.1</span><br><span class="line">built</span><br><span class="line">with</span><br><span class="line">OpenSSL</span><br><span class="line">1.0.2t</span><br><span class="line">10</span><br><span class="line">Sep</span><br><span class="line">2019</span><br><span class="line">TLS</span><br><span class="line">SNI</span><br><span class="line">support</span><br><span class="line">enabled</span><br><span class="line">configure</span><br><span class="line">arguments:</span><br><span class="line">--prefix=/usr/share/nginx/</span><br><span class="line">--with-ld-opt=-Wl,-rpath,/usr/local/lib</span><br><span class="line">--sbin-path=/usr/sbin/nginx</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf</span><br><span class="line">--error-log-path=/var/log/nginx/error.log</span><br><span class="line">--http-log-path=/var/log/nginx/access.log</span><br><span class="line">--pid-path=/var/run/nginx.pid</span><br><span class="line">--lock-path=/var/lock/nginx.lock</span><br><span class="line">--http-client-body-temp-path=/var/lib/nginx/body</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/fastcgi</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/proxy</span><br><span class="line">--http-scgi-temp-path=/var/lib/nginx/scgi</span><br><span class="line">--http-uwsgi-temp-path=/var/lib/nginx/uwsgi</span><br><span class="line">--with-pcre-jit</span><br><span class="line">--with-http_flv_module</span><br><span class="line">--with-http_mp4_module</span><br><span class="line">--with-file-aio</span><br><span class="line">--with-http_v2_module</span><br><span class="line">--with-stream</span><br><span class="line">--with-stream_ssl_module</span><br><span class="line">--with-http_auth_request_module</span><br><span class="line">--with-http_slice_module</span><br><span class="line">--with-threads</span><br><span class="line">--with-http_gunzip_module</span><br><span class="line">--with-http_random_index_module</span><br><span class="line">--with-http_secure_link_module</span><br><span class="line">--with-http_geoip_module</span><br><span class="line">--with-http_ssl_module</span><br><span class="line">--with-openssl=/usr/local/src/openssl-1_0_2t</span><br><span class="line">--with-http_addition_module</span><br><span class="line">--with-http_geoip_module</span><br><span class="line">--with-http_gzip_static_module</span><br><span class="line">--with-http_realip_module</span><br><span class="line">--with-ipv6</span><br><span class="line">--without-mail_pop3_module</span><br><span class="line">--without-mail_imap_module</span><br><span class="line">--without-mail_smtp_module</span><br><span class="line">--add-module=contrib/headers-more-nginx-module</span><br><span class="line">--add-module=contrib/echo-nginx-module</span><br><span class="line">--add-module=contrib/ngx_devel_kit</span><br><span class="line">--add-module=contrib/lua-nginx-module</span><br><span class="line">--add-module=contrib/naxsi/naxsi_src</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># 2&gt;&amp;1 nginx -V | xargs -n1 | grep ssl</span></span><br><span class="line">--with-stream_ssl_module</span><br><span class="line">--with-http_ssl_module</span><br><span class="line">--with-openssl=/usr/local/src/openssl-1_0_2t</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-49-5 wangao]<span class="comment"># 2&gt;&amp;1 nginx -V | xargs -n1 | grep lua</span></span><br><span class="line">--add-module=contrib/lua-nginx-module</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://openresty.org/">OpenResty</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/en-US/quick-docs/creating-rpm-packages/index.html">Creating RPM packages</a></p>
<p><a target="_blank" rel="noopener" href="https://fedoraproject.org/wiki/How_to_create_a_GNU_Hello_RPM_package/zh-cn">How to create a GNU Hello RPM</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.51cto.com/nmshuishui/1583117">使用 rpm-build 制作 nginx 的 rpm 包</a></p>
<p><a target="_blank" rel="noopener" href="http://abcdxyzk.github.io/blog/2014/10/30/tools-src-rpm/">修改、重新生成和安装src.rpm源码包</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0-Study/">学习 | Study</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://wsgzao.github.io/post/rpmbuild/" data-title="使用rpmbuild制作Nginx的RPM包 | HelloDog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/certbot/" title="使用certbot代替acme.sh免费申请wildcard通配符证书和自动更新实践小结">
  <strong>上一篇：</strong><br/>
  <span>
  使用certbot代替acme.sh免费申请wildcard通配符证书和自动更新实践小结</span>
</a>
</div>


<div class="next">
<a href="/post/epel/"  title="RHEL/CentOS安装EPEL/Remi扩展仓库配置小结">
 <strong>下一篇：</strong><br/> 
 <span>RHEL/CentOS安装EPEL/Remi扩展仓库配置小结
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%8E%86%E5%8F%B2"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRPM"><span class="toc-number">3.</span> <span class="toc-text">什么是RPM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E3%80%81%E9%87%8D%E6%96%B0%E7%94%9F%E6%88%90%E5%92%8C%E5%AE%89%E8%A3%85src-rpm%E6%BA%90%E7%A0%81%E5%8C%85"><span class="toc-number">4.</span> <span class="toc-text">修改、重新生成和安装src.rpm源码包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B6%E4%BD%9Crpm%E5%8C%85"><span class="toc-number">5.</span> <span class="toc-text">制作rpm包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#build-shell"><span class="toc-number">5.1.</span> <span class="toc-text">build shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-spec"><span class="toc-number">5.2.</span> <span class="toc-text">nginx-spec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-template"><span class="toc-number">5.3.</span> <span class="toc-text">nginx-template</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Initialize-rpmbuild-env"><span class="toc-number">6.</span> <span class="toc-text">Initialize rpmbuild env</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-build-Nginx-RPM"><span class="toc-number">7.</span> <span class="toc-text">How to build Nginx RPM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eopenresty%E5%88%B6%E4%BD%9Cnginx-rpm%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-number">8.</span> <span class="toc-text">基于openresty制作nginx rpm安装包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">8.1.</span> <span class="toc-text">环境初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E7%94%9F%E6%88%90nginx-rpm"><span class="toc-number">8.2.</span> <span class="toc-text">编译生成nginx rpm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">9.</span> <span class="toc-text">参考文章</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="wsgzao" data-theme="medium"></div>
<script type="text/javascript" src="//lab.lepture.com/github-cards/widget.js" ></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/学习-Study/" title="学习 | Study">学习 | Study<sup>195</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活-Life/" title="生活 | Life">生活 | Life<sup>29</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件-Soft/" title="软件 | Soft">软件 | Soft<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.linkedin.com/in/aowang" target="_blank" title="LinkedIn">LinkedIn</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, I&#39;m OX. This is my blog on GitHub. <br/>
			Keep Calm and Carry On.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/wsgzao" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/aowang" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2024 
		
		<a href="/about" target="_blank" title="wsgzao">wsgzao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-3.6.4.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery-qrcode-0.18.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'wsgzao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-77732745-1', 'wsgzao.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c2c5fc7d844d0973d9f77abd87f49c3c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- swiftype Begin -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','_4qDmKrBPn9Es3UvQHT4','2.0.0');
</script>

<!-- swiftype End -->

  </body>
</html>
