
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    var host = "wsgzao.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LJ3PMGPVCK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LJ3PMGPVCK');
</script>
  
    <title>使用ELK(Elasticsearch + Logstash + Kibana) 搭建日志集中分析平台实践 | HelloDog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wsgzao">
    

    
    <meta name="description" content="ELK(Elasticsearch + Logstash + Kibana)">
<meta property="og:type" content="article">
<meta property="og:title" content="使用ELK(Elasticsearch + Logstash + Kibana) 搭建日志集中分析平台实践">
<meta property="og:url" content="https://wsgzao.github.io/post/elk/index.html">
<meta property="og:site_name" content="HelloDog">
<meta property="og:description" content="ELK(Elasticsearch + Logstash + Kibana)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705113413.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115737.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115809.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115910.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115946.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703120000.png">
<meta property="article:published_time" content="2019-07-02T04:43:14.000Z">
<meta property="article:modified_time" content="2023-02-27T05:33:06.000Z">
<meta property="article:author" content="wsgzao">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705113413.png">

    
    <link rel="alternative" href="/atom.xml" title="HelloDog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HelloDog" title="HelloDog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HelloDog">HelloDog</a></h1>
				<h2 class="blog-motto">Keep Calm and Carry On</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index/">索引 | Index</a></li>
					
						<li><a href="/archives/">归档 | Archives</a></li>
					
						<li><a href="/about/">简介 | About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/elk/" title="使用ELK(Elasticsearch + Logstash + Kibana) 搭建日志集中分析平台实践" itemprop="url">使用ELK(Elasticsearch + Logstash + Kibana) 搭建日志集中分析平台实践</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="wsgzao" target="_blank" itemprop="author">wsgzao</a>
		
  <p class="article-time">
    <time datetime="2019-07-02T04:43:14.000Z" itemprop="datePublished"> 发表于 2019-07-02</time>
    
  </p>
</header>
	<div class="article-content">
<!-- 		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">更新记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELK%E7%AE%80%E4%BB%8B"><span class="toc-number">3.</span> <span class="toc-text">ELK简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%AE%BE%E7%BD%AE%E5%8D%95%E8%8A%82%E7%82%B9-ELK"><span class="toc-number">4.</span> <span class="toc-text">安装设置单节点 ELK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA-ELK"><span class="toc-number">4.1.</span> <span class="toc-text">命令行启动一个 ELK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#elasticsearch-%E9%87%8D%E8%A6%81%E7%9A%84%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98"><span class="toc-number">4.2.</span> <span class="toc-text">elasticsearch 重要的参数调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AElogstash"><span class="toc-number">4.3.</span> <span class="toc-text">只需要配置logstash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filebeat-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.</span> <span class="toc-text">filebeat 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-filebeat-output"><span class="toc-number">4.5.</span> <span class="toc-text">查看 filebeat output</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kibana-%E7%AE%80%E5%8D%95%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">4.6.</span> <span class="toc-text">Kibana 简单的使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%AE%BE%E7%BD%AE%E9%9B%86%E7%BE%A4-ELK-%E7%89%88%E6%9C%AC-6-7"><span class="toc-number">5.</span> <span class="toc-text">安装设置集群 ELK 版本 6.7</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch-%E5%A4%9A%E8%8A%82%E7%82%B9%E6%90%AD%E5%BB%BA"><span class="toc-number">5.1.</span> <span class="toc-text">Elasticsearch 多节点搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kibana-%E6%90%AD%E5%BB%BA"><span class="toc-number">5.2.</span> <span class="toc-text">Kibana 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash-%E6%90%AD%E5%BB%BA"><span class="toc-number">5.3.</span> <span class="toc-text">Logstash 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E7%81%BE%E6%B5%8B%E8%AF%95"><span class="toc-number">5.4.</span> <span class="toc-text">容灾测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kibana-%E6%8E%A7%E5%88%B6%E5%8F%B0-Console"><span class="toc-number">6.</span> <span class="toc-text">kibana 控制台 Console</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Console-%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">6.1.</span> <span class="toc-text">Console 常用的命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">7.</span> <span class="toc-text">Elasticsearch 数据迁移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91"><span class="toc-number">8.</span> <span class="toc-text">Nginx 代理转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91"><span class="toc-number">9.</span> <span class="toc-text">踩过的坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">10.</span> <span class="toc-text">参考文章</span></a></li></ol>
		
		</div>
		 -->
		<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190705113413.png"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Elasticsearch + Logstash + Kibana（ELK）是一套开源的日志管理方案，分析网站的访问情况时我们一般会借助Google&#x2F;百度&#x2F;CNZZ等方式嵌入JS做数据统计，但是当网站访问异常或者被攻击时我们需要在后台分析如Nginx的具体日志，而Nginx日志分割&#x2F;GoAccess&#x2F;Awstats都是相对简单的单节点解决方案，针对分布式集群或者数据量级较大时会显得心有余而力不足，而ELK的出现可以使我们从容面对新的挑战。</p>
<ul>
<li>Logstash：负责日志的收集，处理和储存</li>
<li>Elasticsearch：负责日志检索和分析</li>
<li>Kibana：负责日志的可视化</li>
</ul>
<blockquote>
<p>ELK(Elasticsearch + Logstash + Kibana) </p>
</blockquote>
<hr>
<h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2019年07月02日 - 转载同事整理的ELK Stack进行重构<br>2015年08月31日 - 初稿</p>
<p>阅读原文 - <a href="https://wsgzao.github.io/post/elk/">https://wsgzao.github.io/post/elk/</a></p>
<p><strong>授权转载</strong></p>
<p><a target="_blank" rel="noopener" href="https://feiyang233.club/post/elk/">ELK 日志收集系统快速搭建</a></p>
<hr>
<h2 id="ELK简介"><a href="#ELK简介" class="headerlink" title="ELK简介"></a>ELK简介</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/index.html">ELK 官方文档</a> 是一个分布式、可扩展、实时的搜索与数据分析引擎。目前我在工作中只用来收集 server 的 log, 开发锅锅们 debug 的好助手。</p>
<h2 id="安装设置单节点-ELK"><a href="#安装设置单节点-ELK" class="headerlink" title="安装设置单节点 ELK"></a>安装设置单节点 ELK</h2><p>如果你想快速的搭建单节点 ELK, 那么使用 docker 方式肯定是你的最佳选择。使用三合一的镜像，<a target="_blank" rel="noopener" href="https://elk-docker.readthedocs.io/">文档详情</a><br>注意：安装完 docker, 记得设置 <code>mmap counts</code> 大小至少 262144<br><a target="_blank" rel="noopener" href="https://nieyong.github.io/wiki_cpu/mmap%E8%AF%A6%E8%A7%A3.html">什么是 mmap</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 mmap 命令</span></span><br><span class="line"><span class="comment"># 临时添加法</span></span><br><span class="line">sysctl -w vm.max_map_count=262144  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入 sysctl.conf 文件里</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">vm.max_map_count=262144  </span><br><span class="line"><span class="comment"># 保存好文件执行以下命令</span></span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 docker</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">sudo yum install -y docker-ce</span><br><span class="line"></span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>单节点的机器，不必暴露 9200(Elasticsearch JSON interface) 和 9300(Elasticsearch transport interface) 端口。<br>如果想在 docker 上暴露端口，用 -p 如果没有填写监听的地址，默认是 0.0.0.0 所有的网卡。建议还是写明确监听的地址，安全性更好。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-p 监听的IP:宿主机端口:容器内的端口</span><br><span class="line">-p 192.168.10.10:9300:9300</span><br></pre></td></tr></table></figure>

<h3 id="命令行启动一个-ELK"><a href="#命令行启动一个-ELK" class="headerlink" title="命令行启动一个 ELK"></a>命令行启动一个 ELK</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -p 5601:5601 -p 5044:5044 \</span><br><span class="line">-v /data/elk-data:/var/lib/elasticsearch  \</span><br><span class="line">-v /data/elk/logstash:/etc/logstash/conf.d  \</span><br><span class="line">-it -e TZ=<span class="string">&quot;Asia/Singapore&quot;</span> -e ES_HEAP_SIZE=<span class="string">&quot;20g&quot;</span>  \</span><br><span class="line">-e LS_HEAP_SIZE=<span class="string">&quot;10g&quot;</span> --name elk-ubuntu sebp/elk</span><br></pre></td></tr></table></figure>
<p>将配置和数据挂载出来，即使 docker container 出现了问题。可以立即销毁再重启一个，服务受影响的时间很短。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意挂载出来的文件夹的权限问题</span></span><br><span class="line"><span class="built_in">chmod</span> 755 /data/elk-data </span><br><span class="line"><span class="built_in">chmod</span> 755 /data/elk/logstash</span><br><span class="line"><span class="built_in">chown</span> -R root:root /data </span><br><span class="line">-v /data/elk-data:/var/lib/elasticsearch   <span class="comment"># 将 elasticsearch 存储的数据挂载出来，数据持久化。</span></span><br><span class="line">-v /data/elk/logstash:/etc/logstash/conf.d <span class="comment"># 将 logstash 的配置文件挂载出来，方便在宿主机上修改。</span></span><br></pre></td></tr></table></figure>
<h3 id="elasticsearch-重要的参数调优"><a href="#elasticsearch-重要的参数调优" class="headerlink" title="elasticsearch 重要的参数调优"></a>elasticsearch 重要的参数调优</h3><ol>
<li>ES_HEAP_SIZE Elasticsearch will assign the entire heap specified in jvm.options via the Xms (minimum heap size) and Xmx (maximum heap size) settings. You should set these two settings to be equal to each other. Set Xmx and Xms to no more than 50% of your physical RAM.the exact threshold varies but is near 32 GB. the exact threshold varies but 26 GB is safe on most systems, but can be as large as 30 GB on some systems.<br>利弊关系: The more heap available to Elasticsearch, the more memory it can use for its internal caches, but the less memory it leaves available for the operating system to use for the filesystem cache. Also, larger heaps can cause longer garbage collection pauses.</li>
<li>LS_HEAP_SIZE 如果 heap size 过低，会导致 CPU 利用率到达瓶颈，造成 JVM 不断的回收垃圾。 不能设置 heap size 超过物理内存。 至少留 1G 给操作系统和其他的进程。</li>
</ol>
<h3 id="只需要配置logstash"><a href="#只需要配置logstash" class="headerlink" title="只需要配置logstash"></a>只需要配置logstash</h3><p>接下来，我们再来看一看 logstash.conf 记得看注释<br>参考链接:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://documentation.wazuh.com/current/installation-guide/optional-configurations/elastic_ssl.html">SSL详情可参考</a></li>
<li><a target="_blank" rel="noopener" href="https://doc.yonyoucloud.com/doc/logstash-best-practice-cn/filter/grok.html">grok 正则捕获</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34021712/article/details/79746413">grok插件语法介绍</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ttlsa.com/elk/elk-logstash-configuration-syntax/">logstash 配置语法</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns">grok 内置 pattern</a>  </li>
<li><a target="_blank" rel="noopener" href="http://www.51niux.com/?id=205">Logstash详细记录</a></li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; <span class="number">5044</span></span><br><span class="line">    <span class="comment">#ssl =&gt; true</span></span><br><span class="line">    <span class="comment">#ssl_certificate =&gt; &quot;/etc/logstash/logstash.crt&quot;</span></span><br><span class="line">    <span class="comment">#ssl_key =&gt; &quot;/etc/logstash/logstash.key&quot;</span></span><br><span class="line"><span class="comment"># 1. SSL详情可参考 </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># filter 模块主要是数据预处理，提取一些信息，方便 elasticsearch 好归类存储。</span></span><br><span class="line"><span class="comment"># 2. grok 正则捕获</span></span><br><span class="line"><span class="comment"># 3. grok插件语法介绍 </span></span><br><span class="line"><span class="comment"># 4. logstash 配置语法 </span></span><br><span class="line"><span class="comment"># 5. grok 内置 pattern </span></span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;  </span><br><span class="line">      match =&gt; &#123;<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;EXIM_DATE:timestamp&#125;\|%&#123;LOGLEVEL:log_level&#125;\|%&#123;INT:pid&#125;\|%&#123;GREEDYDATA&#125;&quot;</span>&#125;</span><br><span class="line"><span class="comment"># message 字段是 log 的内容，例如 2018-12-11 23:46:47.051|DEBUG|3491|helper.py:85|helper._save_to_cache|shop_session</span></span><br><span class="line"><span class="comment"># 在这里我们提取出了 timestamp log_level pid，grok 有内置定义好的patterns: EXIM_DATE, EXIM_DATE, INT</span></span><br><span class="line"><span class="comment"># GREEDYDATA 贪婪数据，代表任意字符都可以匹配 </span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 我们在 filebeat 里面添加了这个字段[fields][function]的话，那就会执行对应的 match 规则去匹配 path</span></span><br><span class="line"><span class="comment"># source 字段就是 log 的来源路径，例如 /var/log/nginx/feiyang233.club.access.log</span></span><br><span class="line"><span class="comment"># match 后我们就可以得到 path=feiyang233.club.access</span></span><br><span class="line">    <span class="keyword">if</span> [fields][function]==<span class="string">&quot;nginx&quot;</span> &#123;</span><br><span class="line">        grok &#123;         </span><br><span class="line">        match =&gt; &#123;<span class="string">&quot;source&quot;</span> =&gt; <span class="string">&quot;/var/log/nginx/%&#123;GREEDYDATA:path&#125;.log%&#123;GREEDYDATA&#125;&quot;</span>&#125;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment"># 例如 ims 日志来源是 /var/log/ims_logic/debug.log</span></span><br><span class="line"><span class="comment"># match 后我们就可以得到 path=ims_logic</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> [fields][function]==<span class="string">&quot;ims&quot;</span> &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">        match =&gt; &#123;<span class="string">&quot;source&quot;</span> =&gt; <span class="string">&quot;/var/log/%&#123;GREEDYDATA:path&#125;/%&#123;GREEDYDATA&#125;&quot;</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">        match =&gt; &#123;<span class="string">&quot;source&quot;</span> =&gt; <span class="string">&quot;/var/log/app/%&#123;GREEDYDATA:path&#125;/%&#123;GREEDYDATA&#125;&quot;</span>&#125;</span><br><span class="line">            &#125;         </span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment"># filebeat 有定义 [fields][function] 时，我们就添加上这个字段，例如 QA</span></span><br><span class="line">    <span class="keyword">if</span> [fields][function] &#123;</span><br><span class="line">          mutate &#123;</span><br><span class="line">              add_field =&gt; &#123;</span><br><span class="line">                  <span class="string">&quot;function&quot;</span> =&gt; <span class="string">&quot;%&#123;[fields][function]&#125;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line"><span class="comment"># 因为线上的机器更多，线上的我默认不在 filebeat 添加 function，所以 else 我就添加上 live  </span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">          mutate &#123;</span><br><span class="line">              add_field =&gt; &#123;</span><br><span class="line">                  <span class="string">&quot;function&quot;</span> =&gt; <span class="string">&quot;live&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment"># 在之前 filter message 时，我们得到了 timestamp，这里我们修改一下格式，添加上时区。</span></span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [<span class="string">&quot;timestamp&quot;</span> , <span class="string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span>]</span><br><span class="line">      target =&gt; <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line">      timezone =&gt; <span class="string">&quot;Asia/Singapore&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 将之前获得的 path 替换其中的 / 替换为 - , 因为 elasticsearch index name 有要求</span></span><br><span class="line"><span class="comment"># 例如 feiyang/test  feiyang_test </span></span><br><span class="line">    mutate &#123;</span><br><span class="line">     gsub =&gt; [<span class="string">&quot;path&quot;</span>,<span class="string">&quot;/&quot;</span>,<span class="string">&quot;-&quot;</span>]</span><br><span class="line">      add_field =&gt; &#123;<span class="string">&quot;host_ip&quot;</span> =&gt; <span class="string">&quot;%&#123;[fields][host]&#125;&quot;</span>&#125;</span><br><span class="line">      remove_field =&gt; [<span class="string">&quot;tags&quot;</span>,<span class="string">&quot;@version&quot;</span>,<span class="string">&quot;offset&quot;</span>,<span class="string">&quot;beat&quot;</span>,<span class="string">&quot;fields&quot;</span>,<span class="string">&quot;exim_year&quot;</span>,<span class="string">&quot;exim_month&quot;</span>,<span class="string">&quot;exim_day&quot;</span>,<span class="string">&quot;exim_time&quot;</span>,<span class="string">&quot;timestamp&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># remove_field 去掉一些多余的字段</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 单节点 output 就在本机，也不需要 SSL, 但 index 的命名规则还是需要非常的注意</span></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">&quot;localhost:9200&quot;</span>]</span><br><span class="line">    index =&gt; <span class="string">&quot;sg-%&#123;function&#125;-%&#123;path&#125;-%&#123;+xxxx.ww&#125;&quot;</span></span><br><span class="line"><span class="comment"># sg-nginx-feiyang233.club.access-2019.13  ww代表周数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的流程图如下所示<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115737.png"><br>index 的规则 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/indices-create-index.html">参考链接</a></p>
<ul>
<li>Lowercase only</li>
<li>Cannot include , &#x2F;, *, ?, “, &lt;, &gt;, |, ` ` (space character), ,, #</li>
<li>Indices prior to 7.0 could contain a colon (:), but that’s been deprecated and won’t be supported in 7.0+</li>
<li>Cannot start with -, _, +</li>
<li>Cannot be . or ..</li>
<li>Cannot be longer than 255 bytes (note it is bytes, so multi-byte characters will count towards the 255 limit faster)</li>
</ul>
<h3 id="filebeat-配置"><a href="#filebeat-配置" class="headerlink" title="filebeat 配置"></a>filebeat 配置</h3><p>在 client 端，我们需要安装并且配置 filebeat <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html">请参考</a><br><a target="_blank" rel="noopener" href="https://www.imooc.com/article/70007">Filebeat 模块与配置</a><br>配置文件 filebeat.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span> <span class="comment"># 需要收集的日志</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/app/**</span>  <span class="comment">## ** need high versiob filebeat can support recursive</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fields:</span> <span class="comment">#需要添加的字段</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;inventory_hostname&#125;&#125;</span>&quot;</span> </span><br><span class="line">    <span class="attr">function:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line">  <span class="attr">multiline:</span>  <span class="comment"># 多行匹配</span></span><br><span class="line">    <span class="attr">match:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">negate:</span> <span class="literal">true</span>  <span class="comment"># pay attention the format</span></span><br><span class="line">    <span class="attr">pattern:</span> <span class="string">&#x27;^\[[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span>   <span class="comment">#\[</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">24h</span></span><br><span class="line">  <span class="attr">clean_inactive:</span> <span class="string">72h</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;<span class="template-variable">&#123;&#123;elk_server&#125;&#125;</span>:25044&quot;</span>]</span><br><span class="line">  <span class="comment"># ssl:</span></span><br><span class="line">  <span class="comment">#   certificate_authorities: [&quot;/etc/filebeat/logstash.crt&quot;]</span></span><br></pre></td></tr></table></figure>
<p>批量部署 filebeat.yml 最好使用 ansible</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stop</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">service:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">stopped</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">upload</span> <span class="string">filebeat.yml</span> </span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">     <span class="attr">src:</span> <span class="string">filebeat.yml</span></span><br><span class="line">     <span class="attr">dest:</span> <span class="string">/etc/filebeat/filebeat.yml</span></span><br><span class="line">     <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">     <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">     <span class="attr">mode:</span> <span class="number">0644</span>      </span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span></span><br><span class="line">    <span class="attr">file:</span> <span class="comment">#delete all files in this directory</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/lib/filebeat/registry</span>    </span><br><span class="line">      <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">service:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<h3 id="查看-filebeat-output"><a href="#查看-filebeat-output" class="headerlink" title="查看 filebeat output"></a>查看 filebeat output</h3><p>首先需要修改配置，将 filebeat 输出到本地的文件，输出的格式为 json.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">/var/log/app/**</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;x.x.x.x&quot;</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">&quot;sg&quot;</span></span><br><span class="line">  <span class="attr">multiline:</span></span><br><span class="line">    <span class="attr">match:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">negate:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">pattern:</span> <span class="string">&#x27;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">24h</span></span><br><span class="line">  <span class="attr">clean_inactive:</span> <span class="string">72h</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.file:</span></span><br><span class="line"> <span class="attr">path:</span> <span class="string">&quot;/home/feiyang&quot;</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">feiyang.json</span></span><br></pre></td></tr></table></figure>
<p>通过上述的配置，我们就可以在路径 &#x2F;home&#x2F;feiyang 下得到输出结果文件 feiyang.json 在这里需要注意的是，不同版本的 filebeat 输出结果的格式会有所不同，这会给 logstash 解析过滤造成一点点困难。下面举例说明 6.x 和 7.x filebeat 输出结果的不同</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-06-27T15:53:27.682Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.4.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x.x.x.x&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;region&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sg&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x.x.x.x&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x.x.x.x&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;feiyang-localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.4.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">1567983499</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[2019-06-27T22:53:25.756327232][Info][@http.go.177] [48552188]request&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/feiyang/scripts/all.log&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>6.4 与 7.2 还是有很大的差异，在结构上。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-06-27T15:41:42.991Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.2.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;agent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3a38567b-e6c3-4b5a-a420-f0dee3a3bec8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filebeat&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeral_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b7e3c0b7-b460-4e43-a9af-6d36c25eece7&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;feiyang-localhost&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">69132192</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/log/app/feiyang/scripts/info.log&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-06-27 22:41:25.312|WARNING|14186|Option|data|unrecognized|fields=set([u&#x27;id&#x27;])&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;region&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x.x.x.x&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;feiyang-localhost&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<h3 id="Kibana-简单的使用"><a href="#Kibana-简单的使用" class="headerlink" title="Kibana 简单的使用"></a>Kibana 简单的使用</h3><p>在搭建 ELK 时，暴露出来的 5601 端口就是 Kibana 的服务。<br>访问 <a target="_blank" rel="noopener" href="http://your_elk_ip:5601/">http://your_elk_ip:5601</a><br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115809.png"></p>
<h2 id="安装设置集群-ELK-版本-6-7"><a href="#安装设置集群-ELK-版本-6-7" class="headerlink" title="安装设置集群 ELK 版本 6.7"></a>安装设置集群 ELK 版本 6.7</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elastic-stack/current/installing-elastic-stack.html">ELK 安装文档</a>集群主要是高可用，多节点的 Elasticsearch 还可以扩容。本文中用的官方镜像 The base image is <a target="_blank" rel="noopener" href="https://hub.docker.com/_/centos/">centos:7</a></p>
<h3 id="Elasticsearch-多节点搭建"><a href="#Elasticsearch-多节点搭建" class="headerlink" title="Elasticsearch 多节点搭建"></a>Elasticsearch 多节点搭建</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/docker.html">官方安装文档 Elasticsearch</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载出来的文件夹权限非常的重要</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/elk-data &amp;&amp; <span class="built_in">chmod</span> 755 /data/elk-data</span><br><span class="line"><span class="built_in">chown</span> -R root:root /data </span><br><span class="line">docker run -p WAN_IP:9200:9200 -p 10.66.236.116:9300:9300 \</span><br><span class="line">-v /data/elk-data:/usr/share/elasticsearch/data \</span><br><span class="line">--name feiy_elk \</span><br><span class="line">docker.elastic.co/elasticsearch/elasticsearch:6.7.0</span><br></pre></td></tr></table></figure>
<p>接下来是修改配置文件 elasticsearch.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master 节点 node-1</span></span><br><span class="line"><span class="comment"># 进入容器 docker exec -it [container_id] bash</span></span><br><span class="line"><span class="comment"># docker exec -it 70ada825aae1 bash</span></span><br><span class="line"><span class="comment"># vi /usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">&quot;feiy_elk&quot;</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">10.66</span><span class="number">.236</span><span class="number">.116</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;10.66.236.116:9300&quot;</span>,<span class="string">&quot;10.66.236.118:9300&quot;</span>,<span class="string">&quot;10.66.236.115:9300&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"><span class="comment"># docker restart  70ada825aae1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slave 节点 node-2</span></span><br><span class="line"><span class="comment"># 进入容器 docker exec -it [container_id] bash</span></span><br><span class="line"><span class="comment"># vi /usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">&quot;feiy_elk&quot;</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-2</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">10.66</span><span class="number">.236</span><span class="number">.118</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;10.66.236.116:9300&quot;</span>,<span class="string">&quot;10.66.236.118:9300&quot;</span>,<span class="string">&quot;10.66.236.115:9300&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"><span class="comment"># docker restart  70ada825aae1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slave 节点 node-3</span></span><br><span class="line"><span class="comment"># 进入容器 docker exec -it [container_id] bash</span></span><br><span class="line"><span class="comment"># vi /usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">&quot;feiy_elk&quot;</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-3</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">10.66</span><span class="number">.236</span><span class="number">.115</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;10.66.236.116:9300&quot;</span>,<span class="string">&quot;10.66.236.118:9300&quot;</span>,<span class="string">&quot;10.66.236.115:9300&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"><span class="comment"># docker restart  70ada825aae1</span></span><br></pre></td></tr></table></figure>
<p>检查集群节点个数，状态等</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl http://wan_ip:9200/_cluster/health?pretty</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;feiy_elk&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span> : <span class="string">&quot;green&quot;</span>,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;number_of_nodes&quot;</span> : 3,</span><br><span class="line">  <span class="string">&quot;number_of_data_nodes&quot;</span> : 3,</span><br><span class="line">  <span class="string">&quot;active_primary_shards&quot;</span> : 9,</span><br><span class="line">  <span class="string">&quot;active_shards&quot;</span> : 18,</span><br><span class="line">  <span class="string">&quot;relocating_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;initializing_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;unassigned_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;delayed_unassigned_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;number_of_pending_tasks&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;number_of_in_flight_fetch&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;active_shards_percent_as_number&quot;</span> : 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终结果图在 kibana 上可以看到集群状态<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115910.png"></p>
<h3 id="Kibana-搭建"><a href="#Kibana-搭建" class="headerlink" title="Kibana 搭建"></a>Kibana 搭建</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/6.7/docker.html">官方安装文档  Kibana</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker run --link YOUR_ELASTICSEARCH_CONTAINER_NAME_OR_ID:elasticsearch -p 5601:5601 &#123;docker-repo&#125;:&#123;version&#125;</span></span><br><span class="line">docker run -p 外网IP:5601:5601 --<span class="built_in">link</span> elasticsearch容器的ID:elasticsearch docker.elastic.co/kibana/kibana:6.7.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意的是 --link 官方其实并不推荐的，推荐的是 use user-defined networks https://docs.docker.com/network/links/</span></span><br><span class="line"><span class="comment"># 测试不用 --link 也可以通。直接用容器的 IP</span></span><br><span class="line">docker run -p 外网IP:5601:5601  docker.elastic.co/kibana/kibana:6.7.0</span><br></pre></td></tr></table></figure>
<p>we recommend that you use user-defined networks to facilitate communication between two containers instead of using –<a target="_blank" rel="noopener" href="https://docs.docker.com/network/links/">link</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/share/kibana/config/kibana.yml</span></span><br><span class="line"><span class="comment"># 需要把 hosts IP 改为 elasticsearch 容器的 IP</span></span><br><span class="line"><span class="comment"># 我这里 elasticsearch 容器的 IP 是 172.17.0.2</span></span><br><span class="line"><span class="comment"># 如何查看 docker inspect elasticsearch_ID</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [ <span class="string">&quot;http://172.17.0.2:9200&quot;</span> ]</span><br><span class="line"><span class="attr">xpack.monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出容器并重启</span></span><br><span class="line"><span class="string">docker</span> <span class="string">restart</span> [<span class="string">container_ID</span>]</span><br></pre></td></tr></table></figure>
<h3 id="Logstash-搭建"><a href="#Logstash-搭建" class="headerlink" title="Logstash 搭建"></a>Logstash 搭建</h3><p>官方安装文档 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/6.7/docker.html">Logstash</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker -d 以后台的方式启动容器  --name 参数显式地为容器命名</span></span><br><span class="line">docker run -p 5044:5044 -d --name test_logstash  docker.elastic.co/logstash/logstash:6.7.0</span><br><span class="line"><span class="comment"># 也可以指定网卡，监听在内网或者外网 监听在内网 192.168.1.2</span></span><br><span class="line">docker run -p 192.168.1.2:5044:5044 -d --name test_logstash  docker.elastic.co/logstash/logstash:6.7.0</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/share/logstash/pipeline/logstash.conf</span></span><br><span class="line"><span class="comment"># 配置详情请参考下面的链接,记得 output hosts IP 指向 Elasticsearch 的 IP</span></span><br><span class="line"><span class="comment"># Elasticsearch 的默认端口是9200，在下面的配置中可以省略。</span></span><br><span class="line">hosts =&gt; [<span class="string">&quot;IP Address 1:port1&quot;</span>, <span class="string">&quot;IP Address 2:port2&quot;</span>, <span class="string">&quot;IP Address 3&quot;</span>]</span><br></pre></td></tr></table></figure>
<p><a href="#%E5%8F%AA%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AElogstash">logstash 过滤规则</a> 见上文的配置和 grok 语法规则</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/share/logstash/config/logstash.yml</span></span><br><span class="line"><span class="comment"># 需要把 url 改为 elasticsearch master 节点的 IP</span></span><br><span class="line"><span class="attr">http.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.url:</span> <span class="string">http://elasticsearch_master_IP:9200</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">&quot;feiy&quot;</span></span><br><span class="line"><span class="attr">pipeline.workers:</span> <span class="number">24</span> <span class="comment"># same with cores</span></span><br></pre></td></tr></table></figure>
<p>改完配置 exit 从容器里退出到宿主机，然后重启这个容器。更多配置详情，参见<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html">官方文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如何查看 container_ID</span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line">docker restart [container_ID]</span><br></pre></td></tr></table></figure>
<h3 id="容灾测试"><a href="#容灾测试" class="headerlink" title="容灾测试"></a>容灾测试</h3><p>我们把当前的 master 节点 node-1 关机，通过 kibana 看看集群的状态是怎样变化的。<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703115946.png"><br>当前集群的状态变成了黄色，因为还有 3 个 Unassigned Shards。颜色含义请参考<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_cluster_health.html">官方文档</a>，再过一会发现集群状态变成了绿色。<br><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190703120000.png"></p>
<h2 id="kibana-控制台-Console"><a href="#kibana-控制台-Console" class="headerlink" title="kibana 控制台 Console"></a>kibana 控制台 Console</h2><p><strong>Quick intro to the UI</strong><br>The Console UI is split into two panes: an editor pane (left) and a response pane (right). Use the editor to type requests and submit them to Elasticsearch. The results will be displayed in the response pane on the right side.  </p>
<p>Console understands requests in a compact format, similar to cURL:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index a doc</span></span><br><span class="line">PUT index/type/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;body&quot;</span>: <span class="string">&quot;here&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># and get it ...</span></span><br><span class="line">GET index/type/<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>While typing a request, Console will make suggestions which you can then accept by hitting Enter&#x2F;Tab. These suggestions are made based on the request structure as well as your indices and types.  </p>
<p><strong>A few quick tips, while I have your attention</strong>   </p>
<ul>
<li>Submit requests to ES using the green triangle button.</li>
<li>Use the wrench menu for other useful things.</li>
<li>You can paste requests in cURL format and they will be translated to the Console syntax.</li>
<li>You can resize the editor and output panes by dragging the separator between them.</li>
<li>Study the keyboard shortcuts under the Help button. Good stuff in there!</li>
</ul>
<h3 id="Console-常用的命令"><a href="#Console-常用的命令" class="headerlink" title="Console 常用的命令"></a>Console 常用的命令</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/kibana/current/console-kibana.html">Kibana 控制台</a><br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015654154">ELK技术栈中的那些查询语法</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_cat/health?v</span><br><span class="line"></span><br><span class="line">GET /_cat/nodes?v</span><br><span class="line"></span><br><span class="line">GET /_cluster/allocation/explain</span><br><span class="line"></span><br><span class="line">GET /_cluster/state</span><br><span class="line"></span><br><span class="line">GET /_cat/thread_pool?v</span><br><span class="line"></span><br><span class="line">GET /_cat/indices?health=red&amp;v</span><br><span class="line"></span><br><span class="line">GET /_cat/indices?v</span><br><span class="line"></span><br><span class="line">#将当前所有的 index 的 replicas 设置为 0</span><br><span class="line"></span><br><span class="line">PUT /*/_settings</span><br><span class="line">&#123;</span><br><span class="line">   &quot;index&quot; : &#123;</span><br><span class="line">       &quot;number_of_replicas&quot; : 0,</span><br><span class="line">       &quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_template</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在单节点的时候，不需要备份，所以将 replicas 设置为 0</span><br><span class="line">PUT _template/app-logstash</span><br><span class="line">&#123;</span><br><span class="line"> &quot;index_patterns&quot;: [&quot;app-*&quot;],</span><br><span class="line"> &quot;settings&quot;: &#123;</span><br><span class="line">   &quot;number_of_shards&quot;: 3,</span><br><span class="line">   &quot;number_of_replicas&quot;: 0,</span><br><span class="line">   &quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Elasticsearch-数据迁移"><a href="#Elasticsearch-数据迁移" class="headerlink" title="Elasticsearch 数据迁移"></a>Elasticsearch 数据迁移</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/cloud/current/ec-migrate-data.html">Elasticsearch 数据迁移官方文档</a>感觉不是很详细。容器化的数据迁移，我太菜用 reindex 失败了，snapshot 也凉凉。<br>最后是用一个开源工具 <a target="_blank" rel="noopener" href="https://github.com/medcl/esm-abandoned">An Elasticsearch Migration Tool</a> 进行数据迁移的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/medcl/esm-abandoned/releases/download/v0.4.2/linux64.tar.gz</span><br><span class="line">tar -xzvf linux64.tar.gz</span><br><span class="line">./esm  -s http://127.0.0.1:9200   -d http://192.168.21.55:9200 -x index_name  -w=5 -b=10 -c 10000 --copy_settings --copy_mappings --force  --refresh</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Nginx-代理转发"><a href="#Nginx-代理转发" class="headerlink" title="Nginx 代理转发"></a>Nginx 代理转发</h2><p>因为有时候 docker 重启，iptables restart 也会刷新，所以导致了我们的限制规则会被更改，出现安全问题。这是由于 docker 的网络隔离基于 iptable 实现造成的问题。为了避免这个安全问题，我们可以在启动 docker 时，就只监听在内网，或者本地 127.0.0.1 然后通过 nginx 转发。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># cat kibana.conf</span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen 25601;</span><br><span class="line">    server_name x.x.x.x;</span><br><span class="line">    access_log /var/log/nginx/kibana.access.log;</span><br><span class="line">    error_log /var/log/nginx/kibana.error.log;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        allow x.x.x.x;</span><br><span class="line">        allow x.x.x.x;</span><br><span class="line">        deny all;</span><br><span class="line"></span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_buffer_size 64k;</span><br><span class="line">        proxy_buffers   32 32k;</span><br><span class="line">        proxy_busy_buffers_size 128k;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">        proxy_pass    http://127.0.0.1:5601;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>! 这里需要注意的是， iptable filter 表 INPUT 链 有没有阻挡 172.17.0.0&#x2F;16  docker 默认的网段。是否阻挡了 25601 这个端口。</p>
<h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><ul>
<li>iptables 防不住。需要看<a href="/post/network/">上一篇博客</a>里的 iptable 问题。或者监听在内网，用 Nginx 代理转发。</li>
<li>elk <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html">网络问题</a> </li>
<li>elk <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/modules-node.html">node</a></li>
<li><code>discovery.type=single-node</code> 在测试单点时可用，搭建集群时不能设置这个环境变量，详情见<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/bootstrap-checks.html#single-node-discovery">官方文档</a></li>
<li>ELK的一次<a target="_blank" rel="noopener" href="https://www.leiyawu.com/2018/04/03/elk/">吞吐量优化</a></li>
<li>filebeat 版本过低导致 recursive glob patterns <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html#recursive_glob">**</a> 不可用<br>用 ansible 升级 filebeat<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">upload</span> <span class="string">filebeat.repo</span> </span><br><span class="line">    <span class="attr">copy:</span></span><br><span class="line">     <span class="attr">src:</span> <span class="string">elasticsearch.repo</span></span><br><span class="line">     <span class="attr">dest:</span> <span class="string">/etc/yum.repos.d/elasticsearch.repo</span></span><br><span class="line">     <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">     <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">     <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span> <span class="string">of</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">service:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># elasticsearch.repo</span></span><br><span class="line">[<span class="string">elasticsearch-6.x</span>]</span><br><span class="line"><span class="string">name=Elasticsearch</span> <span class="string">repository</span> <span class="string">for</span> <span class="number">6.</span><span class="string">x</span> <span class="string">packages</span></span><br><span class="line"><span class="string">baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">autorefresh=1</span></span><br><span class="line"><span class="string">type=rpm-md</span></span><br></pre></td></tr></table></figure></li>
<li>filebeat 7.x 与 6.x 不兼容问题. 关键字变化很大, 比如说 “sorce” 变为了 [log][file][path]</li>
</ul>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ol>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/column/4008">腾讯云Elasticsearch Service</a> 这个腾讯云的专栏非常的不错，请您一定要点开看一眼，总有你想要的。  </li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/along21/p/8613115.html">ELK重难点总结和整体优化配置</a></li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0-Study/">学习 | Study</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://wsgzao.github.io/post/elk/" data-title="使用ELK(Elasticsearch + Logstash + Kibana) 搭建日志集中分析平台实践 | HelloDog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/rps/" title="RPS和RFS网卡多队列性能调优实践">
  <strong>上一篇：</strong><br/>
  <span>
  RPS和RFS网卡多队列性能调优实践</span>
</a>
</div>


<div class="next">
<a href="/post/mpstat/"  title="mpstat使用介绍和输出参数详解">
 <strong>下一篇：</strong><br/> 
 <span>mpstat使用介绍和输出参数详解
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">更新记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELK%E7%AE%80%E4%BB%8B"><span class="toc-number">3.</span> <span class="toc-text">ELK简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%AE%BE%E7%BD%AE%E5%8D%95%E8%8A%82%E7%82%B9-ELK"><span class="toc-number">4.</span> <span class="toc-text">安装设置单节点 ELK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA-ELK"><span class="toc-number">4.1.</span> <span class="toc-text">命令行启动一个 ELK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#elasticsearch-%E9%87%8D%E8%A6%81%E7%9A%84%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98"><span class="toc-number">4.2.</span> <span class="toc-text">elasticsearch 重要的参数调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AElogstash"><span class="toc-number">4.3.</span> <span class="toc-text">只需要配置logstash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filebeat-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.</span> <span class="toc-text">filebeat 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-filebeat-output"><span class="toc-number">4.5.</span> <span class="toc-text">查看 filebeat output</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kibana-%E7%AE%80%E5%8D%95%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">4.6.</span> <span class="toc-text">Kibana 简单的使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%AE%BE%E7%BD%AE%E9%9B%86%E7%BE%A4-ELK-%E7%89%88%E6%9C%AC-6-7"><span class="toc-number">5.</span> <span class="toc-text">安装设置集群 ELK 版本 6.7</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch-%E5%A4%9A%E8%8A%82%E7%82%B9%E6%90%AD%E5%BB%BA"><span class="toc-number">5.1.</span> <span class="toc-text">Elasticsearch 多节点搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kibana-%E6%90%AD%E5%BB%BA"><span class="toc-number">5.2.</span> <span class="toc-text">Kibana 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash-%E6%90%AD%E5%BB%BA"><span class="toc-number">5.3.</span> <span class="toc-text">Logstash 搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E7%81%BE%E6%B5%8B%E8%AF%95"><span class="toc-number">5.4.</span> <span class="toc-text">容灾测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kibana-%E6%8E%A7%E5%88%B6%E5%8F%B0-Console"><span class="toc-number">6.</span> <span class="toc-text">kibana 控制台 Console</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Console-%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">6.1.</span> <span class="toc-text">Console 常用的命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elasticsearch-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">7.</span> <span class="toc-text">Elasticsearch 数据迁移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91"><span class="toc-number">8.</span> <span class="toc-text">Nginx 代理转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91"><span class="toc-number">9.</span> <span class="toc-text">踩过的坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">10.</span> <span class="toc-text">参考文章</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="wsgzao" data-theme="medium"></div>
<script type="text/javascript" src="//lab.lepture.com/github-cards/widget.js" ></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/学习-Study/" title="学习 | Study">学习 | Study<sup>197</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活-Life/" title="生活 | Life">生活 | Life<sup>32</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件-Soft/" title="软件 | Soft">软件 | Soft<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.linkedin.com/in/aowang" target="_blank" title="LinkedIn">LinkedIn</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, I&#39;m OX. This is my blog on GitHub. <br/>
			Keep Calm and Carry On.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/wsgzao" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/aowang" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="wsgzao">wsgzao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-3.6.4.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery-qrcode-0.18.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'wsgzao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-77732745-1', 'wsgzao.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c2c5fc7d844d0973d9f77abd87f49c3c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- swiftype Begin -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','_4qDmKrBPn9Es3UvQHT4','2.0.0');
</script>

<!-- swiftype End -->

  </body>
</html>
