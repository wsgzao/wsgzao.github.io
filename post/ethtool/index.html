
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    var host = "wsgzao.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LJ3PMGPVCK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LJ3PMGPVCK');
</script>
  
    <title>ethtool原理介绍和解决网卡丢包排查思路 | HelloDog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wsgzao">
    

    
    <meta name="description" content="ethtool原理介绍和解决网卡丢包排查思路">
<meta property="og:type" content="article">
<meta property="og:title" content="ethtool原理介绍和解决网卡丢包排查思路">
<meta property="og:url" content="https://wsgzao.github.io/post/ethtool/index.html">
<meta property="og:site_name" content="HelloDog">
<meta property="og:description" content="ethtool原理介绍和解决网卡丢包排查思路">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163040.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163052.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163113.png">
<meta property="article:published_time" content="2020-06-22T06:59:49.000Z">
<meta property="article:modified_time" content="2023-02-27T05:33:06.778Z">
<meta property="article:author" content="wsgzao">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163040.png">

    
    <link rel="alternative" href="/atom.xml" title="HelloDog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HelloDog" title="HelloDog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HelloDog">HelloDog</a></h1>
				<h2 class="blog-motto">Keep Calm and Carry On</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index/">索引 | Index</a></li>
					
						<li><a href="/archives/">归档 | Archives</a></li>
					
						<li><a href="/about/">简介 | About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/ethtool/" title="ethtool原理介绍和解决网卡丢包排查思路" itemprop="url">ethtool原理介绍和解决网卡丢包排查思路</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="wsgzao" target="_blank" itemprop="author">wsgzao</a>
		
  <p class="article-time">
    <time datetime="2020-06-22T06:59:49.000Z" itemprop="datePublished"> 发表于 2020-06-22</time>
    
  </p>
</header>
	<div class="article-content">
<!-- 		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%8E%86%E5%8F%B2"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ethtool%E7%AE%80%E4%BB%8B"><span class="toc-number">3.</span> <span class="toc-text">ethtool简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">了解接收数据包的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%BD%91%E5%8D%A1%E6%94%B6%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8C%85%E8%BD%AC%E7%A7%BB%E5%88%B0%E4%B8%BB%E6%9C%BA%E5%86%85%E5%AD%98%EF%BC%88NIC-%E4%B8%8E%E9%A9%B1%E5%8A%A8%E4%BA%A4%E4%BA%92%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">将网卡收到的数据包转移到主机内存（NIC 与驱动交互）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E5%A4%84%E7%90%86%EF%BC%88%E9%A9%B1%E5%8A%A8%E4%B8%8E-Linux-%E5%86%85%E6%A0%B8%E4%BA%A4%E4%BA%92%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">通知系统内核处理（驱动与 Linux 内核交互）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ifconfig%E8%A7%A3%E9%87%8A"><span class="toc-number">5.</span> <span class="toc-text">ifconfig解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">网卡工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85"><span class="toc-number">6.1.</span> <span class="toc-text">网卡收包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E5%8F%91%E5%8C%85"><span class="toc-number">6.2.</span> <span class="toc-text">网卡发包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">6.3.</span> <span class="toc-text">网卡中断处理函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E8%AE%BF%E9%97%AE"><span class="toc-number">6.4.</span> <span class="toc-text">缓冲区访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A2%E5%8C%85%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF"><span class="toc-number">7.</span> <span class="toc-text">丢包排查思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E6%9F%A5%E7%9C%8B%E7%A1%AC%E4%BB%B6%E6%83%85%E5%86%B5"><span class="toc-number">7.1.</span> <span class="toc-text">先查看硬件情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#overruns%E5%92%8Cbuffer-size"><span class="toc-number">7.2.</span> <span class="toc-text">overruns和buffer size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Red-Hat%E5%AE%98%E6%96%B9%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-number">7.3.</span> <span class="toc-text">Red Hat官方解决思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ethtool%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">8.</span> <span class="toc-text">ethtool常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">9.</span> <span class="toc-text">参考文章</span></a></li></ol>
		
		</div>
		 -->
		<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前记录过处理因为LVS网卡流量负载过高导致软中断发生丢包的问题，<a href="https://wsgzao.github.io/post/rps/">RPS和RFS网卡多队列性能调优实践</a>，对一般人来说压力不大的情况下其实碰见的概率并不高。这次想分享的话题是比较常见服务器网卡丢包现象排查思路，如果你是想了解点对点的丢包解决思路涉及面可能就比较广，不妨先参考之前的文章<a href="https://wsgzao.github.io/post/mtr/">如何使用MTR诊断网络问题</a>，对于Linux常用的网卡丢包分析工具自然是ethtool。</p>
<h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2020年06月22日 - 初稿</p>
<p>阅读原文 - <a href="https://wsgzao.github.io/post/ethtool/">https://wsgzao.github.io/post/ethtool/</a></p>
<hr>
<h2 id="ethtool简介"><a href="#ethtool简介" class="headerlink" title="ethtool简介"></a>ethtool简介</h2><p>ethtool - utility for controlling network drivers and hardware</p>
<p>ethtool is the standard Linux utility for controlling network drivers and hardware, particularly for wired Ethernet devices. It can be used to:</p>
<ul>
<li>Get identification and diagnostic information</li>
<li>Get extended device statistics</li>
<li>Control speed, duplex, autonegotiation and flow control for Ethernet devices</li>
<li>Control checksum offload and other hardware offload features</li>
<li>Control DMA ring sizes and interrupt moderation</li>
<li>Control receive queue selection for multiqueue devices</li>
<li>Upgrade firmware in flash memory</li>
</ul>
<p>Most features are dependent on support in the specific driver. See the manual page for full information.</p>
<p>ethtool 用于查看和修改网络设备（尤其是有线以太网设备）的驱动参数和硬件设置。你可以根据需要更改以太网卡的参数，包括自动协商、速度、双工和局域网唤醒等参数。通过对以太网卡的配置，你的计算机可以通过网络有效地进行通信。该工具提供了许多关于接驳到你的 Linux 系统的以太网设备的信息。</p>
<h2 id="了解接收数据包的流程"><a href="#了解接收数据包的流程" class="headerlink" title="了解接收数据包的流程"></a>了解接收数据包的流程</h2><blockquote>
<p>这里摘取了美团技术团队的分析，在此表示感谢</p>
</blockquote>
<p>接收数据包是一个复杂的过程，涉及很多底层的技术细节，但大致需要以下几个步骤：</p>
<ol>
<li>网卡收到数据包。</li>
<li>将数据包从网卡硬件缓存转移到服务器内存中。</li>
<li>通知内核处理。</li>
<li>经过 TCP&#x2F;IP 协议逐层处理。</li>
<li>应用程序通过 <code>read()</code> 从 <code>socket buffer</code> 读取数据。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163040.png"></p>
<h3 id="将网卡收到的数据包转移到主机内存（NIC-与驱动交互）"><a href="#将网卡收到的数据包转移到主机内存（NIC-与驱动交互）" class="headerlink" title="将网卡收到的数据包转移到主机内存（NIC 与驱动交互）"></a>将网卡收到的数据包转移到主机内存（NIC 与驱动交互）</h3><p>NIC 在接收到数据包之后，首先需要将数据同步到内核中，这中间的桥梁是 <code>rx ring buffer</code>。它是由 NIC 和驱动程序共享的一片区域，事实上，<code>rx ring buffer</code> 存储的并不是实际的 packet 数据，而是一个描述符，这个描述符指向了它真正的存储地址，具体流程如下：</p>
<ol>
<li>驱动在内存中分配一片缓冲区用来接收数据包，叫做 <code>sk_buffer</code>；</li>
<li>将上述缓冲区的地址和大小（即接收描述符），加入到 <code>rx ring buffer</code>。描述符中的缓冲区地址是 DMA 使用的物理地址；</li>
<li>驱动通知网卡有一个新的描述符；</li>
<li>网卡从 <code>rx ring buffer</code> 中取出描述符，从而获知缓冲区的地址和大小；</li>
<li>网卡收到新的数据包；</li>
<li>网卡将新数据包通过 DMA 直接写到 <code>sk_buffer</code> 中。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163052.png"></p>
<p>当驱动处理速度跟不上网卡收包速度时，驱动来不及分配缓冲区，NIC 接收到的数据包无法及时写到 <code>sk_buffer</code>，就会产生堆积，当 NIC 内部缓冲区写满后，就会丢弃部分数据，引起丢包。这部分丢包为 <code>rx_fifo_errors</code>，在 <code>/proc/net/dev</code> 中体现为 fifo 字段增长，在 ifconfig 中体现为 overruns 指标增长。</p>
<h3 id="通知系统内核处理（驱动与-Linux-内核交互）"><a href="#通知系统内核处理（驱动与-Linux-内核交互）" class="headerlink" title="通知系统内核处理（驱动与 Linux 内核交互）"></a>通知系统内核处理（驱动与 Linux 内核交互）</h3><p>这个时候，数据包已经被转移到了 <code>sk_buffer</code> 中。前文提到，这是驱动程序在内存中分配的一片缓冲区，并且是通过 DMA 写入的，这种方式不依赖 CPU 直接将数据写到了内存中，意味着对内核来说，其实并不知道已经有新数据到了内存中。那么如何让内核知道有新数据进来了呢？答案就是中断，通过中断告诉内核有新数据进来了，并需要进行后续处理。</p>
<p>提到中断，就涉及到硬中断和软中断，首先需要简单了解一下它们的区别：</p>
<ul>
<li>硬中断： 由硬件自己生成，具有随机性，硬中断被 CPU 接收后，触发执行中断处理程序。中断处理程序只会处理关键性的、短时间内可以处理完的工作，剩余耗时较长工作，会放到中断之后，由软中断来完成。硬中断也被称为上半部分。</li>
<li>软中断： 由硬中断对应的中断处理程序生成，往往是预先在代码里实现好的，不具有随机性。（除此之外，也有应用程序触发的软中断，与本文讨论的网卡收包无关。）也被称为下半部分。</li>
</ul>
<p><strong>当 NIC 把数据包通过 DMA 复制到内核缓冲区 <code>sk_buffer</code> 后，NIC 立即发起一个硬件中断。CPU 接收后，首先进入上半部分，网卡中断对应的中断处理程序是网卡驱动程序的一部分，之后由它发起软中断，进入下半部分，开始消费 <code>sk_buffer</code> 中的数据，交给内核协议栈处理。</strong></p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20190704163113.png"></p>
<p>通过中断，能够快速及时地响应网卡数据请求，但如果数据量大，那么会产生大量中断请求，CPU 大部分时间都忙于处理中断，效率很低。为了解决这个问题，现在的内核及驱动都采用一种叫 NAPI（new API）的方式进行数据处理，其原理可以简单理解为 中断 + 轮询，在数据量大时，一次中断后通过轮询接收一定数量包再返回，避免产生多次中断。</p>
<h2 id="ifconfig解释"><a href="#ifconfig解释" class="headerlink" title="ifconfig解释"></a>ifconfig解释</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ifconfig eth0</span></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500</span><br><span class="line">inet 192.168.1.135 netmask 255.255.255.0 broadcast 192.168.1.255</span><br><span class="line">inet6 fe80::20c:29ff:fe9b:52d3 prefixlen 64 scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">ether 00:0c:29:9b:52:d3 txqueuelen 1000 (Ethernet)</span><br><span class="line">RX packets 833 bytes 61846 (60.3 KiB)</span><br><span class="line">RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">TX packets 122 bytes 9028 (8.8 KiB)</span><br><span class="line">TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br></pre></td></tr></table></figure>

<p>(1) RX errors</p>
<p>表示总的收包的错误数量，这包括 too-long-frames 错误，Ring Buffer 溢出错误，crc 校验错误，帧同步错误，fifo overruns 以及 missed pkg 等等。</p>
<p>(2) RX dropped</p>
<p>表示数据包已经进入了 Ring Buffer，但是由于内存不够等系统原因，导致在拷贝到内存的过程中被丢弃。</p>
<p>(3) RX overruns</p>
<p>表示了 fifo 的 overruns，这是由于 Ring Buffer(aka Driver Queue) 传输的 IO 大于 kernel 能够处理的 IO 导致的，而 Ring Buffer 则是指在发起 IRQ 请求之前的那块 buffer。很明显，overruns 的增大意味着数据包没到 Ring Buffer 就被网卡物理层给丢弃了，而 CPU 无法即使的处理中断是造成 Ring Buffer 满的原因之一，上面那台有问题的机器就是因为 interruprs 分布的不均匀(都压在 core0)，没有做 affinity 而造成的丢包。</p>
<p>(4) RX frame</p>
<p>表示 misaligned 的 frames。</p>
<h2 id="网卡工作原理"><a href="#网卡工作原理" class="headerlink" title="网卡工作原理"></a>网卡工作原理</h2><p> </p>
<blockquote>
<p>如果上面接收数据包的流程觉得不够详细可以再看纯文字解释</p>
</blockquote>
<h3 id="网卡收包"><a href="#网卡收包" class="headerlink" title="网卡收包"></a>网卡收包</h3><p>网线上的packet首先被网卡获取，网卡会检查packet的CRC校验，保证完整性，然后将packet头去掉，得到frame。网卡会检查MAC包内的目的MAC地址，如果和本网卡的MAC地址不一样则丢弃(混杂模式除外)。</p>
<p>网卡将frame拷贝到网卡内部的FIFO缓冲区，触发硬件中断。（如有ring buffer的网卡，好像frame可以先存在ring buffer里再触发软件中断（下篇文章将详细解释Linux中frame的走向），ring buffer是网卡和驱动程序共享，是设备里的内存，但是对操作系统是可见的，因为看到linux内核源码里网卡驱动程序是使用kcalloc来分配的空间，所以ring buffer一般都有上限，另外这个ring buffer size，表示的应该是能存储的frame的个数，而不是字节大小。另外有些系统的 ethtool 命令 并不能改变ring parameters来设置ring buffer的大小，暂时不知道为什么，可能是驱动不支持。）</p>
<p>网卡驱动程序通过硬中断处理函数，构建sk_buff，把frame从网卡FIFO拷贝到内存skb中，接下来交给内核处理。（支持napi的网卡应该是直接放在ring buffer，不触发硬中断，直接使用软中断，拷贝ring buffer里的数据，直接输送给上层处理，每个网卡在一次软中断处理过程能处理weight个frame）</p>
<p>过程中，网卡芯片对frame进行了MAC过滤，以减小系统负荷。（除了混杂模式）</p>
<h3 id="网卡发包"><a href="#网卡发包" class="headerlink" title="网卡发包"></a>网卡发包</h3><p>网卡驱动程序将IP包添加14字节的MAC头，构成frame（暂无CRC）。Frame（暂无CRC）中含有发送端和接收端的MAC地址，由于是驱动程序创建MAC头，所以可以随便输入地址，也可以进行主机伪装。</p>
<p>驱动程序将frame（暂无CRC）拷贝到网卡芯片内部的缓冲区，由网卡处理。</p>
<p>网卡芯片将未完全完成的frame（缺CRC）再次封装为可以发送的packet，也就是添加头部同步信息和CRC校验，然后丢到网线上，就完成一个IP报的发送了，所有接到网线上的网卡都可以看到该packet。</p>
<h3 id="网卡中断处理函数"><a href="#网卡中断处理函数" class="headerlink" title="网卡中断处理函数"></a>网卡中断处理函数</h3><p> <br>产生中断的每个设备都有一个相应的中断处理程序，是设备驱动程序的一部分。每个网卡都有一个中断处理程序，用于通知网卡该中断已经被接收了，以及把网卡缓冲区的数据包拷贝到内存中。</p>
<p>当网卡接收来自网络的数据包时，需要通知内核数据包到了。网卡立即发出中断。内核通过执行网卡已注册的中断处理函数来做出应答。中断处理程序开始执行，通知硬件，拷贝最新的网络数据包到内存，然后读取网卡更多的数据包。</p>
<p>这些都是重要、紧迫而又与硬件相关的工作。内核通常需要快速的拷贝网络数据包到系统内存，因为网卡上接收网络数据包的缓存大小固定，而且相比系统内存也要小得多。所以上述拷贝动作一旦被延迟，必然造成网卡FIFO缓存溢出 - 进入的数据包占满了网卡的缓存，后续的包只能被丢弃，这也应该就是ifconfig里的overrun的来源。</p>
<p>当网络数据包被拷贝到系统内存后，中断的任务算是完成了，这时它把控制权交还给被系统中断前运行的程序。</p>
<h3 id="缓冲区访问"><a href="#缓冲区访问" class="headerlink" title="缓冲区访问"></a>缓冲区访问</h3><p>网卡的内核缓冲区，是在PC内存中，由内核控制，而网卡会有FIFO缓冲区，或者ring buffer，这应该将两者区分开。FIFO比较小，里面有数据便会尽量将数据存在内核缓冲中。</p>
<p>网卡中的缓冲区既不属于内核空间，也不属于用户空间。它属于硬件缓冲，允许网卡与操作系统之间有个缓冲；</p>
<p>内核缓冲区在内核空间，在内存中，用于内核程序，做为读自或写往硬件的数据缓冲区；</p>
<p>用户缓冲区在用户空间，在内存中，用于用户程序，做为读自或写往硬件的数据缓冲区；</p>
<p>另外，为了加快数据的交互，可以将内核缓冲区映射到用户空间，这样，内核程序和用户程序就可以同时访问这一区间了。</p>
<p>对于有ring buffer的网卡，ring buffer是由驱动与网卡共享的，所以内核可以直接访问ring buffer，一般拷贝frames的副本到自己的内核空间进行处理（deliver到上层协议，之后的一个个skb就是按skb的指针传递方式传递，直到用户获得数据，所以，对于ring buffer网卡，大量拷贝发生在frame从ring buffer传递到内核控制的计算机内存里）。</p>
<h2 id="丢包排查思路"><a href="#丢包排查思路" class="headerlink" title="丢包排查思路"></a>丢包排查思路</h2><p>网卡工作在数据链路层，数据量链路层，会做一些校验，封装成帧。我们可以查看校验是否出错，确定传输是否存在问题。然后从软件层面，是否因为缓冲区太小丢包。</p>
<h3 id="先查看硬件情况"><a href="#先查看硬件情况" class="headerlink" title="先查看硬件情况"></a>先查看硬件情况</h3><p>一台机器经常收到丢包的报警，先看看最底层的有没有问题:</p>
<p>(1) 查看工作模式是否正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ethtool eth0 | egrep &#x27;Speed|Duplex&#x27;</span><br><span class="line">Speed: 1000Mb/s</span><br><span class="line">Duplex: Full</span><br></pre></td></tr></table></figure>

<p>(2) 查看检验是否正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ethtool -S eth0 | grep crc</span><br><span class="line">rx_crc_errors: 0</span><br></pre></td></tr></table></figure>

<p>Speed，Duplex，CRC 之类的都没问题，基本可以排除物理层面的干扰。</p>
<h3 id="overruns和buffer-size"><a href="#overruns和buffer-size" class="headerlink" title="overruns和buffer size"></a>overruns和buffer size</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 ifconfig 可以看到 overruns 是否一直增大</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">seq</span> 1 100`; <span class="keyword">do</span> ifconfig eth2 | grep RX | grep overruns; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"><span class="comment"># 这里一直增加</span></span><br><span class="line">RX packets:346547657 errors:0 dropped:0 overruns:35345 frame:0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以通过ethtool来修改网卡的buffer size ，首先要网卡支持，我的服务器是是INTEL 的1000M网卡,我们看看ethtool说明 </span></span><br><span class="line">-g   –show-ringQueries the specified ethernet device <span class="keyword">for</span> rx/tx ring parameter information.</span><br><span class="line">-G   –set-ringChanges the rx/tx ring parameters of the specified ethernet device.</span><br><span class="line"><span class="comment"># 查看当前网卡的buffer size情况</span></span><br><span class="line">ethtool -g eth0</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># ethtool -g eth0</span></span><br><span class="line">Ring parameters <span class="keyword">for</span> eth0:</span><br><span class="line">Pre-<span class="built_in">set</span> maximums:</span><br><span class="line">RX: 4096</span><br><span class="line">RX Mini: 0</span><br><span class="line">RX Jumbo: 0</span><br><span class="line">TX: 4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX: 256</span><br><span class="line">RX Mini: 0</span><br><span class="line">RX Jumbo: 0</span><br><span class="line">TX: 256</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改buffer size大小</span></span><br><span class="line">ethtool -G eth0 rx 2048</span><br><span class="line">ethtool -G eth0 tx 2048</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># ethtool -G eth0 rx 2048</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ethtool -G eth0 tx 2048</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ethtool -g eth0</span></span><br><span class="line">Ring parameters <span class="keyword">for</span> eth0:</span><br><span class="line">Pre-<span class="built_in">set</span> maximums:</span><br><span class="line">RX: 4096</span><br><span class="line">RX Mini: 0</span><br><span class="line">RX Jumbo: 0</span><br><span class="line">TX: 4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX: 2048</span><br><span class="line">RX Mini: 0</span><br><span class="line">RX Jumbo: 0</span><br><span class="line">TX: 2048</span><br></pre></td></tr></table></figure>

<h3 id="Red-Hat官方解决思路"><a href="#Red-Hat官方解决思路" class="headerlink" title="Red Hat官方解决思路"></a>Red Hat官方解决思路</h3><blockquote>
<p>Issue</p>
</blockquote>
<p>Why <code>rx_crc_errors</code> incrementing in the receive counter of <code>ethtool -S</code> output?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S &lt;Interface_name&gt; | grep -i error</span><br><span class="line">     rx_error_bytes: 0</span><br><span class="line">     tx_error_bytes: 0</span><br><span class="line">     tx_mac_errors: 0</span><br><span class="line">     tx_carrier_errors: 0</span><br><span class="line">     rx_crc_errors: 9244</span><br><span class="line">     rx_align_errors: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Resolution</p>
</blockquote>
<ol>
<li>Change the cable.</li>
<li>Check switch configuration.</li>
<li>Change the network interface card.</li>
</ol>
<blockquote>
<p>Root Cause</p>
</blockquote>
<ol>
<li>Most of the time incrementing the value of <code>rx_crc_errors</code> means the problem is in <code>Layer-1</code> of the networking model.</li>
<li>When a packet is received at the interface, it goes through a data integrity check which is called <code>cyclic redundancy check</code>. If the packet fails in that check, it is marked as <code>rx_crc_errors</code>.</li>
<li>The switch was forcing the <code>NIC</code> to operate in <code>half-duplex</code> mode. Fixing the switch to tell the <code>NIC</code> to operate in <code>full-duplex</code> mode have resolved the issue.</li>
</ol>
<blockquote>
<p>Diagnostic Steps</p>
</blockquote>
<p>Check <code>ethtool -S</code> output and find where are the drops and errors.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -S &lt;Interface_name&gt; | grep -i error</span><br><span class="line">     rx_error_bytes: 0</span><br><span class="line">     tx_error_bytes: 0</span><br><span class="line">     tx_mac_errors: 0</span><br><span class="line">     tx_carrier_errors: 0</span><br><span class="line">     rx_crc_errors: 9244  &gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">     rx_align_errors: 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Check the numbers corresponding to <code>rx_crc_errors</code>.</p>
<h2 id="ethtool常用命令"><a href="#ethtool常用命令" class="headerlink" title="ethtool常用命令"></a>ethtool常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ethtool p1p1</span><br><span class="line"></span><br><span class="line">Settings <span class="keyword">for</span> p1p1:</span><br><span class="line">	Supported ports: [ FIBRE ]</span><br><span class="line">	Supported <span class="built_in">link</span> modes:   10000baseT/Full</span><br><span class="line">	Supported pause frame use: Symmetric</span><br><span class="line">	Supports auto-negotiation: No</span><br><span class="line">	Supported FEC modes: Not reported</span><br><span class="line">	Advertised <span class="built_in">link</span> modes:  10000baseT/Full</span><br><span class="line">	Advertised pause frame use: Symmetric</span><br><span class="line">	Advertised auto-negotiation: No</span><br><span class="line">	Advertised FEC modes: Not reported</span><br><span class="line">	Speed: 10000Mb/s</span><br><span class="line">	Duplex: Full</span><br><span class="line">	Port: FIBRE</span><br><span class="line">	PHYAD: 0</span><br><span class="line">	Transceiver: internal</span><br><span class="line">	Auto-negotiation: off</span><br><span class="line">	Supports Wake-on: d</span><br><span class="line">	Wake-on: d</span><br><span class="line">	Current message level: 0x00000007 (7)</span><br><span class="line">			       drv probe <span class="built_in">link</span></span><br><span class="line">	Link detected: <span class="built_in">yes</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>显示了p1p1 的接口类型，连接模式，速率等等信息，以及当前是否连接了网线（如果是网线Supported ports 就是TP，如果是光纤则显示Fiber），这里例举下3个重要关键词</p>
<p>Supported ports: [ FIBRE ]<br>Speed: 10000Mb&#x2F;s<br>Link detected: yes</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -S 显示NIC- and driver-specific 的统计参数，如网卡接收/发送的字节数、接收/发送的广播包个数等。 </span></span><br><span class="line">ethtool -S p1p1 | grep -i error</span><br><span class="line">     rx_errors: 0</span><br><span class="line">     tx_errors: 0</span><br><span class="line">     rx_over_errors: 0</span><br><span class="line">     rx_crc_errors: 0</span><br><span class="line">     rx_frame_errors: 0</span><br><span class="line">     rx_fifo_errors: 0</span><br><span class="line">     rx_missed_errors: 0</span><br><span class="line">     tx_aborted_errors: 0</span><br><span class="line">     tx_carrier_errors: 0</span><br><span class="line">     tx_fifo_errors: 0</span><br><span class="line">     tx_heartbeat_errors: 0</span><br><span class="line">     rx_length_errors: 0</span><br><span class="line">     rx_long_length_errors: 0</span><br><span class="line">     rx_short_length_errors: 0</span><br><span class="line">     rx_csum_offload_errors: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -p 用于区别不同ethX对应网卡的物理位置，常用的方法是使网卡port上的led不断的闪</span></span><br><span class="line">ethtool -p &lt;Interface_name&gt;</span><br><span class="line">ethtool -p eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># -i 显示网卡驱动的信息，如驱动的名称、版本等</span></span><br><span class="line">ethtool -i p1p1</span><br><span class="line"></span><br><span class="line">driver: ixgbe</span><br><span class="line">version: 5.1.0-k-rh7.6</span><br><span class="line">firmware-version: 0x80000960, 18.3.6</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:04:00.0</span><br><span class="line">supports-statistics: <span class="built_in">yes</span></span><br><span class="line">supports-test: <span class="built_in">yes</span></span><br><span class="line">supports-eeprom-access: <span class="built_in">yes</span></span><br><span class="line">supports-register-dump: <span class="built_in">yes</span></span><br><span class="line">supports-priv-flags: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ethtool –s ethX [speed 10|100|1000] [duplex half|full]  [autoneg on|off]</span></span><br><span class="line"><span class="comment"># 设置网口速率10/100/1000M、设置网口半/全双工、设置网口是否自协商</span></span><br><span class="line">ethtool -s eth0 speed 100   </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/software/network/ethtool/">ethtool</a></p>
<p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/counters-troubleshooting-for-linux-driver">Counters Troubleshooting for Linux Driver</a></p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/154543">Why do I see rx_crc_errors in ethtool output?</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011857683/article/details/83663316">ping请求错误分析</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011857683/article/details/83758503">ifconfig 命令详解</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011857683/article/details/83758689">ethtool 命令详解</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011857683/article/details/83758869">ethtool 解决网卡丢包严重和网卡原理</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0-Study/">学习 | Study</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://wsgzao.github.io/post/ethtool/" data-title="ethtool原理介绍和解决网卡丢包排查思路 | HelloDog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/kubernetes/" title="Kubernetes学习路径">
  <strong>上一篇：</strong><br/>
  <span>
  Kubernetes学习路径</span>
</a>
</div>


<div class="next">
<a href="/post/ansible/"  title="Ansible学习路径">
 <strong>下一篇：</strong><br/> 
 <span>Ansible学习路径
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%8E%86%E5%8F%B2"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ethtool%E7%AE%80%E4%BB%8B"><span class="toc-number">3.</span> <span class="toc-text">ethtool简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">了解接收数据包的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%BD%91%E5%8D%A1%E6%94%B6%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8C%85%E8%BD%AC%E7%A7%BB%E5%88%B0%E4%B8%BB%E6%9C%BA%E5%86%85%E5%AD%98%EF%BC%88NIC-%E4%B8%8E%E9%A9%B1%E5%8A%A8%E4%BA%A4%E4%BA%92%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">将网卡收到的数据包转移到主机内存（NIC 与驱动交互）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E5%A4%84%E7%90%86%EF%BC%88%E9%A9%B1%E5%8A%A8%E4%B8%8E-Linux-%E5%86%85%E6%A0%B8%E4%BA%A4%E4%BA%92%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">通知系统内核处理（驱动与 Linux 内核交互）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ifconfig%E8%A7%A3%E9%87%8A"><span class="toc-number">5.</span> <span class="toc-text">ifconfig解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">网卡工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85"><span class="toc-number">6.1.</span> <span class="toc-text">网卡收包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E5%8F%91%E5%8C%85"><span class="toc-number">6.2.</span> <span class="toc-text">网卡发包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%8D%A1%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">6.3.</span> <span class="toc-text">网卡中断处理函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E8%AE%BF%E9%97%AE"><span class="toc-number">6.4.</span> <span class="toc-text">缓冲区访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A2%E5%8C%85%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF"><span class="toc-number">7.</span> <span class="toc-text">丢包排查思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E6%9F%A5%E7%9C%8B%E7%A1%AC%E4%BB%B6%E6%83%85%E5%86%B5"><span class="toc-number">7.1.</span> <span class="toc-text">先查看硬件情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#overruns%E5%92%8Cbuffer-size"><span class="toc-number">7.2.</span> <span class="toc-text">overruns和buffer size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Red-Hat%E5%AE%98%E6%96%B9%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-number">7.3.</span> <span class="toc-text">Red Hat官方解决思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ethtool%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">8.</span> <span class="toc-text">ethtool常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">9.</span> <span class="toc-text">参考文章</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="wsgzao" data-theme="medium"></div>
<script type="text/javascript" src="//lab.lepture.com/github-cards/widget.js" ></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/学习-Study/" title="学习 | Study">学习 | Study<sup>195</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活-Life/" title="生活 | Life">生活 | Life<sup>29</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件-Soft/" title="软件 | Soft">软件 | Soft<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.linkedin.com/in/aowang" target="_blank" title="LinkedIn">LinkedIn</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, I&#39;m OX. This is my blog on GitHub. <br/>
			Keep Calm and Carry On.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/wsgzao" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/aowang" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2024 
		
		<a href="/about" target="_blank" title="wsgzao">wsgzao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-3.6.4.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery-qrcode-0.18.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'wsgzao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-77732745-1', 'wsgzao.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c2c5fc7d844d0973d9f77abd87f49c3c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- swiftype Begin -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','_4qDmKrBPn9Es3UvQHT4','2.0.0');
</script>

<!-- swiftype End -->

  </body>
</html>
