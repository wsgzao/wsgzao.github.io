
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    var host = "wsgzao.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LJ3PMGPVCK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LJ3PMGPVCK');
</script>
  
    <title>使用 certbot 代替 acme.sh 免费申请 wildcard 通配符证书和自动更新实践小结 | HelloDog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wsgzao">
    

    
    <meta name="description" content="使用certbot代替acme.sh免费申请wildcard通配符证书和自动更新实践小结">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 certbot 代替 acme.sh 免费申请 wildcard 通配符证书和自动更新实践小结">
<meta property="og:url" content="https://wsgzao.github.io/post/certbot/index.html">
<meta property="og:site_name" content="HelloDog">
<meta property="og:description" content="使用certbot代替acme.sh免费申请wildcard通配符证书和自动更新实践小结">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200219171300.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200220153747.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200220153532.png">
<meta property="og:updated_time" content="2020-04-29T07:07:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 certbot 代替 acme.sh 免费申请 wildcard 通配符证书和自动更新实践小结">
<meta name="twitter:description" content="使用certbot代替acme.sh免费申请wildcard通配符证书和自动更新实践小结">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200219171300.png">

    
    <link rel="alternative" href="/atom.xml" title="HelloDog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HelloDog" title="HelloDog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HelloDog">HelloDog</a></h1>
				<h2 class="blog-motto">Keep Calm and Carry On</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index/">索引 | Index</a></li>
					
						<li><a href="/archives/">归档 | Archives</a></li>
					
						<li><a href="/about/">简介 | About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/certbot/" title="使用 certbot 代替 acme.sh 免费申请 wildcard 通配符证书和自动更新实践小结" itemprop="url">使用 certbot 代替 acme.sh 免费申请 wildcard 通配符证书和自动更新实践小结</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="wsgzao" target="_blank" itemprop="author">wsgzao</a>
		
  <p class="article-time">
    <time datetime="2020-04-13T06:59:49.000Z" itemprop="datePublished"> 发表于 2020-04-13</time>
    
  </p>
</header>
	<div class="article-content">
<!-- 		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新历史"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础知识"><span class="toc-number">3.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于-HTTPS"><span class="toc-number">3.1.</span> <span class="toc-text">关于 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-和-HTTPS-区别"><span class="toc-number">3.2.</span> <span class="toc-text">HTTP 和 HTTPS 区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于-TLS-SSL"><span class="toc-number">3.3.</span> <span class="toc-text">关于 TLS/SSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要部署-HTTPS"><span class="toc-number">3.4.</span> <span class="toc-text">为什么要部署 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么部署-HTTPS"><span class="toc-number">3.5.</span> <span class="toc-text">怎么部署 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么获得-SSL-安全证书"><span class="toc-number">3.6.</span> <span class="toc-text">怎么获得 SSL 安全证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Let’s-Encrypt-简介"><span class="toc-number">4.</span> <span class="toc-text">Let’s Encrypt 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Let’s-Encrypt-通配符证书"><span class="toc-number">4.1.</span> <span class="toc-text">Let’s Encrypt 通配符证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何申请-Let’s-Encrypt-通配符证书"><span class="toc-number">4.2.</span> <span class="toc-text">如何申请 Let’s Encrypt 通配符证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Certbot-简介"><span class="toc-number">5.</span> <span class="toc-text">Certbot 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#certbot-插件介绍"><span class="toc-number">5.1.</span> <span class="toc-text">certbot 插件介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#certbot-dns-route53-实践"><span class="toc-number">5.2.</span> <span class="toc-text">certbot-dns-route53 实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#certbot-证书默认存放路径结构"><span class="toc-number">5.3.</span> <span class="toc-text">certbot 证书默认存放路径结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#certbot-自动更新证书"><span class="toc-number">6.</span> <span class="toc-text">certbot 自动更新证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#checkssl"><span class="toc-number">7.</span> <span class="toc-text">checkssl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">8.</span> <span class="toc-text">参考文章</span></a></li></ol>
		
		</div>
		 -->
		<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200219171300.png" alt=""></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因为 Google Chrome 和运营商劫持干扰访问者体验的努力推动了大型网站加速应用全站 HTTPS，而 <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a> 这个项目通过自动化把配置和维护 HTTPS 变得更加简单，Let’s Encrypt 设计了一个 ACME 协议目前版本是 v2，并在 2018 年支持通配符证书 <a href="https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579" target="_blank" rel="noopener">Wildcard Certificate Support is Live</a>。官网主推的客户端是<a href="https://certbot.eff.org/" target="_blank" rel="noopener">Certbot</a>，任何人都可以基于 ACME 协议实现一个客户端，比如大名鼎鼎的<a href="https://github.com/Neilpang/acme.sh" target="_blank" rel="noopener">acme.sh</a>。本文主要使用<a href="https://github.com/certbot/certbot/tree/master/certbot-dns-route53" target="_blank" rel="noopener">certbot-dns-route53</a> 插件为例，由于 certbot 官方 DNS Plugins 插件支持有限，如果你需要支持 aliyun/tencentyun/godaddy dns 可以参考 <a href="https://github.com/ywdblog/certbot-letencrypt-wildcardcertificates-alydns-au" target="_blank" rel="noopener">certbot-letencrypt-wildcardcertificates-alydns-au</a>，随着 Docker 容器化和 K8S(Kubernetes) 的进击，相信会促进 certbot 多样化玩法。</p>
<blockquote>
<p>使用 certbot 代替 acme.sh 免费申请 wildcard 通配符证书和自动更新实践小结</p>
</blockquote>
<h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2020 年 04 月 13 日 - 增加 checkssl<br>2020 年 02 月 19 日 - 初稿</p>
<p>阅读原文 - <a href="https://wsgzao.github.io/post/certbot/">https://wsgzao.github.io/post/certbot/</a></p>
<hr>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="关于-HTTPS"><a href="#关于-HTTPS" class="headerlink" title="关于 HTTPS"></a>关于 HTTPS</h3><blockquote>
<p>引维基百科的说法</p>
</blockquote>
<p>超文本传输安全协议（英语：Hypertext Transfer Protocol Secure，缩写：HTTPS）是一种网络安全传输协议。在计算机网络上，HTTPS 经由超文本传输协议进行通信，但利用 SSL/TLS 来对数据包进行加密。HTTPS 开发的主要目的，是提供对网络服务器的身份认证，保护交换数据的隐私与完整性</p>
<p>HTTPS 的主要思想是在不安全的网络上创建一安全信道，并可在使用适当的加密包和服务器证书可被验证且可被信任时，对窃听和中间人攻击提供合理防护。</p>
<p>HTTPS 的信任继承基于预先安装在浏览器中的证书颁发机构（如 Symantec、Comodo、GoDaddy 和 GlobalSign 等）（意即“我信任证书颁发机构告诉我应该信任的”）。因此，一个到某网站的 HTTPS 连接可被信任，当且且当：</p>
<ul>
<li>用户相信他们的浏览器正确实现了 HTTPS 且安装了正确的证书颁发机构；</li>
<li>用户相信证书颁发机构仅信任合法的网站；</li>
<li>被访问的网站提供了一个有效的证书，意即，它是由一个被信任的证书颁发机构签发的（大部分浏览器会对无效的证书发出警告）；</li>
<li>该证书正确地验证了被访问的网站（如，访问 <a href="https://example.com" target="_blank" rel="noopener">https://example.com</a> 时收到了给 example.com 而不是其他组织的证书）；</li>
<li>或者互联网上相关节点是值得信任的，或者用户相信本协议的加密层（TLS 或 SSL）不能被窃听者破坏。</li>
</ul>
<h3 id="HTTP-和-HTTPS-区别"><a href="#HTTP-和-HTTPS-区别" class="headerlink" title="HTTP 和 HTTPS 区别"></a>HTTP 和 HTTPS 区别</h3><p>HTTP 协议传输的数据都是未加密的，也就是明文的，因此使用 HTTP 协议传输隐私信息非常不安全，为了保证这些隐私数据能加密传输，于是网景公司设计了 SSL（Secure Sockets Layer）协议用于对 HTTP 协议传输的数据进行加密，从而就诞生了 HTTPS。简单来说，HTTPS 协议是由 SSL+HTTP 协议构建的可进行加密传输、身份认证的网络协议，要比 HTTP 协议安全。</p>
<p>HTTPS 和 HTTP 的区别主要如下：</p>
<ul>
<li>HTTPS 协议需要到 CA 申请证书，一般免费证书较少，因而需要一定费用。</li>
<li>HTTP 是超文本传输协议，信息是明文传输，HTTPS 则是具有安全性的 SSL 加密传输协议。</li>
<li>HTTP 和 HTTPS 使用的是完全不同的连接方式，用的端口也不一样，前者是 80，后者是 443。</li>
<li>HTTP 的连接很简单，是无状态的；HTTPS 协议是由 SSL+HTTP 协议构建的可进行加密传输、身份认证的网络协议，比 HTTP 协议安全。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200220153747.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20200220153532.png" alt=""></p>
<p><a href="https://serverguy.com/ssl/types-of-ssl-certificates/" target="_blank" rel="noopener">Types of SSL Certificates for a Secure Business Website</a></p>
<h3 id="关于-TLS-SSL"><a href="#关于-TLS-SSL" class="headerlink" title="关于 TLS/SSL"></a>关于 TLS/SSL</h3><p>传输层安全协议（英语：Transport Layer Security，缩写：TLS），及其前身安全套接层（Secure Sockets Layer，缩写：SSL）是一种安全协议，目的是为互联网通信，提供安全及数据完整性保障</p>
<h3 id="为什么要部署-HTTPS"><a href="#为什么要部署-HTTPS" class="headerlink" title="为什么要部署 HTTPS"></a>为什么要部署 HTTPS</h3><p>说到底，就是 HTTPS 更安全。甚至为了安全，一个专业可靠的网站， HTTPS 是必须的。 Firefox 和 Chrome 都计划将没有配置 SSL 加密的 HTTP 网站标记为不安全（貌似 Firefox 50 已经这么干了），目前它们也正在联合其他相关的基金会与公司推动整个互联网 HTTPS 化，现在大家访问的一些主要的网站。如 Google 多年前就已经全部启用 HTTPS ，国内的淘宝、搜狗、知乎、百度等等也全面 HTTPS 了。甚至 Google 的搜索结果也正在给予 HTTPS 的网站更高的排名和优先收录权。</p>
<h3 id="怎么部署-HTTPS"><a href="#怎么部署-HTTPS" class="headerlink" title="怎么部署 HTTPS"></a>怎么部署 HTTPS</h3><p>你只需要有一张被信任的 CA （ Certificate Authority ）也就是证书授权中心颁发的 SSL 安全证书，并且将它部署到你的网站服务器上。一旦部署成功后，当用户访问你的网站时，浏览器会在显示的网址前加一把小绿锁，表明这个网站是安全的，当然同时你也会看到网址前的前缀变成了 HTTPS ，不再是 HTTP 了。</p>
<h3 id="怎么获得-SSL-安全证书"><a href="#怎么获得-SSL-安全证书" class="headerlink" title="怎么获得 SSL 安全证书"></a>怎么获得 SSL 安全证书</h3><p>理论上，我们自己也可以签发 SSL 安全证书，但是我们自己签发的安全证书不会被主流的浏览器信任，所以我们需要被信任的证书授权中心（ CA ）签发的安全证书。而一般的 SSL 安全证书签发服务都比较贵，比如 Godaddy 、 GlobalSign 等机构签发的证书一般都需要 20 美金一年甚至更贵，不过为了加快推广 HTTPS 的普及， EEF 电子前哨基金会、 Mozilla 基金会和美国密歇根大学成立了一个公益组织叫 ISRG （ Internet Security Research Group ），这个组织从 2015 年开始推出了 Let’s Encrypt 免费证书。这个免费证书不仅免费，而且还相当好用，所以我们就可以利用 Let’s Encrypt 提供的免费证书部署 HTTPS 了</p>
<h2 id="Let’s-Encrypt-简介"><a href="#Let’s-Encrypt-简介" class="headerlink" title="Let’s Encrypt 简介"></a>Let’s Encrypt 简介</h2><p>Let’s Encrypt 是 一个叫 ISRG （ Internet Security Research Group ，互联网安全研究小组）的组织推出的免费安全证书计划。参与这个计划的组织和公司可以说是互联网顶顶重要的先驱，除了前文提到的三个牛气哄哄的发起单位外，后来又有思科（全球网络设备制造商执牛耳者）、 Akamai 加入，甚至连 Linux 基金会也加入了合作，这些大牌组织的加入保证了这个项目的可信度和可持续性。</p>
<p>部署 HTTPS 网站的时候需要证书，证书由 CA 机构签发，大部分传统 CA 机构签发证书是需要收费的，这不利于推动 HTTPS 协议的使用。</p>
<p>Let’s Encrypt 也是一个 CA 机构，但这个 CA 机构是免费的！！！也就是说签发证书不需要任何费用。</p>
<p>Let’s Encrypt 由于是非盈利性的组织，需要控制开支，他们搞了一个非常有创意的事情，设计了一个 ACME 协议，目前该协议的版本是 v1。</p>
<p>那为什么要创建 ACME 协议呢，传统的 CA 机构是人工受理证书申请、证书更新、证书撤销，完全是手动处理的。而 ACME 协议规范化了证书申请、更新、撤销等流程，只要一个客户端实现了该协议的功能，通过客户端就可以向 Let’s Encrypt 申请证书，也就是说 Let’s Encrypt CA 完全是自动化操作的。</p>
<p>任何人都可以基于 ACME 协议实现一个客户端，官方推荐的客户端是 Certbot 。</p>
<h3 id="Let’s-Encrypt-通配符证书"><a href="#Let’s-Encrypt-通配符证书" class="headerlink" title="Let’s Encrypt 通配符证书"></a>Let’s Encrypt 通配符证书</h3><p>在没有出现通配符证书之前，Let’s Encrypt 支持两种证书。</p>
<p>1）单域名证书：证书仅仅包含一个主机。</p>
<p>2）SAN 证书：一张证书可以包括多个主机（Let’s Encrypt 限制是 20），也就是证书可以包含下列的主机：<a href="http://www.example.com、www.example.cn、blog.example.com" target="_blank" rel="noopener">www.example.com、www.example.cn、blog.example.com</a> 等等。</p>
<p>证书包含的主机可以不是同一个注册域，不要问我注册域是什么？注册域就是向域名注册商购买的域名。</p>
<p>对于个人用户来说，由于主机并不是太多，所以使用 SAN 证书完全没有问题，但是对于大公司来说有一些问题：</p>
<ul>
<li>子域名非常多，而且过一段时间可能就要使用一个新的主机。</li>
<li>注册域也非常多。</li>
</ul>
<p>读者可以思考下，对于大企业来说，SAN 证书可能并不能满足需求，类似于 sina 这样的网站，所有的主机全部包含在一张证书中，而使用 Let’s Encrypt 证书是无法满足的。</p>
<p>通配符证书就是证书中可以包含一个通配符，比如 .example.com、.example.cn，读者很快明白，大型企业也可以使用通配符证书了，一张证书可以防止更多的主机了。</p>
<p>这个功能可以说非常重要，从功能上看 Let’s Encrypt 和传统 CA 机构没有什么区别了，会不会触动传统 CA 机构的利益呢？</p>
<h3 id="如何申请-Let’s-Encrypt-通配符证书"><a href="#如何申请-Let’s-Encrypt-通配符证书" class="headerlink" title="如何申请 Let’s Encrypt 通配符证书"></a>如何申请 Let’s Encrypt 通配符证书</h3><p>为了实现通配符证书，Let’s Encrypt 对 ACME 协议的实现进行了升级，只有 v2 协议才能支持通配符证书。</p>
<p>也就是说任何客户端只要支持 ACME v2 版本，就可以申请通配符证书了，是不是很激动。</p>
<p>在了解该协议之前有几个注意点：</p>
<p>客户在申请 Let’s Encrypt 证书的时候，需要校验域名的所有权，证明操作者有权利为该域名申请证书，目前支持三种验证方式：</p>
<ul>
<li>dns-01：给域名添加一个 DNS TXT 记录。</li>
<li>http-01：在域名对应的 Web 服务器下放置一个 HTTP well-known URL 资源文件。</li>
<li>tls-sni-01：在域名对应的 Web 服务器下放置一个 HTTPS well-known URL 资源文件。</li>
</ul>
<p>而申请通配符证书，只能使用 dns-01 的方式</p>
<h2 id="Certbot-简介"><a href="#Certbot-简介" class="headerlink" title="Certbot 简介"></a>Certbot 简介</h2><blockquote>
<p>What’s Certbot?</p>
</blockquote>
<p>Certbot is a free, open source software tool for automatically using <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a> certificates on manually-administrated websites to enable HTTPS.</p>
<p>Certbot is made by the <a href="https://www.eff.org/" target="_blank" rel="noopener">Electronic Frontier Foundation (EFF)</a>, a 501(c)3 nonprofit based in San Francisco, CA, that defends digital privacy, free speech, and innovation.</p>
<p>Certbot 的官方网站是 <a href="https://certbot.eff.org/" target="_blank" rel="noopener">https://certbot.eff.org/</a> ，打开这个链接选择自己使用的 web server 和操作系统，EFF 官方会给出详细的使用方法，如果 DNS 在官方的支持插件列表中可以按官方文档操作，但如果是国内的 DNS 可以参考<a href="https://github.com/ywdblog/certbot-letencrypt-wildcardcertificates-alydns-au" target="_blank" rel="noopener">certbot-letencrypt-wildcardcertificates-alydns-au</a></p>
<p><a href="https://certbot.eff.org/docs/using.html#dns-plugins" target="_blank" rel="noopener">DNS plugin’s name on the Documentation list</a></p>
<p><a href="https://certbot.eff.org/docs/" target="_blank" rel="noopener">certbot docs</a></p>
<h3 id="certbot-插件介绍"><a href="#certbot-插件介绍" class="headerlink" title="certbot 插件介绍"></a>certbot 插件介绍</h3><p>Certbot 现在需要运行在安装了 Python （2.7 or 3.4）的类 unix 系统上，内存大于 512MB（如果小于的话，<a href="https://certbot.eff.org/docs/install.html#problems-with-python-virtual-environment" target="_blank" rel="noopener">官方解决方案</a>），默认是需要 root 权限的，比如写证书操作需要 root 权限。</p>
<p>Certbot 客户机支持获取和安装证书的两种插件:<code>auth</code> 和 <code>install</code>，当使用 certonly 参数的时候，只会获取证书，并不会安装证，获取的证书位于 / etc/letsencrypt 目录下</p>
<p>主要插件的介绍：</p>
<p><a href="https://certbot.eff.org/docs/using.html#getting-certificates-and-choosing-plugins" target="_blank" rel="noopener">Getting certificates (and choosing plugins)</a></p>
<table>
<thead>
<tr>
<th>Plugin</th>
<th>Auth</th>
<th>Install</th>
<th>Notes</th>
<th>Challenge types (and port)</th>
</tr>
</thead>
<tbody>
<tr>
<td>apache</td>
<td>Y</td>
<td>Y</td>
<td>自动化获取并安装证书</td>
<td>tls-sni-01 (443)</td>
</tr>
<tr>
<td>webroot</td>
<td>Y</td>
<td>N</td>
<td>已经有运行的服务，通过验证 webroot 目录来获取证书</td>
<td>http-01 (80)</td>
</tr>
<tr>
<td>nginx</td>
<td>Y</td>
<td>Y</td>
<td>使用 nginx 自动获取和安装证书</td>
<td>tls-sni-01 (443)</td>
</tr>
<tr>
<td>standalone</td>
<td>Y</td>
<td>N</td>
<td>建立一个 standalone WEB 服务，需要 80 或者 443 端口可用，如果你没有类似 nginx 和 apache 等服务，这很有用</td>
<td>http-01 (80) or tls-sni-01 (443)</td>
</tr>
<tr>
<td>DNS plugins</td>
<td>Y</td>
<td>N</td>
<td>通过修改 dns 服务器的 text 记录，来获取证书，野卡证书只能通过此方式获取</td>
<td>dns-01 (53)</td>
</tr>
<tr>
<td>manual</td>
<td>Y</td>
<td>N</td>
<td>通过自己给指令获取证书，支持添加定制脚本来完成任务</td>
<td>http-01 (80), dns-01 (53) or tls-sni-01 (443)</td>
</tr>
</tbody>
</table>
<p>解析：</p>
<ul>
<li>如果你使用 standalone 插件，那么需要使用 80 和 443 端口，因为要建一个监听这些端口的服务，如果你有别的服务使用了该端口，那么就会出问题了。</li>
<li>webroot 方式，如果你使用了 nginx，那么你需要更改一些 nginx 配置，确保能验证你对该域名的所有权限</li>
</ul>
<p>插件的具体使用可以参考<a href="https://www.cnblogs.com/redirect/p/10140248.html" target="_blank" rel="noopener">letsencrypt 证书 - 管理工具 certbot</a></p>
<p>我个人推荐选择 <code>DNS plugins</code> 或者 <code>manual</code> 方式来管理</p>
<h3 id="certbot-dns-route53-实践"><a href="#certbot-dns-route53-实践" class="headerlink" title="certbot-dns-route53 实践"></a>certbot-dns-route53 实践</h3><p>因为域名在 Amazon Route 53，所以选择使用 certbot-dns-route53 插件会比较方便，敏感信息都用 xxx 打码了但不影响阅读理解</p>
<p><a href="https://github.com/certbot/certbot/tree/master/certbot-dns-route53" target="_blank" rel="noopener">https://github.com/certbot/certbot/tree/master/certbot-dns-route53</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a virtual environment</span></span><br><span class="line">pip install virtualenv</span><br><span class="line"><span class="built_in">cd</span> /root</span><br><span class="line">virtualenv certbot</span><br><span class="line"><span class="built_in">source</span> certbot/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update its pip and setuptools (VENV/bin/pip install -U setuptools pip) to avoid problems with cryptography's dependency on setuptools&gt;=11.3.</span></span><br><span class="line"></span><br><span class="line">certbot/bin/pip install -U setuptools pip</span><br><span class="line"></span><br><span class="line">pip list</span><br><span class="line"></span><br><span class="line">Package    Version</span><br><span class="line">---------- -------</span><br><span class="line">pip        20.0.2</span><br><span class="line">setuptools 44.0.0</span><br><span class="line">wheel      0.34.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make sure you have libssl-dev and libffi (or your regional equivalents) installed. You might have to set compiler flags to pick things up (I have to use CPPFLAGS=-I/usr/local/opt/openssl/include LDFLAGS=-L/usr/local/opt/openssl/lib on my macOS to pick up brew's openssl, for example).</span></span><br><span class="line"></span><br><span class="line">pip install certbot-dns-route53</span><br><span class="line"></span><br><span class="line"><span class="comment"># create aws credentials</span></span><br><span class="line">mkdir ~/.aws/</span><br><span class="line">vim ~/.aws/credentials</span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id=xxx</span><br><span class="line">aws_secret_access_key=xxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate certificate</span></span><br><span class="line">certbot certonly \</span><br><span class="line">  -n --agree-tos --email xxx \</span><br><span class="line">  --dns-route53 \</span><br><span class="line">  -d <span class="string">"*.xxx"</span> </span><br><span class="line"></span><br><span class="line">(certbot) [root@xxx ~]<span class="comment"># certbot certonly \</span></span><br><span class="line">&gt;   -n --agree-tos --email xxx  \</span><br><span class="line">&gt;   --dns-route53 \</span><br><span class="line">&gt;   -d <span class="string">"*.xxx"</span></span><br><span class="line">Saving debug <span class="built_in">log</span> to /var/<span class="built_in">log</span>/letsencrypt/letsencrypt.log</span><br><span class="line">Found credentials <span class="keyword">in</span> shared credentials file: ~/.aws/credentials</span><br><span class="line">Plugins selected: Authenticator dns-route53, Installer None</span><br><span class="line">Obtaining a new certificate</span><br><span class="line">Performing the following challenges:</span><br><span class="line">dns-01 challenge <span class="keyword">for</span> xxx</span><br><span class="line">Waiting <span class="keyword">for</span> verification...</span><br><span class="line">Cleaning up challenges</span><br><span class="line"></span><br><span class="line">IMPORTANT NOTES:</span><br><span class="line"> - Congratulations! Your certificate and chain have been saved at:</span><br><span class="line">   /etc/letsencrypt/live/xxx/fullchain.pem</span><br><span class="line">   Your key file has been saved at:</span><br><span class="line">   /etc/letsencrypt/live/xxx/privkey.pem</span><br><span class="line">   Your cert will expire on 2020-05-19. To obtain a new or tweaked</span><br><span class="line">   version of this certificate <span class="keyword">in</span> the future, simply run certbot</span><br><span class="line">   again. To non-interactively renew *all* of your certificates, run</span><br><span class="line">   <span class="string">"certbot renew"</span></span><br><span class="line"> - Your account credentials have been saved <span class="keyword">in</span> your Certbot</span><br><span class="line">   configuration directory at /etc/letsencrypt. You should make a</span><br><span class="line">   secure backup of this folder now. This configuration directory will</span><br><span class="line">   also contain certificates and private keys obtained by Certbot so</span><br><span class="line">   making regular backups of this folder is ideal.</span><br><span class="line"> - If you like Certbot, please consider supporting our work by:</span><br><span class="line"></span><br><span class="line">   Donating to ISRG / Let<span class="string">'s Encrypt:   https://letsencrypt.org/donate</span></span><br><span class="line"><span class="string">   Donating to EFF:                    https://eff.org/donate-le</span></span><br></pre></td></tr></table></figure>
<h3 id="certbot-证书默认存放路径结构"><a href="#certbot-证书默认存放路径结构" class="headerlink" title="certbot 证书默认存放路径结构"></a>certbot 证书默认存放路径结构</h3><p><a href="https://certbot.eff.org/docs/using.html#where-are-my-certificates" target="_blank" rel="noopener">Where are my certificates</a></p>
<p>All generated keys and issued certificates can be found in <code>/etc/letsencrypt/live/$domain</code>. In the case of creating a SAN certificate with multiple alternative names, <code>$domain</code>is the first domain passed in via -d parameter. Rather than copying, please point your (web) server configuration directly to those files (or create symlinks). During the <a href="#renewal">renewal</a>, <code>/etc/letsencrypt/live</code>is updated with the latest necessary files.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check letsencrypt directory</span></span><br><span class="line">[root@xxx ~]<span class="comment"># tree /etc/letsencrypt/</span></span><br><span class="line">/etc/letsencrypt/</span><br><span class="line">├── accounts</span><br><span class="line">│   └── acme-v02.api.letsencrypt.org</span><br><span class="line">│       └── directory</span><br><span class="line">│           └── xxx</span><br><span class="line">│               ├── meta.json</span><br><span class="line">│               ├── private_key.json</span><br><span class="line">│               └── regr.json</span><br><span class="line">├── archive</span><br><span class="line">│   └── xxx</span><br><span class="line">│       ├── cert1.pem</span><br><span class="line">│       ├── chain1.pem</span><br><span class="line">│       ├── fullchain1.pem</span><br><span class="line">│       └── privkey1.pem</span><br><span class="line">├── csr</span><br><span class="line">│   ├── 0000_csr-certbot.pem</span><br><span class="line">│   └── 0001_csr-certbot.pem</span><br><span class="line">├── keys</span><br><span class="line">│   ├── 0000_key-certbot.pem</span><br><span class="line">│   └── 0001_key-certbot.pem</span><br><span class="line">├── live</span><br><span class="line">│   ├── xxx</span><br><span class="line">│   │   ├── cert.pem -&gt; ../../archive/xxx/cert1.pem</span><br><span class="line">│   │   ├── chain.pem -&gt; ../../archive/xxx/chain1.pem</span><br><span class="line">│   │   ├── fullchain.pem -&gt; ../../archive/xxx/fullchain1.pem</span><br><span class="line">│   │   ├── privkey.pem -&gt; ../../archive/xxx/privkey1.pem</span><br><span class="line">│   │   └── README</span><br><span class="line">│   └── README</span><br><span class="line">├── renewal</span><br><span class="line">│   └── xxx.conf</span><br><span class="line">└── renewal-hooks</span><br><span class="line">    ├── deploy</span><br><span class="line">    ├── post</span><br><span class="line">    └── pre</span><br><span class="line"></span><br><span class="line">15 directories, 18 files</span><br></pre></td></tr></table></figure>
<ul>
<li>live 目录下存放的将会链接到最新的证书和私钥</li>
<li>csr keys 用来存放当前代理的授权密钥对</li>
<li>account 用来存放证书的管理信息, 这里涉及 ACME</li>
<li>renewal 存放当前代理所管理的域的信息</li>
</ul>
<p>如果是配置 Nginx SSL 证书，通常只需要按照下面这样修改即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_certificate /etc/letsencrypt/live/xxx/fullchain.pem;</span><br><span class="line">ssl_certificate_key /etc/letsencrypt/live/xxx/privkey.pem;</span><br></pre></td></tr></table></figure>
<p><a href="https://certbot.eff.org/docs/using.html#certbot-command-line-options" target="_blank" rel="noopener">Certbot command-line options</a></p>
<p>Certbot supports a lot of command line options. Here’s the full list, from <code>certbot --help all</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">(certbot) [root@xxx ~]<span class="comment"># certbot -h</span></span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line"></span><br><span class="line">  certbot [SUBCOMMAND] [options] [-d DOMAIN] [-d DOMAIN] ...</span><br><span class="line"></span><br><span class="line">Certbot can obtain and install HTTPS/TLS/SSL certificates.  By default,</span><br><span class="line">it will attempt to use a webserver both <span class="keyword">for</span> obtaining and installing the</span><br><span class="line">certificate. The most common SUBCOMMANDS and flags are:</span><br><span class="line"></span><br><span class="line">obtain, install, and renew certificates:</span><br><span class="line">    (default) run   Obtain &amp; install a certificate <span class="keyword">in</span> your current webserver</span><br><span class="line">    certonly        Obtain or renew a certificate, but <span class="keyword">do</span> not install it</span><br><span class="line">    renew           Renew all previously obtained certificates that are near</span><br><span class="line">expiry</span><br><span class="line">    enhance         Add security enhancements to your existing configuration</span><br><span class="line">   -d DOMAINS       Comma-separated list of domains to obtain a certificate <span class="keyword">for</span></span><br><span class="line"></span><br><span class="line">  (the certbot apache plugin is not installed)</span><br><span class="line">  --standalone      Run a standalone webserver <span class="keyword">for</span> authentication</span><br><span class="line">  (the certbot nginx plugin is not installed)</span><br><span class="line">  --webroot         Place files <span class="keyword">in</span> a server<span class="string">'s webroot folder for authentication</span></span><br><span class="line"><span class="string">  --manual          Obtain certificates interactively, or using shell script</span></span><br><span class="line"><span class="string">hooks</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   -n               Run non-interactively</span></span><br><span class="line"><span class="string">  --test-cert       Obtain a test certificate from a staging server</span></span><br><span class="line"><span class="string">  --dry-run         Test"renew"or"certonly"without saving any certificates</span></span><br><span class="line"><span class="string">to disk</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">manage certificates:</span></span><br><span class="line"><span class="string">    certificates    Display information about certificates you have from Certbot</span></span><br><span class="line"><span class="string">    revoke          Revoke a certificate (supply --cert-name or --cert-path)</span></span><br><span class="line"><span class="string">    delete          Delete a certificate (supply --cert-name)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">manage your account:</span></span><br><span class="line"><span class="string">    register        Create an ACME account</span></span><br><span class="line"><span class="string">    unregister      Deactivate an ACME account</span></span><br><span class="line"><span class="string">    update_account  Update an ACME account</span></span><br><span class="line"><span class="string">  --agree-tos       Agree to the ACME server'</span>s Subscriber Agreement</span><br><span class="line">   -m EMAIL         Email address <span class="keyword">for</span> important account notifications</span><br><span class="line"></span><br><span class="line">More detailed <span class="built_in">help</span>:</span><br><span class="line"></span><br><span class="line">  -h, --<span class="built_in">help</span> [TOPIC]    <span class="built_in">print</span> this message, or detailed <span class="built_in">help</span> on a topic;</span><br><span class="line">                        the available TOPICS are:</span><br><span class="line"></span><br><span class="line">   all, automation, commands, paths, security, testing, or any of the</span><br><span class="line">   subcommands or plugins (certonly, renew, install, register, nginx,</span><br><span class="line">   apache, standalone, webroot, etc.)</span><br><span class="line">  -h all                <span class="built_in">print</span> a detailed <span class="built_in">help</span> page including all topics</span><br><span class="line">  --version             <span class="built_in">print</span> the version number</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br></pre></td></tr></table></figure>
<h2 id="certbot-自动更新证书"><a href="#certbot-自动更新证书" class="headerlink" title="certbot 自动更新证书"></a>certbot 自动更新证书</h2><blockquote>
<p>简单介绍 2 种常见的需求，其他情况如使用容器 renew 的朋友相信应该都不用参考本文了</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最简单的手动 renew 命令，看到 success 表示成功</span></span><br><span class="line">certbot renew --force-renewal</span><br><span class="line"></span><br><span class="line">(certbot) [root@xxx ~]<span class="comment"># certbot renew --force-renewal</span></span><br><span class="line">Saving debug <span class="built_in">log</span> to /var/<span class="built_in">log</span>/letsencrypt/letsencrypt.log</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Processing /etc/letsencrypt/renewal/xxx.conf</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Found credentials <span class="keyword">in</span> shared credentials file: ~/.aws/credentials</span><br><span class="line">Plugins selected: Authenticator dns-route53, Installer None</span><br><span class="line">Renewing an existing certificate</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">new certificate deployed without reload, fullchain is</span><br><span class="line">/etc/letsencrypt/live/xxx/fullchain.pem</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line"></span><br><span class="line">Congratulations, all renewals succeeded. The following certs have been renewed:</span><br><span class="line">  /etc/letsencrypt/live/xxx/fullchain.pem (success)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用 crontab 定期执行</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 certbot_renew.sh，强制更新并重新 reload nginx 加载新证书</span></span><br><span class="line">vim /root/certbot_renew.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">certbot renew --force-renew</span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是 virtualenv 虚拟环境可以这样写</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/bin</span><br><span class="line"><span class="built_in">source</span> certbot/bin/activate</span><br><span class="line">certbot renew --force-renew</span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">chmod a+x /root/certbot_renew.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置定时任务自动更新证书，“At 01:01 on day-of-month 1.”</span></span><br><span class="line">vim /etc/crontab</span><br><span class="line">1 1 1 * * /root/certbot_renew.sh &gt;/root/crontab.log 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果需要记录日志可以这样写</span></span><br><span class="line">1 1 1 * * <span class="built_in">echo</span> `date -R` &gt;&gt; /var/<span class="built_in">log</span>/certbot.crontab.log; certbot renew --force-renewal &gt;&gt; /var/<span class="built_in">log</span>/certbot.crontab.log 2&gt;&amp;1; nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># certbot 官方使用 python 产生了一个分钟的随机数，让更新时间随机一些</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"0 0,12 * * * root python -c'import random; import time; time.sleep(random.random() * 3600)'&amp;&amp; certbot renew"</span> | sudo tee -a /etc/crontab &gt; /dev/null</span><br></pre></td></tr></table></figure>
<h2 id="checkssl"><a href="#checkssl" class="headerlink" title="checkssl"></a>checkssl</h2><p>checks ssl certs for a set of domains</p>
<p><a href="https://github.com/srvrco/checkssl" target="_blank" rel="noopener">https://github.com/srvrco/checkssl</a></p>
<p>With the good work by “Let’s Encrypt” in providing free SSL certs for users, I wanted a quick way to check all the domains I look after to determine which ones have correct SSL certs, and which ones are in need of updating etc. </p>
<p>This bash file is the first draft of a program to do that.  It can either be run against a list of file names, from the directories in your Lets Encrypt live directory or on a single server with  the aim of getting all the domain names from the server.   </p>
<p>The output looks like:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Domain       cert for     valid until            cert issued by    possible issues?</span><br><span class="line">domain1.com  domain1.com  Dec 22 09:19:00 2016   Let&apos;s Encrypt   - certificate near renewal date</span><br><span class="line">domain2.com  domain2.com  Dec 22 11:42:00 2016   Let&apos;s Encrypt   - certificate near renewal date</span><br><span class="line">domain3.net  domain3.net  Mar  4 10:10:00 2016   Let&apos;s Encrypt </span><br><span class="line">domain4.net  domain1.net  Mar  2 12:23:00 2016   Let&apos;s Encrypt   - possible name mismatch</span><br></pre></td></tr></table></figure></p>
<p>You can also get a list of domains that need to be renewed, to list the domains requiring renewal in the nest 20 days;</p>
<p>checkssl -l /etc/letsencrypt/live/ -e 20 -r<br>domain7.com<br>domain12.com</p>
<p>You can also get it to run a specific command if domains need renewal, for example </p>
<p>check -i ISPconfig -e 20 -c ~/scripts/renewssl</p>
<p>will run the renewssl command with the domain name passed as an argument.   If there are more than one domain that needs renewal it will call the command multiple times.   This can then easily be run as a cron to regularly check and update SSL certs.</p>
<p>running checkssl with no arguments gives help;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">checkssl ver. 1.15</span><br><span class="line">Checks ssl certs for a set of domains</span><br><span class="line"></span><br><span class="line">Usage: checkssl [-h|--help] [-d|--debug] [-f|--file filename] [-s|--server stype] [-l|--location directory] </span><br><span class="line">                [-e|--expires days] [-r|--renew] [-u|--update] [-U|--nocheck] [-c|--command command] [domain]</span><br><span class="line">``</span><br><span class="line">Options:</span><br><span class="line">  -h, --help      Display this help message and exit.</span><br><span class="line">  -d, --debug     Outputs debug information</span><br><span class="line">  -f, --file  filename</span><br><span class="line">                  Where &apos;filename&apos; is a file containing a list of domain names</span><br><span class="line">  -s, --server server_type</span><br><span class="line">                  Where &apos;server_type&apos; is the server type (cpanel, ISPconfig, apache2 ...)</span><br><span class="line">  -l, --location directory</span><br><span class="line">                  Where &apos;directory&apos; is where your lets encrypt live directory is</span><br><span class="line">                  (typically /etc/letsencrypt/live/)</span><br><span class="line">  -e, --expires days</span><br><span class="line">                  Where &apos;days&apos; is the number of days to alert if cert expires in that time period</span><br><span class="line">  -r, --renew     This just lists domain names that need to be renewed.</span><br><span class="line">                  This list could be used by an auto renew script, or to email you.</span><br><span class="line">  -p, --problems  This just lists the domains that have possible issues.</span><br><span class="line">                  This list could be used to email you only if there is something to take care of.</span><br><span class="line">  -u, --upgrade   Upgrade checkssl if a more recent version is available</span><br><span class="line">  -U, --nocheck   Do not check if a more recent version is available</span><br><span class="line">  -c, --command run_command</span><br><span class="line">                  Where &apos;run_command&apos; is a command which will be run (with domain name passed)</span><br><span class="line">                  for any certs due for renewal</span><br><span class="line"></span><br><span class="line">                  A domain name can also be specified on the command line</span><br></pre></td></tr></table></figure></p>
<p>If a file is provided, with a list of domains then each domain can include a port / service for testing i.e.</p>
<p>example.com<br>example.com:pop3s<br>example.com:587</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://letsencrypt.org/docs/" target="_blank" rel="noopener">Let’s Encrypt Documentation</a></p>
<p><a href="https://github.com/Neilpang/acme.sh" target="_blank" rel="noopener">acme.sh</a></p>
<p><a href="https://dallaslu.com/use-acme-sh-lets-encrypt-wildcard-ssl-certs/" target="_blank" rel="noopener">使用 acme.sh 管理 Let’s Encrypt Wildcard SSL 证书</a></p>
<p><a href="https://certbot.eff.org/" target="_blank" rel="noopener">Certbot</a></p>
<p><a href="https://certbot.eff.org/docs/" target="_blank" rel="noopener">certbot docs</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-centos-7" target="_blank" rel="noopener">How To Secure Apache with Let’s Encrypt on CentOS 7</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-18-04" target="_blank" rel="noopener">How To Secure Nginx with Let’s Encrypt on Ubuntu 18.04</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-ubuntu-18-04" target="_blank" rel="noopener">How To Secure Apache with Let’s Encrypt on Ubuntu 18.04</a></p>
<p><a href="https://ksmx.me/letsencrypt-ssl-https/" target="_blank" rel="noopener">LET’S ENCRYPT 给网站加 HTTPS 完全指南</a></p>
<p><a href="https://my.oschina.net/kimver/blog/1634575" target="_blank" rel="noopener">申请 Let’s Encrypt 通配符 HTTPS 证书</a></p>
<p><a href="https://www.jianshu.com/p/c5c9d071e395" target="_blank" rel="noopener">Let’s Encrypt 终于支持通配符证书了</a></p>
<p><a href="https://mp.weixin.qq.com/s/hKvtDDQw7EHSGFRGT4QVbw" target="_blank" rel="noopener">Certobot 管理 Let’s Encrypt 证书的几个经验</a></p>
<p><a href="https://www.cnblogs.com/redirect/p/10140248.html" target="_blank" rel="noopener">letsencrypt 证书 - 管理工具 certbot</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/学习-Study/">学习 | Study</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://wsgzao.github.io/post/certbot/" data-title="使用 certbot 代替 acme.sh 免费申请 wildcard 通配符证书和自动更新实践小结 | HelloDog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/lvs-dr/" title="LVS-DR 原理介绍和配置实践">
  <strong>上一篇：</strong><br/>
  <span>
  LVS-DR 原理介绍和配置实践</span>
</a>
</div>


<div class="next">
<a href="/post/rpmbuild/"  title="使用 rpmbuild 制作 Nginx 的 RPM 包">
 <strong>下一篇：</strong><br/> 
 <span>使用 rpmbuild 制作 Nginx 的 RPM 包
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新历史"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础知识"><span class="toc-number">3.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于-HTTPS"><span class="toc-number">3.1.</span> <span class="toc-text">关于 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-和-HTTPS-区别"><span class="toc-number">3.2.</span> <span class="toc-text">HTTP 和 HTTPS 区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于-TLS-SSL"><span class="toc-number">3.3.</span> <span class="toc-text">关于 TLS/SSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要部署-HTTPS"><span class="toc-number">3.4.</span> <span class="toc-text">为什么要部署 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么部署-HTTPS"><span class="toc-number">3.5.</span> <span class="toc-text">怎么部署 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么获得-SSL-安全证书"><span class="toc-number">3.6.</span> <span class="toc-text">怎么获得 SSL 安全证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Let’s-Encrypt-简介"><span class="toc-number">4.</span> <span class="toc-text">Let’s Encrypt 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Let’s-Encrypt-通配符证书"><span class="toc-number">4.1.</span> <span class="toc-text">Let’s Encrypt 通配符证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何申请-Let’s-Encrypt-通配符证书"><span class="toc-number">4.2.</span> <span class="toc-text">如何申请 Let’s Encrypt 通配符证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Certbot-简介"><span class="toc-number">5.</span> <span class="toc-text">Certbot 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#certbot-插件介绍"><span class="toc-number">5.1.</span> <span class="toc-text">certbot 插件介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#certbot-dns-route53-实践"><span class="toc-number">5.2.</span> <span class="toc-text">certbot-dns-route53 实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#certbot-证书默认存放路径结构"><span class="toc-number">5.3.</span> <span class="toc-text">certbot 证书默认存放路径结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#certbot-自动更新证书"><span class="toc-number">6.</span> <span class="toc-text">certbot 自动更新证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#checkssl"><span class="toc-number">7.</span> <span class="toc-text">checkssl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">8.</span> <span class="toc-text">参考文章</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="wsgzao" data-theme="medium"></div>
<script type="text/javascript" src="//lab.lepture.com/github-cards/widget.js" ></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/学习-Study/" title="学习 | Study">学习 | Study<sup>180</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活-Life/" title="生活 | Life">生活 | Life<sup>16</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件-Soft/" title="软件 | Soft">软件 | Soft<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.linkedin.com/in/aowang" target="_blank" title="LinkedIn">LinkedIn</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, I&#39;m OX. This is my blog on GitHub. <br/>
			Keep Calm and Carry On.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/wsgzao" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/aowang" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="wsgzao">wsgzao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'wsgzao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-77732745-1', 'wsgzao.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c2c5fc7d844d0973d9f77abd87f49c3c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- swiftype Begin -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','_4qDmKrBPn9Es3UvQHT4','2.0.0');
</script>

<!-- swiftype End -->

  </body>
</html>
