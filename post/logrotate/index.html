
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    var host = "wsgzao.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LJ3PMGPVCK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LJ3PMGPVCK');
</script>
  
    <title>Linux 日志切割神器 logrotate 原理介绍和配置详解 | HelloDog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="wsgzao">
    

    
    <meta name="description" content="Linux日志切割神器logrotate原理介绍和配置详解">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 日志切割神器 logrotate 原理介绍和配置详解">
<meta property="og:url" content="https://wsgzao.github.io/post/logrotate/index.html">
<meta property="og:site_name" content="HelloDog">
<meta property="og:description" content="Linux日志切割神器logrotate原理介绍和配置详解">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191106155554.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191106155617.png">
<meta property="og:updated_time" content="2020-02-25T03:55:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux 日志切割神器 logrotate 原理介绍和配置详解">
<meta name="twitter:description" content="Linux日志切割神器logrotate原理介绍和配置详解">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191106155554.png">

    
    <link rel="alternative" href="/atom.xml" title="HelloDog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="HelloDog" title="HelloDog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="HelloDog">HelloDog</a></h1>
				<h2 class="blog-motto">Keep Calm and Carry On</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页 | Home</a></li>
					
						<li><a href="/index/">索引 | Index</a></li>
					
						<li><a href="/archives/">归档 | Archives</a></li>
					
						<li><a href="/about/">简介 | About</a></li>
					
					<li>
 					
						<form class="search">
							<label>Search</label>
						<input type="text" id="search" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/logrotate/" title="Linux 日志切割神器 logrotate 原理介绍和配置详解" itemprop="url">Linux 日志切割神器 logrotate 原理介绍和配置详解</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="wsgzao" target="_blank" itemprop="author">wsgzao</a>
		
  <p class="article-time">
    <time datetime="2019-11-05T06:59:49.000Z" itemprop="datePublished"> 发表于 2019-11-05</time>
    
  </p>
</header>
	<div class="article-content">
<!-- 		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新历史"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-简介"><span class="toc-number">3.</span> <span class="toc-text">logrotate 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-运行机制"><span class="toc-number">4.</span> <span class="toc-text">logrotate 运行机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-原理"><span class="toc-number">5.</span> <span class="toc-text">logrotate 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-文件操作机制"><span class="toc-number">5.1.</span> <span class="toc-text">Linux 文件操作机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create"><span class="toc-number">5.2.</span> <span class="toc-text">create</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copytruncate"><span class="toc-number">5.3.</span> <span class="toc-text">copytruncate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-logrotate"><span class="toc-number">6.</span> <span class="toc-text">配置 logrotate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行-logrotate"><span class="toc-number">7.</span> <span class="toc-text">运行 logrotate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#logrotate-参数"><span class="toc-number">7.1.</span> <span class="toc-text">logrotate 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#手动运行-logrotate-演练"><span class="toc-number">7.2.</span> <span class="toc-text">手动运行 logrotate 演练</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-配置文件实例"><span class="toc-number">8.</span> <span class="toc-text">logrotate 配置文件实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于-USR1-信号解释"><span class="toc-number">9.</span> <span class="toc-text">关于 USR1 信号解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-日志切割轮询"><span class="toc-number">10.</span> <span class="toc-text">logrotate 日志切割轮询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-常见问题"><span class="toc-number">11.</span> <span class="toc-text">logrotate 常见问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">12.</span> <span class="toc-text">参考文章</span></a></li></ol>
		
		</div>
		 -->
		<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 Linux 环境中能够帮助我们分析问题蛛丝马迹的有效办法之一便是日志，常见的如操作系统 syslog 日志 <code>/var/log/messages</code>，应用程序 Nginx 日志 <code>/var/log/nginx/*.log</code>。但如果服务器数量较多，日志文件大小增长较快，不断消耗磁盘空间就会触发告警，如果需要人为定期按照各种维度去手动清理日志就显得十分棘手。为了节省空间和方便整理，可以将日志文件按时间或大小分成多份，删除时间久远的日志文件，这就是通常说的日志滚动 <a href="https://en.wikipedia.org/wiki/Log_rotation" target="_blank" rel="noopener">(log rotation)</a>。logrotate<a href="https://github.com/logrotate/logrotate" target="_blank" rel="noopener">(GitHub 地址)</a> 诞生于 1996/11/19 是一个 Linux 系统日志的管理工具，本文会详细介绍 Linux 日志切割神器 logrotate 的原理和配置。</p>
<blockquote>
<p>Linux 日志切割神器 logrotate 原理介绍和配置详解</p>
</blockquote>
<h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 11 月 05 日 - 初稿</p>
<p>阅读原文 - <a href="https://wsgzao.github.io/post/logrotate/">https://wsgzao.github.io/post/logrotate/</a></p>
<p><strong> 扩展阅读 </strong></p>
<p><a href="https://linux.die.net/man/8/logrotate" target="_blank" rel="noopener">man logrotate</a></p>
<hr>
<h2 id="logrotate-简介"><a href="#logrotate-简介" class="headerlink" title="logrotate 简介"></a>logrotate 简介</h2><blockquote>
<p>logrotate ‐ rotates, compresses, and mails system logs</p>
</blockquote>
<p>logrotate is designed to ease administration of systems that generate large numbers of log files. It allows automatic rotation, compression, removal, and mailing of log files. Each log file may be handled daily, weekly, monthly, or when it grows too large.</p>
<p>Normally, logrotate is run as a daily cron job. It will not modify a log more than once in one day unless the criterion for that log is based on the log’s size and logrotate is being run more than once each day, or unless the -f or –force option is used.</p>
<p>Any number of config files may be given on the command line. Later config files may override the options given in earlier files, so the order in which the logrotate config files are listed is important. Normally, a single config file which includes any other config files which are needed should be used. See below for more information on how to<br>use the include directive to accomplish this. If a directory is given on the command line, every file in that directory is used as a config file.</p>
<p>If no command line arguments are given, logrotate will print version and copyright information, along with a short usage summary. If any errors occur while rotating logs, logrotate will exit with non-zero status.</p>
<p>logrotate 是一个 linux 系统日志的管理工具。可以对单个日志文件或者某个目录下的文件按时间 / 大小进行切割，压缩操作；指定日志保存数量；还可以在切割之后运行自定义命令。</p>
<p>logrotate 是基于 crontab 运行的，所以这个时间点是由 crontab 控制的，具体可以查询 crontab 的配置文件 /etc/anacrontab。 系统会按照计划的频率运行 logrotate，通常是每天。在大多数的 Linux 发行版本上，计划每天运行的脚本位于  /etc/cron.daily/logrotate。</p>
<p>主流 Linux 发行版上都默认安装有 logrotate 包，如果你的 linux 系统中找不到 logrotate, 可以使用 apt-get 或 yum 命令来安装。</p>
<h2 id="logrotate-运行机制"><a href="#logrotate-运行机制" class="headerlink" title="logrotate 运行机制"></a>logrotate 运行机制</h2><p>logrotate 在很多 Linux 发行版上都是默认安装的。系统会定时运行 logrotate，一般是每天一次。系统是这么实现按天执行的。crontab 会每天定时执行 /etc/cron.daily 目录下的脚本，而这个目录下有个文件叫 logrotate。在 centos 上脚本内容是这样的：</p>
<p>系统自带 cron task：<code>/etc/cron.daily/logrotate</code>，每天运行一次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># cat /etc/cron.daily/logrotate</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf</span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != 0 ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">"ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
<p>可以看到这个脚本主要做的事就是以 <code>/etc/logrotate.conf</code> 为配置文件执行了 logrotate。就是这样实现了每天执行一次 logrotate。</p>
<p>因为我的系统执行 <code>/etc/cron.daily</code> 目录下的脚本不是我想滚动日志的时间，所以我把 <code>/etc/cron.daily/logrotate</code> 拷了出来，改了一下 logrotate 配置文件的路径，然后在 crontab 里加上一条指定时间执行这个脚本的记录，自定义周期滚动日志就大功告成了。这种自定义的方式有两点要注意：</p>
<ol>
<li>配置文件里一定要配置 <code>rotate 文件数目</code> 这个参数。如果不配置默认是 0 个，也就是只允许存在一份日志，刚切分出来的日志会马上被删除。多么痛的领悟，说多了都是泪。</li>
<li>执行 logrotate 命令最好加 <code>-f</code> 参数，不然有时候配置文件修改的内容不生效。</li>
</ol>
<p>很多程序的会用到 logrotate 滚动日志，比如 nginx。它们安装后，会在 <code>/etc/logrotate.d</code> 这个目录下增加自己的 logrotate 的配置文件。logrotate 什么时候执行 <code>/etc/logrotate.d</code> 下的配置呢？看到 <code>/etc/logrotate.conf</code> 里这行，一切就不言而喻了。</p>
<pre><code>include /etc/logrotate.d
</code></pre><h2 id="logrotate-原理"><a href="#logrotate-原理" class="headerlink" title="logrotate 原理"></a>logrotate 原理</h2><p>logrotate 是怎么做到滚动日志时不影响程序正常的日志输出呢？logrotate 提供了两种解决方案。</p>
<ol>
<li>create</li>
<li>copytruncate</li>
</ol>
<h3 id="Linux-文件操作机制"><a href="#Linux-文件操作机制" class="headerlink" title="Linux 文件操作机制"></a>Linux 文件操作机制</h3><p>介绍一下相关的 Linux 下的文件操作机制。</p>
<p>Linux 文件系统里文件和文件名的关系如下图。</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191106155554.png" alt=""></p>
<p>目录也是文件，文件里存着文件名和对应的 inode 编号。通过这个 inode 编号可以查到文件的元数据和文件内容。文件的元数据有引用计数、操作权限、拥有者 ID、创建时间、最后修改时间等等。文件件名并不在元数据里而是在目录文件中。因此文件改名、移动，都不会修改文件，而是修改目录文件。</p>
<p>借《UNIX 环境高级编程》里的图说一下进程打开文件的机制。</p>
<p><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191106155617.png" alt=""></p>
<p>进程每新打开一个文件，系统会分配一个新的文件描述符给这个文件。文件描述符对应着一个文件表。表里面存着文件的状态信息（<code>O_APPEND</code>/<code>O_CREAT</code>/<code>O_DIRECT</code>…）、当前文件位置和文件的 inode 信息。系统会为每个进程创建独立的文件描述符和文件表，不同进程是不会共用同一个文件表。正因为如此，不同进程可以同时用不同的状态操作同一个文件的不同位置。文件表中存的是 inode 信息而不是文件路径，所以文件路径发生改变不会影响文件操作。</p>
<h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p>这也就是默认的方案，可以通过 create 命令配置文件的权限和属组设置；这个方案的思路是重命名原日志文件，创建新的日志文件。详细步骤如下：</p>
<ol>
<li>重命名正在输出日志文件，因为重命名只修改目录以及文件的名称，而进程操作文件使用的是 inode，所以并不影响原程序继续输出日志。</li>
<li>创建新的日志文件，文件名和原日志文件一样，注意，此时只是文件名称一样，而 inode 编号不同，原程序输出的日志还是往原日志文件输出。</li>
<li>最后通过某些方式通知程序，重新打开日志文件；由于重新打开日志文件会用到文件路径而非 inode 编号，所以打开的是新的日志文件。</li>
</ol>
<p>如上也就是 logrotate 的默认操作方式，也就是 mv+create 执行完之后，通知应用重新在新文件写入即可。mv+create 成本都比较低，几乎是原子操作，如果应用支持重新打开日志文件，如 syslog, nginx, mysql 等，那么这是最好的方式。</p>
<p>不过，有些程序并不支持这种方式，压根没有提供重新打开日志的接口；而如果重启应用程序，必然会降低可用性，为此引入了如下方式。</p>
<h3 id="copytruncate"><a href="#copytruncate" class="headerlink" title="copytruncate"></a>copytruncate</h3><p>该方案是把正在输出的日志拷 (copy) 一份出来，再清空 (trucate) 原来的日志；详细步骤如下：</p>
<ol>
<li>将当前正在输出的日志文件复制为目标文件，此时程序仍然将日志输出到原来文件中，此时，原文件名也没有变。</li>
<li>清空日志文件，原程序仍然还是输出到预案日志文件中，因为清空文件只把文件的内容删除了，而 inode 并没改变，后续日志的输出仍然写入该文件中。</li>
</ol>
<p>如上所述，对于 copytruncate 也就是先复制一份文件，然后清空原有文件。</p>
<p>通常来说，清空操作比较快，但是如果日志文件太大，那么复制就会比较耗时，从而可能导致部分日志丢失。不过这种方式不需要应用程序的支持即可。</p>
<h2 id="配置-logrotate"><a href="#配置-logrotate" class="headerlink" title="配置 logrotate"></a>配置 logrotate</h2><p>执行文件： <code>/usr/sbin/logrotate</code><br>主配置文件: <code>/etc/logrotate.conf</code><br>自定义配置文件: <code>/etc/logrotate.d/*.conf</code></p>
<p>修改配置文件后，并不需要重启服务。<br>由于 logrotate 实际上只是一个可执行文件，不是以 daemon 运行。</p>
<p><code>/etc/logrotate.conf</code> - 顶层主配置文件，通过 include 指令，会引入 <code>/etc/logrotate.d</code> 下的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 wangao]<span class="comment"># cat /etc/logrotate.conf</span></span><br><span class="line"><span class="comment"># see "man logrotate" for details</span></span><br><span class="line"><span class="comment"># rotate log files weekly</span></span><br><span class="line">weekly</span><br><span class="line"></span><br><span class="line"><span class="comment"># keep 4 weeks worth of backlogs</span></span><br><span class="line">rotate 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># create new (empty) log files after rotating old ones</span></span><br><span class="line">create</span><br><span class="line"></span><br><span class="line"><span class="comment"># use date as a suffix of the rotated file</span></span><br><span class="line">dateext</span><br><span class="line"></span><br><span class="line"><span class="comment"># uncomment this if you want your log files compressed</span></span><br><span class="line"><span class="comment">#compress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RPM packages drop log rotation information into this directory</span></span><br><span class="line">include /etc/logrotate.d</span><br><span class="line"></span><br><span class="line"><span class="comment"># no packages own wtmp and btmp -- we'll rotate them here</span></span><br><span class="line">/var/<span class="built_in">log</span>/wtmp &#123;</span><br><span class="line">    monthly</span><br><span class="line">    create 0664 root utmp</span><br><span class="line">	minsize 1M</span><br><span class="line">    rotate 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/var/<span class="built_in">log</span>/btmp &#123;</span><br><span class="line">    missingok</span><br><span class="line">    monthly</span><br><span class="line">    create 0600 root utmp</span><br><span class="line">    rotate 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># system-specific logs may be also be configured here.</span></span><br></pre></td></tr></table></figure>
<p><code>/etc/logrotate.d/</code> 通常一些第三方软件包，会把自己私有的配置文件，也放到这个目录下。 如 yum，zabbix-agent，syslog，nginx 等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># cat yum</span></span><br><span class="line">/var/<span class="built_in">log</span>/yum.log &#123;</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    size 30k</span><br><span class="line">    yearly</span><br><span class="line">    create 0600 root root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="运行-logrotate"><a href="#运行-logrotate" class="headerlink" title="运行 logrotate"></a>运行 logrotate</h2><p>具体 logrotate 命令格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">logrotate [OPTION...] &lt;configfile&gt;</span><br><span class="line">-d, --debug ：debug 模式，测试配置文件是否有错误。</span><br><span class="line">-f, --force ：强制转储文件。</span><br><span class="line">-m, --mail=command ：压缩日志后，发送日志到指定邮箱。</span><br><span class="line">-s, --state=statefile ：使用指定的状态文件。</span><br><span class="line">-v, --verbose ：显示转储过程。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>crontab 定时</p>
</blockquote>
<p>通常惯用的做法是配合 crontab 来定时调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line">*/30 * * * * /usr/sbin/logrotate /etc/logrotate.d/rsyslog &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>手动运行</p>
</blockquote>
<p>debug 模式：指定 <code>[-d|--debug]</code></p>
<pre><code>logrotate -d &lt;configfile&gt;
</code></pre><p>并不会真正进行 rotate 或者 compress 操作，但是会打印出整个执行的流程，和调用的脚本等详细信息。</p>
<p>verbose 模式： 指定 <code>[-v|--verbose]</code></p>
<pre><code>logrotate -v &lt;configfile&gt;
</code></pre><p>会真正执行操作，打印出详细信息（debug 模式，默认是开启 verbose）</p>
<h3 id="logrotate-参数"><a href="#logrotate-参数" class="headerlink" title="logrotate 参数"></a>logrotate 参数</h3><p>详细介绍请自行 <code>man logrotate</code>， 或者 <a href="https://linux.die.net/man/8/logrotate" target="_blank" rel="noopener">在线 man page</a>。</p>
<p>主要介绍下完成常用需求会用到的一些参数。</p>
<p>一个典型的配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/logrotate.d/log_file </span><br><span class="line"></span><br><span class="line">/var/log/log_file &#123;</span><br><span class="line"></span><br><span class="line">    monthly</span><br><span class="line">    rotate 5</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 644 root root</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/killall -HUP rsyslogd</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>monthly: 日志文件将按月轮循。其它可用值为 <code>daily</code>，<code>weekly</code> 或者 <code>yearly</code>。</li>
<li>rotate 5: 一次将存储 5 个归档日志。对于第六个归档，时间最久的归档将被删除。</li>
<li>compress: 在轮循任务完成后，已轮循的归档将使用 gzip 进行压缩。</li>
<li>delaycompress: 总是与 compress 选项一起用，delaycompress 选项指示 logrotate 不要将最近的归档压缩，压缩 将在下一次轮循周期进行。这在你或任何软件仍然需要读取最新归档时很有用。</li>
<li>missingok: 在日志轮循期间，任何错误将被忽略，例如 “文件无法找到” 之类的错误。</li>
<li>notifempty: 如果日志文件为空，轮循不会进行。</li>
<li>create 644 root root: 以指定的权限创建全新的日志文件，同时 logrotate 也会重命名原始日志文件。</li>
<li>postrotate/endscript: 在所有其它指令完成后，postrotate 和 endscript 里面指定的命令将被执行。在这种情况下，rsyslogd 进程将立即再次读取其配置并继续运行。</li>
</ul>
<p>上面的模板是通用的，而配置参数则根据你的需求进行调整，不是所有的参数都是必要的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/var/log/log_file &#123;</span><br><span class="line">    size=50M</span><br><span class="line">    rotate 5</span><br><span class="line">    dateext</span><br><span class="line">    create 644 root root</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/killall -HUP rsyslogd</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的配置文件中，我们只想要轮询一个日志文件，size=50M 指定日志文件大小可以增长到 50MB,dateext 指<br>示让旧日志文件以创建日期命名。</p>
<blockquote>
<p>常见配置参数</p>
</blockquote>
<ul>
<li>daily ：指定转储周期为每天</li>
<li>weekly ：指定转储周期为每周</li>
<li>monthly ：指定转储周期为每月</li>
<li>rotate count ：指定日志文件删除之前转储的次数，0 指没有备份，5 指保留 5 个备份</li>
<li>tabooext [+] list：让 logrotate 不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig, .rpmsave, v, 和～</li>
<li>missingok：在日志轮循期间，任何错误将被忽略，例如 “文件无法找到” 之类的错误。</li>
<li>size size：当日志文件到达指定的大小时才转储，bytes (缺省) 及 KB (sizek) 或 MB (sizem)</li>
<li>compress： 通过 gzip 压缩转储以后的日志</li>
<li>nocompress： 不压缩</li>
<li>copytruncate：用于还在打开中的日志文件，把当前日志备份并截断</li>
<li>nocopytruncate： 备份日志文件但是不截断</li>
<li>create mode owner group ： 转储文件，使用指定的文件模式创建新的日志文件</li>
<li>nocreate： 不建立新的日志文件</li>
<li>delaycompress： 和 compress 一起使用时，转储的日志文件到下一次转储时才压缩</li>
<li>nodelaycompress： 覆盖 delaycompress 选项，转储同时压缩。</li>
<li>errors address ： 专储时的错误信息发送到指定的 Email 地址</li>
<li>ifempty ：即使是空文件也转储，这个是 logrotate 的缺省选项。</li>
<li>notifempty ：如果是空文件的话，不转储</li>
<li>mail address ： 把转储的日志文件发送到指定的 E-mail 地址</li>
<li>nomail ： 转储时不发送日志文件</li>
<li>olddir directory：储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统</li>
<li>noolddir： 转储后的日志文件和当前日志文件放在同一个目录下</li>
<li>prerotate/endscript： 在转储以前需要执行的命令可以放入这个对，这两个关键字必须单独成行</li>
</ul>
<p>更多信息请参考 man logrotate 帮助文档</p>
<h3 id="手动运行-logrotate-演练"><a href="#手动运行-logrotate-演练" class="headerlink" title="手动运行 logrotate 演练"></a>手动运行 logrotate 演练</h3><p>logrotate 可以在任何时候从命令行手动调用。<br>调用 /etc/lograte.d/ 下配置的所有日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# logrotate /etc/logrotate.conf</span><br></pre></td></tr></table></figure>
<p>要为某个特定的配置调用 logrotate：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# logrotate /etc/logrotate.d/log_file</span><br></pre></td></tr></table></figure>
<p>排障过程中的最佳选择是使用 <code>-d</code> 选项以预演方式运行 logrotate。要进行验证，不用实际轮循任何日志文件，<br>可以模拟演练日志轮循并显示其输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># logrotate -d /etc/logrotate.d/log_file</span></span><br><span class="line"></span><br><span class="line">reading config file /etc/logrotate.d/log_file</span><br><span class="line">reading config info <span class="keyword">for</span> /var/<span class="built_in">log</span>/log_file </span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/<span class="built_in">log</span>/log_file  monthly (5 rotations)</span><br><span class="line">empty <span class="built_in">log</span> files are not rotated, old logs are removed</span><br><span class="line">considering <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file</span><br><span class="line">  <span class="built_in">log</span> does not need rotating</span><br><span class="line">not running postrotate script, since no logs were rotated</span><br></pre></td></tr></table></figure>
<p>正如我们从上面的输出结果可以看到的，logrotate 判断该轮循是不必要的。如果文件的时间小于一天，这就会发生了。</p>
<p>强制轮循即使轮循条件没有满足，我们也可以通过使用 <code>-f</code> 选项来强制 logrotate 轮循日志文件，<code>-v</code> 参数提供了详细的输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># logrotate -vf /etc/logrotate.d/log_file </span></span><br><span class="line"></span><br><span class="line">reading config file /etc/logrotate.d/log_file</span><br><span class="line">reading config info <span class="keyword">for</span> /var/<span class="built_in">log</span>/log_file </span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/<span class="built_in">log</span>/log_file  forced from <span class="built_in">command</span> line (5 rotations)</span><br><span class="line">empty <span class="built_in">log</span> files are not rotated, old logs are removed</span><br><span class="line">considering <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file</span><br><span class="line">  <span class="built_in">log</span> needs rotating</span><br><span class="line">rotating <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file, <span class="built_in">log</span>-&gt;rotateCount is 5</span><br><span class="line">dateext suffix <span class="string">'-20180503'</span></span><br><span class="line">glob pattern <span class="string">'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'</span></span><br><span class="line">previous <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.1 does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.5.gz to /var/<span class="built_in">log</span>/log_file.6.gz (rotatecount 5, logstart 1, i 5), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.5.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.4.gz to /var/<span class="built_in">log</span>/log_file.5.gz (rotatecount 5, logstart 1, i 4), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.4.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.3.gz to /var/<span class="built_in">log</span>/log_file.4.gz (rotatecount 5, logstart 1, i 3), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.3.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.2.gz to /var/<span class="built_in">log</span>/log_file.3.gz (rotatecount 5, logstart 1, i 2), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.2.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.1.gz to /var/<span class="built_in">log</span>/log_file.2.gz (rotatecount 5, logstart 1, i 1), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.1.gz does not exist</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file.0.gz to /var/<span class="built_in">log</span>/log_file.1.gz (rotatecount 5, logstart 1, i 0), </span><br><span class="line">old <span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.0.gz does not exist</span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/log_file.6.gz doesn<span class="string">'t exist -- won'</span>t try to dispose of it</span><br><span class="line">fscreate context <span class="built_in">set</span> to unconfined_u:object_r:var_log_t:s0</span><br><span class="line">renaming /var/<span class="built_in">log</span>/log_file to /var/<span class="built_in">log</span>/log_file.1</span><br><span class="line">creating new /var/<span class="built_in">log</span>/log_file mode = 0644 uid = 0 gid = 0</span><br><span class="line">running postrotate script</span><br><span class="line"><span class="built_in">set</span> default create context</span><br></pre></td></tr></table></figure>
<h2 id="logrotate-配置文件实例"><a href="#logrotate-配置文件实例" class="headerlink" title="logrotate 配置文件实例"></a>logrotate 配置文件实例</h2><blockquote>
<p>syslog</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat syslog</span><br><span class="line">/var/log/cron</span><br><span class="line">/var/log/maillog</span><br><span class="line">/var/log/messages</span><br><span class="line">/var/log/secure</span><br><span class="line">/var/log/spooler</span><br><span class="line">&#123;</span><br><span class="line">    missingok</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate</span><br><span class="line">	/bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>zabbix-agent</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat zabbix-agent</span><br><span class="line">/var/log/zabbix/zabbix_agentd.log &#123;</span><br><span class="line">	weekly</span><br><span class="line">	rotate 12</span><br><span class="line">	compress</span><br><span class="line">	delaycompress</span><br><span class="line">	missingok</span><br><span class="line">	notifempty</span><br><span class="line">	create 0664 zabbix zabbix</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>nginx</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat nginx</span><br><span class="line">/var/log/nginx/*.log /var/log/nginx/*/*.log&#123;</span><br><span class="line">	daily</span><br><span class="line">	missingok</span><br><span class="line">	rotate 14</span><br><span class="line">	compress</span><br><span class="line">	delaycompress</span><br><span class="line">	notifempty</span><br><span class="line">	create 640 root adm</span><br><span class="line">	sharedscripts</span><br><span class="line">	postrotate</span><br><span class="line">		[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">	endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>influxdb</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]# cat influxdb</span><br><span class="line">/var/log/influxdb/access.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 7</span><br><span class="line">    missingok</span><br><span class="line">    dateext</span><br><span class="line">    copytruncate</span><br><span class="line">    compress</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关于-USR1-信号解释"><a href="#关于-USR1-信号解释" class="headerlink" title="关于 USR1 信号解释"></a>关于 USR1 信号解释</h2><p>USR1 亦通常被用来告知应用程序重载配置文件；例如，向 Apache HTTP 服务器发送一个 USR1 信号将导致以下步骤的发生：停止接受新的连接，等待当前连接停止，重新载入配置文件，重新打开日志文件，重启服务器，从而实现相对平滑的不关机的更改。</p>
<p>对于 USR1 和 2 都可以用户自定义的，在 POSIX 兼容的平台上，SIGUSR1 和 SIGUSR2 是发送给一个进程的信号，它表示了用户定义的情况。它们的符号常量在头文件 signal.h 中定义。在不同的平台上，信号的编号可能发生变化，因此需要使用符号名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -HUP pid</span><br><span class="line">killall -HUP pName</span><br></pre></td></tr></table></figure>
<p>其中 pid 是进程标识，pName 是进程的名称。</p>
<p>如果想要更改配置而不需停止并重新启动服务，可以使用上面两个命令。在对配置文件作必要的更改后，发出该命令以动态更新服务配置。根据约定，当你发送一个挂起信号 (信号 1 或 HUP) 时，大多数服务器进程 (所有常用的进程) 都会进行复位操作并重新加载它们的配置文件。</p>
<h2 id="logrotate-日志切割轮询"><a href="#logrotate-日志切割轮询" class="headerlink" title="logrotate 日志切割轮询"></a>logrotate 日志切割轮询</h2><p>由于 logrotate 是基于 cron 运行的，所以这个日志轮转的时间是由 cron 控制的，具体可以查询 cron 的配置文件 /etc/anacrontab，过往的老版本的文件为（/etc/crontab）</p>
<p>查看轮转文件：/etc/anacrontab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># cat /etc/anacrontab</span></span><br><span class="line"><span class="comment"># /etc/anacrontab: configuration file for anacron</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See anacron(8) and anacrontab(5) for details.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="comment"># the maximal random delay added to the base delay of the jobs</span></span><br><span class="line">RANDOM_DELAY=45</span><br><span class="line"><span class="comment"># the jobs will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=3-22</span><br><span class="line"></span><br><span class="line"><span class="comment">#period in days   delay in minutes   job-identifier   command</span></span><br><span class="line">1	5	cron.daily		nice run-parts /etc/cron.daily</span><br><span class="line">7	25	cron.weekly		nice run-parts /etc/cron.weekly</span><br><span class="line">@monthly 45	cron.monthly		nice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>
<p>使用 anacrontab 轮转的配置文件，日志切割的生效时间是在凌晨 3 点到 22 点之间，而且随机延迟时间是 45 分钟，但是这样配置无法满足我们在现实中的应用</p>
<p>现在的需求是将切割时间调整到每天的晚上 12 点，即每天切割的日志是前一天的 0-24 点之间的内容，操作如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/anacrontab /etc/anacrontab.bak          // 取消日志自动轮转的设置 </span><br></pre></td></tr></table></figure>
<p>使用 crontab 来作为日志轮转的触发容器来修改 logrotate 默认执行时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@gop-sg-192-168-56-103 logrotate.d]<span class="comment"># vim /etc/crontab</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line"></span><br><span class="line"><span class="comment"># run-parts</span></span><br><span class="line">01 * * * * root run-parts /etc/cron.hourly</span><br><span class="line">59 23 * * * root run-parts /etc/cron.daily</span><br><span class="line">22 4 * * 0 root run-parts /etc/cron.weekly</span><br><span class="line">42 4 1 * * root run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>
<h2 id="logrotate-常见问题"><a href="#logrotate-常见问题" class="headerlink" title="logrotate 常见问题"></a>logrotate 常见问题</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果想了解执行过程可以添加 - v</span></span><br><span class="line">[root@xxx logrotate.d]<span class="comment"># logrotate -v /etc/logrotate.d/influxdb</span></span><br><span class="line">reading config file influxdb</span><br><span class="line">Allocating <span class="built_in">hash</span> table <span class="keyword">for</span> state file, size 15360 B</span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/<span class="built_in">log</span>/influxdb/access.log  after 1 days (7 rotations)</span><br><span class="line">empty <span class="built_in">log</span> files are rotated, old logs are removed</span><br><span class="line">considering <span class="built_in">log</span> /var/<span class="built_in">log</span>/influxdb/access.log</span><br><span class="line">  <span class="built_in">log</span> does not need rotating (<span class="built_in">log</span> has been rotated at 2020-2-25 3:0, that is not day ago yet)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 logrotate 执行状态 </span></span><br><span class="line">[root@xxx]<span class="comment"># cat /var/lib/logrotate/logrotate.status</span></span><br><span class="line">logrotate state -- version 2</span><br><span class="line"><span class="string">"/var/log/yum.log"</span> 2020-1-1-3:35:1</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_nss.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_pam.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_sudo.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/chrony/*.log"</span> 2019-11-6-3:0:0</span><br><span class="line"><span class="string">"/var/log/sssd/sssd.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/spooler"</span> 2020-2-23-3:37:2</span><br><span class="line"><span class="string">"/var/log/influxdb/influxd.log"</span> 2019-4-9-3:0:0</span><br><span class="line"><span class="string">"/var/log/influxdb/access.log"</span> 2020-2-25-3:0:0</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_LDAPGADM.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_LDAPSGDEV.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/btmp"</span> 2020-2-1-3:33:1</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_LDAPOPS.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_LDAPDEV.log"</span> 2019-4-11-3:0:0</span><br><span class="line"><span class="string">"/var/log/monit.log"</span> 2019-11-10-3:0:0</span><br><span class="line"><span class="string">"/var/log/maillog"</span> 2020-2-23-3:37:2</span><br><span class="line"><span class="string">"/var/log/wpa_supplicant.log"</span> 2019-11-6-3:0:0</span><br><span class="line"><span class="string">"/var/log/sssd/sssd_ssh.log"</span> 2019-4-11-3:41:1</span><br><span class="line"><span class="string">"/var/log/secure"</span> 2020-2-23-3:37:2</span><br><span class="line"><span class="string">"/var/log/messages"</span> 2020-2-23-3:37:2</span><br><span class="line"><span class="string">"/var/log/zabbix/zabbix_agentd.log"</span> 2020-2-23-3:37:2</span><br><span class="line"><span class="string">"/var/log/cron"</span> 2020-2-23-3:37:2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 特殊情况下添加 - f 强制执行 </span></span><br><span class="line">[root@xxx logrotate.d]<span class="comment"># logrotate -f -v influxdb</span></span><br><span class="line">reading config file influxdb</span><br><span class="line">Allocating <span class="built_in">hash</span> table <span class="keyword">for</span> state file, size 15360 B</span><br><span class="line"></span><br><span class="line">Handling 1 logs</span><br><span class="line"></span><br><span class="line">rotating pattern: /var/<span class="built_in">log</span>/influxdb/access.log  forced from <span class="built_in">command</span> line (7 rotations)</span><br><span class="line">empty <span class="built_in">log</span> files are rotated, old logs are removed</span><br><span class="line">considering <span class="built_in">log</span> /var/<span class="built_in">log</span>/influxdb/access.log</span><br><span class="line">  <span class="built_in">log</span> needs rotating</span><br><span class="line">rotating <span class="built_in">log</span> /var/<span class="built_in">log</span>/influxdb/access.log, <span class="built_in">log</span>-&gt;rotateCount is 7</span><br><span class="line">dateext suffix <span class="string">'-20200225'</span></span><br><span class="line">glob pattern <span class="string">'-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'</span></span><br><span class="line">glob finding old rotated logs failed</span><br><span class="line">copying /var/<span class="built_in">log</span>/influxdb/access.log to /var/<span class="built_in">log</span>/influxdb/access.log-20200225</span><br><span class="line">truncating /var/<span class="built_in">log</span>/influxdb/access.log</span><br><span class="line">compressing <span class="built_in">log</span> with: /bin/gzip</span><br></pre></td></tr></table></figure>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.digitalocean.com/community/tutorials/how-to-manage-logfiles-with-logrotate-on-ubuntu-16-04" target="_blank" rel="noopener">How To Manage Logfiles with Logrotate on Ubuntu 16.04</a><br><a href="https://www.linode.com/docs/uptime/logs/use-logrotate-to-manage-log-files/" target="_blank" rel="noopener">How to Use logrotate to Manage Log Files</a><br><a href="https://linux.cn/article-4126-1.html" target="_blank" rel="noopener">Linux 日志文件总管 ——logrotate</a><br><a href="http://www.lightxue.com/how-logrotate-works" target="_blank" rel="noopener">logrotate 机制和原理</a><br><a href="https://blog.51cto.com/luweiv998/2354160" target="_blank" rel="noopener">Linux 自带 Logrotate 日志切割工具配置详解</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/学习-Study/">学习 | Study</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://wsgzao.github.io/post/logrotate/" data-title="Linux 日志切割神器 logrotate 原理介绍和配置详解 | HelloDog" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/nohup/" title="Linux 后台运行任务 nohup 结合 &amp; 用法以及如何精准查找进程并 kill 后台任务实践">
  <strong>上一篇：</strong><br/>
  <span>
  Linux 后台运行任务 nohup 结合 &amp; 用法以及如何精准查找进程并 kill 后台任务实践</span>
</a>
</div>


<div class="next">
<a href="/post/zabbix-ha/"  title="基于 Keepalived 搭建 Zabbix Server HA 双机高可用">
 <strong>下一篇：</strong><br/> 
 <span>基于 Keepalived 搭建 Zabbix Server HA 双机高可用
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新历史"><span class="toc-number">2.</span> <span class="toc-text">更新历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-简介"><span class="toc-number">3.</span> <span class="toc-text">logrotate 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-运行机制"><span class="toc-number">4.</span> <span class="toc-text">logrotate 运行机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-原理"><span class="toc-number">5.</span> <span class="toc-text">logrotate 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-文件操作机制"><span class="toc-number">5.1.</span> <span class="toc-text">Linux 文件操作机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create"><span class="toc-number">5.2.</span> <span class="toc-text">create</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copytruncate"><span class="toc-number">5.3.</span> <span class="toc-text">copytruncate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-logrotate"><span class="toc-number">6.</span> <span class="toc-text">配置 logrotate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行-logrotate"><span class="toc-number">7.</span> <span class="toc-text">运行 logrotate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#logrotate-参数"><span class="toc-number">7.1.</span> <span class="toc-text">logrotate 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#手动运行-logrotate-演练"><span class="toc-number">7.2.</span> <span class="toc-text">手动运行 logrotate 演练</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-配置文件实例"><span class="toc-number">8.</span> <span class="toc-text">logrotate 配置文件实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于-USR1-信号解释"><span class="toc-number">9.</span> <span class="toc-text">关于 USR1 信号解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-日志切割轮询"><span class="toc-number">10.</span> <span class="toc-text">logrotate 日志切割轮询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logrotate-常见问题"><span class="toc-number">11.</span> <span class="toc-text">logrotate 常见问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">12.</span> <span class="toc-text">参考文章</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="wsgzao" data-theme="medium"></div>
<script type="text/javascript" src="//lab.lepture.com/github-cards/widget.js" ></script>
</div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/学习-Study/" title="学习 | Study">学习 | Study<sup>180</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活-Life/" title="生活 | Life">生活 | Life<sup>16</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件-Soft/" title="软件 | Soft">软件 | Soft<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.linkedin.com/in/aowang" target="_blank" title="LinkedIn">LinkedIn</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello, I&#39;m OX. This is my blog on GitHub. <br/>
			Keep Calm and Carry On.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/wsgzao" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.linkedin.com/in/aowang" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="wsgzao">wsgzao</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'wsgzao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-77732745-1', 'wsgzao.github.io');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c2c5fc7d844d0973d9f77abd87f49c3c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- swiftype Begin -->

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','_4qDmKrBPn9Es3UvQHT4','2.0.0');
</script>

<!-- swiftype End -->

  </body>
</html>
